u<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>PROPART DIAGNOSTIC V40</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#06101C;--bg2:#0A1828;--card:#0D1F38;--card2:#0F2544;
  --stripe:#091520;--blue:#1E8CE0;--blue2:#0A5FA0;
  --green:#00C48C;--red:#FF4B5C;--gold:#F5A623;--purple:#9B59B6;
  --cyan:#00D4E8;--white:#F0F6FF;--lgray:#8AA0BC;--gray:#4A5E78;
  --border:#1A3560;--field:#050E1C;--r:12px;
  --orange:#FF7A2F;--teal:#1ABC9C;--pink:#E91E8C;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--white);font-family:'Exo 2',sans-serif;
  display:flex;flex-direction:column;max-width:480px;margin:0 auto;
  box-shadow:0 0 60px rgba(0,0,0,.9);position:relative}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(30,140,224,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(30,140,224,.025) 1px,transparent 1px);background-size:32px 32px}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.app-header{background:linear-gradient(180deg,#050E1A,#08152A);border-bottom:2px solid var(--blue);
  padding:8px 12px;display:flex;align-items:center;gap:8px;flex-shrink:0;position:relative;z-index:10;
  box-shadow:0 4px 24px rgba(30,140,224,.25)}
.logo-sq{width:38px;height:38px;border-radius:9px;flex-shrink:0;
  background:linear-gradient(135deg,var(--blue),#0A5FA0);display:flex;align-items:center;
  justify-content:center;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;
  box-shadow:0 0 16px rgba(30,140,224,.5)}
.header-info{flex:1;min-width:0}
.header-info h1{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;line-height:1}
.header-info p{font-size:8px;color:var(--blue);letter-spacing:1.5px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.hdr-row{display:flex;gap:4px;align-items:center}
.lang-pill{display:flex;background:var(--card);border-radius:5px;border:1px solid var(--border);overflow:hidden}
.lang-btn{padding:3px 8px;background:none;border:none;cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-weight:700;font-size:10px;color:var(--lgray);transition:all .2s}
.lang-btn.active{background:var(--blue);color:#fff}
.hdr-pill{font-size:8px;letter-spacing:.8px;display:flex;align-items:center;gap:3px;cursor:pointer;
  padding:3px 8px;border-radius:5px;background:var(--card);border:1px solid var(--border);
  font-family:'Rajdhani',sans-serif;font-weight:700;transition:all .2s;white-space:nowrap}
.hdr-pill.connected{background:rgba(0,196,140,.12);border-color:var(--green);color:var(--green)}
.hdr-pill.db-ok{background:rgba(0,212,232,.12);border-color:var(--cyan);color:var(--cyan)}
.hdr-pill:active{transform:scale(.94)}
.dot-pulse{display:inline-block;width:5px;height:5px;border-radius:50%;background:currentColor;
  animation:dp 1.4s ease-in-out infinite}
@keyframes dp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.6)}}

/* ‚îÄ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ‚îÄ */
.page{flex:1;overflow-y:auto;overflow-x:hidden;position:relative;z-index:1;scroll-behavior:smooth}
.page::-webkit-scrollbar{width:3px}
.page::-webkit-scrollbar-thumb{background:var(--blue2);border-radius:2px}
.screen{display:none;padding:12px 11px 88px;min-height:100%}
.screen.active{display:block;animation:fadein .28s ease}
@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bottom-nav{flex-shrink:0;background:var(--bg2);border-top:1px solid var(--border);
  display:flex;z-index:10;box-shadow:0 -4px 20px rgba(0,0,0,.5)}
.nav-btn{flex:1;background:none;border:none;cursor:pointer;padding:7px 2px 6px;
  display:flex;flex-direction:column;align-items:center;gap:1px;transition:all .2s}
.nav-btn .ni{font-size:17px;line-height:1;transition:filter .2s}
.nav-btn .nl{font-family:'Rajdhani',sans-serif;font-size:7px;font-weight:700;
  letter-spacing:.8px;color:var(--gray);transition:color .2s}
.nav-btn.active .nl{color:var(--blue)}
.nav-btn.active .ni{filter:drop-shadow(0 0 5px var(--blue))}
.nav-badge{position:absolute;top:-2px;right:-2px;background:var(--red);border-radius:8px;
  font-size:7px;font-weight:700;padding:1px 4px;font-family:'Rajdhani',sans-serif;color:#fff}

/* ‚îÄ‚îÄ‚îÄ COMMON COMPONENTS ‚îÄ‚îÄ‚îÄ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:13px;margin-bottom:10px}
.card.b-blue{border-color:rgba(30,140,224,.45)}.card.b-red{border-color:rgba(255,75,92,.35)}
.card.b-gold{border-color:rgba(245,166,35,.35)}.card.b-green{border-color:rgba(0,196,140,.35)}
.card.b-purple{border-color:rgba(155,89,182,.35)}.card.b-cyan{border-color:rgba(0,212,232,.35)}
.card.b-orange{border-color:rgba(255,122,47,.35)}.card.b-teal{border-color:rgba(26,188,156,.35)}
.sec-lbl{font-size:9px;letter-spacing:2px;font-weight:700;margin-bottom:8px;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.sec-hdr{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.back-btn{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:5px 9px;
  color:var(--lgray);font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0}
.back-btn:active{background:var(--card2)}
.sec-hdr h2{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1.5px;flex:1}
.fg{display:flex;flex-direction:column;gap:9px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
.field{display:flex;flex-direction:column;gap:3px}
.field label{font-size:8px;letter-spacing:1.5px;color:var(--lgray);font-weight:600;text-transform:uppercase}
input,select,textarea{background:var(--field);border:1px solid var(--border);border-radius:7px;
  color:var(--white);font-family:'Exo 2',sans-serif;font-size:12px;padding:8px 10px;outline:none;
  width:100%;transition:border-color .2s,box-shadow .2s}
input:focus,select:focus,textarea:focus{border-color:var(--blue);box-shadow:0 0 8px rgba(30,140,224,.2)}
select option{background:#0D1F38}
textarea{resize:vertical;min-height:60px;line-height:1.5}
.btn{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;
  padding:10px 16px;border-radius:8px;border:none;cursor:pointer;transition:all .2s;
  text-transform:uppercase;flex:1}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--blue),#0A60A8);color:#fff;box-shadow:0 4px 12px rgba(30,140,224,.3)}
.btn-ghost{background:transparent;color:var(--lgray);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--blue);color:var(--white)}
.btn-green{background:linear-gradient(135deg,#008F66,#006A4D);color:#fff}
.btn-red{background:linear-gradient(135deg,#C0392B,#96281B);color:#fff}
.btn-gold{background:linear-gradient(135deg,#C8820A,#9A600A);color:#fff}
.btn-row{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap}
.chip-row{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.chip{background:var(--card2);border:1px solid var(--border);border-radius:6px;
  padding:4px 10px;font-size:9px;letter-spacing:.8px;color:var(--lgray)}
.chip strong{color:var(--blue);font-size:10px}
.kpi-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:12px}
.kpi-box{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:10px 8px;text-align:center}
.kpi-val{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;line-height:1}
.kpi-lbl{font-size:7px;color:var(--gray);letter-spacing:.5px;margin-top:3px;text-transform:uppercase}
.system-card{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:11px 13px;margin-bottom:12px}
.sys-title{font-size:8px;letter-spacing:2px;color:var(--lgray);font-weight:600;margin-bottom:7px}
.sys-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:3px}
.sys-lbl{color:var(--lgray);letter-spacing:.3px;font-size:10px}
.sys-val{font-weight:700;font-family:'Rajdhani',sans-serif;font-size:12px}
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.menu-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:18px 10px 14px;cursor:pointer;transition:all .22s;display:flex;flex-direction:column;
  align-items:center;gap:7px;position:relative;overflow:hidden}
.menu-card:active{transform:scale(.95)}
.menu-icon{width:46px;height:46px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px}
.menu-label{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:10px;
  letter-spacing:1.5px;text-align:center;text-transform:uppercase}
.menu-sub{font-size:8px;color:var(--gray);letter-spacing:.3px;text-align:center}
.wm{position:fixed;bottom:0;left:0;right:0;top:0;pointer-events:none;z-index:0;
  display:flex;align-items:center;justify-content:center;overflow:hidden}
.wm-txt{font-family:'Rajdhani',sans-serif;font-size:72px;font-weight:700;
  color:rgba(30,140,224,.018);letter-spacing:8px;white-space:nowrap;
  transform:rotate(-35deg);user-select:none;text-align:center;line-height:1}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;top:65px;left:50%;transform:translateX(-50%) translateY(-8px);
  background:var(--card2);border:1px solid var(--border);border-radius:8px;
  padding:9px 15px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:.5px;z-index:300;opacity:0;transition:all .3s;
  white-space:nowrap;pointer-events:none;max-width:300px}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.t-ok{border-color:var(--green);color:var(--green)}
.toast.t-err{border-color:var(--red);color:var(--red)}
.toast.t-info{border-color:var(--blue);color:var(--blue)}
.toast.t-warn{border-color:var(--gold);color:var(--gold)}

/* ‚îÄ‚îÄ‚îÄ OBD SCREEN ‚îÄ‚îÄ‚îÄ */
.obd-tabs{display:flex;background:var(--field);border-radius:8px;border:1px solid var(--border);
  padding:3px;gap:3px;margin-bottom:12px}
.obd-tab{flex:1;padding:7px 6px;border-radius:6px;font-family:'Rajdhani',sans-serif;
  font-weight:700;font-size:10px;letter-spacing:.8px;text-align:center;cursor:pointer;
  color:var(--gray);transition:all .2s;border:none;background:none}
.obd-tab.active{background:var(--card2);color:var(--blue);border:1px solid rgba(30,140,224,.3);
  box-shadow:0 0 10px rgba(30,140,224,.15)}
.obd-panel{display:none}
.obd-panel.active{display:block}
/* GAUGES */
.obd-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.obd-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 10px}
.obd-header{display:flex;justify-content:space-between;align-items:flex-start}
.obd-unit{font-size:8px;color:var(--lgray);letter-spacing:1px}
.obd-label{font-size:8px;color:var(--gray);letter-spacing:.3px;margin-top:3px}
.obd-val{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;line-height:1;margin:3px 0}
.gauge-bar{height:5px;background:var(--border);border-radius:3px;margin-top:7px;overflow:hidden}
.gauge-fill{height:100%;border-radius:3px;transition:width .4s ease}
.obd-alert{font-size:8px;letter-spacing:.5px;font-family:'Rajdhani',sans-serif;font-weight:700;
  padding:2px 6px;border-radius:4px;margin-top:4px;display:inline-block}

/* LIVE CHARTS */
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:10px 10px 8px;margin-bottom:10px}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.chart-title{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px}
.chart-val{font-family:'Share Tech Mono',monospace;font-size:13px}
.chart-legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:5px}
.legend-item{display:flex;align-items:center;gap:4px;font-size:8px;color:var(--lgray);letter-spacing:.5px}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
canvas.live-chart{width:100%;height:110px;border-radius:6px;display:block}
canvas.live-chart-lg{width:100%;height:150px;border-radius:6px;display:block}

/* DTC */
.dtc-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
.dtc-chip{background:rgba(255,75,92,.12);border:1px solid rgba(255,75,92,.35);border-radius:6px;
  padding:5px 9px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red);
  display:flex;align-items:center;gap:5px;cursor:pointer}
.dtc-chip:active{background:rgba(255,75,92,.2)}
.dtc-chip button{background:none;border:none;cursor:pointer;color:var(--red);font-size:13px;padding:0}
.dtc-add-row{display:flex;gap:7px;margin-bottom:5px}
#dtc-inp{flex:1;background:var(--field);border:1px solid var(--border);border-radius:7px;
  padding:8px 10px;color:var(--white);font-family:'Share Tech Mono',monospace;
  font-size:12px;text-transform:uppercase;outline:none}
#dtc-inp:focus{border-color:var(--red)}

/* APP TOOLS */
.app-tool-card{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:13px;margin-bottom:10px;cursor:pointer;transition:all .22s}
.app-tool-card:active{transform:scale(.98)}
.app-tool-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.app-tool-icon{width:44px;height:44px;border-radius:11px;display:flex;align-items:center;
  justify-content:center;font-size:22px;flex-shrink:0}
.app-tool-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:.5px}
.app-tool-sub{font-size:9px;color:var(--lgray);letter-spacing:.3px;margin-top:2px}
.step-list{display:flex;flex-direction:column;gap:6px}
.step-item{display:flex;align-items:flex-start;gap:9px;background:var(--stripe);
  border-radius:8px;padding:9px 11px;border:1px solid var(--border)}
.step-num{width:22px;height:22px;border-radius:50%;background:rgba(30,140,224,.2);
  border:1.5px solid rgba(30,140,224,.4);display:flex;align-items:center;justify-content:center;
  font-family:'Rajdhani',sans-serif;font-weight:700;font-size:11px;color:var(--blue);flex-shrink:0}
.step-num.done{background:rgba(0,196,140,.2);border-color:var(--green);color:var(--green)}
.step-num.wait{background:rgba(245,166,35,.15);border-color:var(--gold);color:var(--gold);
  animation:dp 1.2s ease-in-out infinite}
.step-txt{font-size:11px;color:var(--lgray);flex:1;line-height:1.5}
.step-txt strong{color:var(--white);display:block;font-size:11px;margin-bottom:2px}
.progress-ring{display:flex;flex-direction:column;align-items:center;padding:16px;margin-bottom:12px}
.ring-outer{position:relative;width:120px;height:120px}
.ring-svg{width:120px;height:120px;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:var(--border);stroke-width:8}
.ring-fill{fill:none;stroke-width:8;stroke-linecap:round;
  stroke-dasharray:314;stroke-dashoffset:314;transition:stroke-dashoffset .5s ease}
.ring-center{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center}
.ring-pct{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700}
.ring-label{font-size:8px;color:var(--lgray);letter-spacing:1px;margin-top:2px}
/* Calibration slider */
.cal-slider{width:100%;-webkit-appearance:none;height:6px;border-radius:3px;
  background:var(--border);outline:none;margin:10px 0}
.cal-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;
  border-radius:50%;background:var(--blue);cursor:pointer;border:2px solid var(--blue2);
  box-shadow:0 0 10px rgba(30,140,224,.5)}
.cal-val-display{font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;
  text-align:center;color:var(--blue);margin:8px 0;letter-spacing:2px}
.cal-limits{display:flex;justify-content:space-between;font-size:9px;color:var(--gray);letter-spacing:.5px}
/* Inmo */
.inmo-card{background:rgba(155,89,182,.08);border:1px solid rgba(155,89,182,.3);
  border-radius:10px;padding:13px;margin-bottom:10px}
.inmo-key-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
.key-chip{background:var(--card2);border:1px solid var(--border);border-radius:9px;
  padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s}
.key-chip:active{transform:scale(.95)}
.key-chip.prog{border-color:var(--gold);background:rgba(245,166,35,.1)}
.key-chip.ok{border-color:var(--green);background:rgba(0,196,140,.1)}
.key-chip .key-ico{font-size:20px;margin-bottom:4px}
.key-chip .key-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:.5px}
.key-chip .key-status{font-size:7px;color:var(--gray);margin-top:2px;letter-spacing:.3px}
/* Checklist */
.chk-item{display:flex;align-items:center;gap:9px;background:var(--stripe);border-radius:7px;
  padding:8px 11px;border:1px solid var(--border);cursor:pointer;margin-bottom:5px;transition:all .2s}
.chk-ico{width:20px;height:20px;border-radius:5px;border:2px solid var(--gray);
  display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;transition:all .2s}
.chk-item.done .chk-ico{background:var(--green);border-color:var(--green);color:#fff}
.chk-txt{font-size:10px;color:var(--lgray);flex:1}
.chk-grp{font-size:8px;letter-spacing:1.5px;color:var(--blue);font-weight:700;margin:9px 0 5px;text-transform:uppercase}
.st-row{display:flex;gap:5px}
.st-pill{border-radius:7px;padding:6px 10px;font-family:'Rajdhani',sans-serif;font-weight:700;
  font-size:10px;letter-spacing:.8px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.st-pill[data-v=ok]{background:rgba(0,196,140,.08);color:var(--green);border-color:rgba(0,196,140,.2)}
.st-pill[data-v=warn]{background:rgba(245,166,35,.08);color:var(--gold);border-color:rgba(245,166,35,.2)}
.st-pill[data-v=fail]{background:rgba(255,75,92,.08);color:var(--red);border-color:rgba(255,75,92,.2)}
.st-pill.sel[data-v=ok]{border-color:var(--green);background:rgba(0,196,140,.18)}
.st-pill.sel[data-v=warn]{border-color:var(--gold);background:rgba(245,166,35,.18)}
.st-pill.sel[data-v=fail]{border-color:var(--red);background:rgba(255,75,92,.18)}
/* Search */
.search-box{background:var(--field);border:1px solid var(--border);border-radius:8px;
  padding:8px 11px;display:flex;align-items:center;gap:7px;margin-bottom:10px}
.search-box input{background:none;border:none;box-shadow:none;padding:0;font-size:11px}
.filter-row{display:flex;gap:5px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px}
.filter-row::-webkit-scrollbar{display:none}
.filter-tag{background:var(--card);border:1px solid var(--border);border-radius:7px;
  padding:4px 11px;font-size:8px;letter-spacing:1px;color:var(--lgray);cursor:pointer;
  white-space:nowrap;font-family:'Rajdhani',sans-serif;font-weight:700;transition:all .2s}
.filter-tag.sel{background:rgba(30,140,224,.15);border-color:var(--blue);color:var(--blue)}
/* Historial */
.hist-item{background:var(--card);border:1px solid var(--border);border-radius:9px;
  padding:11px 13px;margin-bottom:7px;cursor:pointer;transition:all .2s}
.hist-item:active{transform:scale(.98)}
.hist-folio{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--gold)}
.hist-date{font-size:8px;color:var(--gray)}
.hist-vehicle{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;margin:3px 0 1px}
.hist-owner{font-size:10px;color:var(--lgray)}
.hist-footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
.hist-st{font-size:8px;font-weight:700;letter-spacing:1px;padding:3px 8px;border-radius:5px;font-family:'Rajdhani',sans-serif}
.hist-st.e{background:rgba(0,196,140,.15);color:var(--green)}
.hist-st.p{background:rgba(245,166,35,.15);color:var(--gold)}
.hist-st.n{background:rgba(255,75,92,.15);color:var(--red)}
.hist-cost{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;color:var(--green)}
/* Veh√≠culos */
.veh-item{background:var(--card);border:1px solid var(--border);border-radius:9px;
  padding:11px 13px;margin-bottom:7px;cursor:pointer;transition:all .2s}
.veh-item:active{transform:scale(.98)}
.veh-header{display:flex;align-items:center;gap:10px}
.veh-icon{width:38px;height:38px;border-radius:9px;background:rgba(0,212,232,.1);
  display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
.veh-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700}
.veh-plates{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--gold)}
.veh-owner{font-size:9px;color:var(--lgray)}
.veh-stats{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}
.veh-stat{background:var(--field);border-radius:5px;padding:3px 8px;font-size:8px;color:var(--lgray)}
.veh-stat strong{color:var(--white)}
/* DB Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:200;display:none;
  align-items:flex-end;max-width:480px;margin:0 auto}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--bg2);border-top:2px solid var(--blue);border-radius:18px 18px 0 0;
  padding:18px 14px 30px;width:100%;max-height:88vh;overflow-y:auto;animation:slide-up .3s ease}
@keyframes slide-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;display:block}
.modal-title{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:15px;letter-spacing:2px;
  display:flex;align-items:center;gap:7px;margin-bottom:3px;color:var(--cyan)}
.modal-sub{font-size:8px;color:var(--gray);letter-spacing:1px;margin-bottom:16px}
.db-module-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:12px}
.db-mod-chip{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:8px 10px;display:flex;align-items:center;gap:6px;cursor:pointer;transition:all .2s}
.db-mod-chip.on{border-color:var(--teal);background:rgba(26,188,156,.08)}
.db-mod-chip .mc-ico{font-size:15px}
.db-mod-chip .mc-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;flex:1;letter-spacing:.3px}
.db-mod-chip .mc-dot{width:12px;height:12px;border-radius:50%;border:2px solid var(--gray);flex-shrink:0;transition:all .2s}
.db-mod-chip.on .mc-dot{background:var(--teal);border-color:var(--teal)}
.db-status-bar{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:10px 13px;display:flex;align-items:center;gap:9px;margin-bottom:12px}
.db-ind{width:10px;height:10px;border-radius:50%;background:var(--gray);flex-shrink:0}
.db-ind.online{background:var(--green);box-shadow:0 0 7px var(--green)}
.db-ind.syncing{background:var(--gold);animation:dp 1s ease-in-out infinite}
.sync-log{background:var(--field);border:1px solid var(--border);border-radius:7px;
  padding:9px;max-height:90px;overflow-y:auto;margin-bottom:12px;
  font-family:'Share Tech Mono',monospace;font-size:8px;line-height:1.8}
.ll{display:block}.ll.ok{color:var(--green)}.ll.err{color:var(--red)}
.ll.info{color:var(--blue)}.ll.warn{color:var(--gold)}
/* Enciclopedia */
.enc-item{background:var(--card);border:1px solid var(--border);border-radius:9px;
  padding:11px 13px;margin-bottom:7px;cursor:pointer;transition:all .2s}
.enc-item:active{transform:scale(.98)}
.enc-header{display:flex;align-items:center;gap:9px;margin-bottom:5px}
.enc-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-size:17px;flex-shrink:0}
.enc-title{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;flex:1;line-height:1.3}
.enc-tags{display:flex;gap:4px;flex-wrap:wrap}
.enc-tag{background:var(--field);border-radius:4px;padding:2px 7px;font-size:7px;
  letter-spacing:.5px;color:var(--gray)}
/* Pinout table */
.pinout-table{width:100%;border-collapse:collapse;font-size:9px;margin-top:6px}
.pinout-table th{text-align:left;color:var(--gray);letter-spacing:1px;padding:4px 6px;
  font-size:8px;border-bottom:1px solid var(--border);background:var(--field)}
.pinout-table td{padding:5px 6px;border-bottom:1px solid rgba(26,53,96,.35);color:var(--lgray)}
.pinout-table td:first-child{color:var(--gold);font-family:'Share Tech Mono',monospace}
.pinout-table td.cable-color{font-weight:700}
.pin-voltage{font-family:'Share Tech Mono',monospace;color:var(--green);font-size:9px}
/* values table */
.val-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:7px}
.val-table th{background:var(--field);color:var(--lgray);padding:5px 8px;font-size:8px;
  letter-spacing:1px;text-align:center;border:1px solid var(--border)}
.val-table td{padding:5px 8px;text-align:center;border:1px solid rgba(26,53,96,.3);
  font-family:'Share Tech Mono',monospace;font-size:9px}
.val-table tr:nth-child(even) td{background:rgba(9,21,32,.5)}
/* Signature canvas */
canvas.sig-canvas{background:rgba(255,255,255,.03);border:1px dashed var(--border);
  border-radius:8px;width:100%;height:75px;display:block;touch-action:none;cursor:crosshair}
/* Cost box */
.cost-box{background:var(--card2);border:1px solid var(--border);border-radius:9px;
  padding:11px 13px;display:flex;align-items:center;justify-content:space-between;margin-top:9px}
.cost-val{display:flex;align-items:center;gap:5px}
.cost-val input{background:none;border:none;color:var(--green);font-family:'Rajdhani',sans-serif;
  font-size:22px;font-weight:700;width:110px;text-align:right;padding:0;box-shadow:none}
/* Form progress */
.form-prog{background:var(--field);border-radius:3px;height:3px;margin-bottom:12px;overflow:hidden}
.form-prog-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--cyan));transition:width .4s}
/* Folio banner */
.folio-banner{background:linear-gradient(90deg,rgba(30,140,224,.08),rgba(30,140,224,.04));
  border:1px solid rgba(30,140,224,.25);border-radius:9px;padding:9px 13px;
  margin-bottom:13px;display:flex;align-items:center;justify-content:space-between}
.folio-num{font-family:'Share Tech Mono',monospace;font-size:15px;color:var(--gold)}
.folio-meta{text-align:right;font-size:8px;color:var(--gray);line-height:1.8}
/* Rating */
.rating-row{display:flex;gap:6px;margin-top:6px}
.rstar{font-size:24px;cursor:pointer;opacity:.25;transition:all .15s}
.rstar.lit{opacity:1}
/* Status pills row */
.status-flow{display:flex;align-items:flex-start;gap:3px;margin-top:10px}
.sf-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.sf-bar{width:100%;height:4px;border-radius:2px;background:var(--border)}
.sf-bar.done{background:var(--green)}.sf-bar.active{background:var(--gold)}
.sf-lbl{font-size:7px;color:var(--gray);letter-spacing:.3px;text-align:center}
/* Adm */
.adm-row{display:flex;align-items:center;justify-content:space-between;background:var(--card);
  border:1px solid var(--border);border-radius:9px;padding:11px 13px;margin-bottom:5px;
  cursor:pointer;transition:all .2s}
.adm-row:active{transform:scale(.98)}
.adm-left{display:flex;align-items:center;gap:9px}
.adm-ico{font-size:18px;line-height:1}
.adm-lbl{font-family:'Rajdhani',sans-serif;font-weight:600;font-size:12px;letter-spacing:.3px}
.adm-sub{font-size:9px;color:var(--gray)}
.adm-val{font-size:11px;color:var(--lgray)}
.toggle-sw{width:34px;height:19px;border-radius:10px;background:var(--border);
  position:relative;cursor:pointer;flex-shrink:0;transition:all .3s}
.toggle-sw.on{background:var(--blue)}
.toggle-sw::after{content:'';position:absolute;top:3px;left:3px;width:13px;height:13px;
  border-radius:50%;background:#fff;transition:all .3s}
.toggle-sw.on::after{left:18px}
</style>
</head>
<body>

<div class="wm"><div class="wm-txt">PROPART<br>DIAGNOSTIC</div></div>
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DB MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="db-modal">
<div class="modal-sheet">
  <span class="modal-handle"></span>
  <div class="modal-title">üóÑ BASE DE DATOS EXTERNA</div>
  <div class="modal-sub">SINCRONIZACI√ìN BIDIRECCIONAL ¬∑ LECTURA + ESCRITURA EN TIEMPO REAL</div>

  <div class="db-status-bar">
    <div class="db-ind" id="db-ind"></div>
    <div style="flex:1">
      <div style="font-family:'Rajdhani',sans-serif;font-weight:700;font-size:12px;letter-spacing:.5px" id="db-st-txt">SIN CONFIGURAR</div>
      <div style="font-size:8px;color:var(--gray)" id="db-st-sub">Configure URL y API Key para conectar</div>
    </div>
    <div style="font-size:8px;color:var(--gray)" id="db-st-time">‚Äî</div>
  </div>

  <div class="sync-log" id="sync-log">
    <span class="ll info">‚Ä∫ Sistema PROPART V40 listo ‚Äî configure su base de datos.</span>
  </div>

  <!-- Config -->
  <div style="font-size:8px;letter-spacing:2px;color:var(--lgray);font-weight:700;margin:12px 0 8px">‚öô CONFIGURACI√ìN</div>
  <div class="fg">
    <div class="field"><label>TIPO DE BASE DE DATOS</label>
      <select id="db-type">
        <option value="rest">REST API (JSON)</option>
        <option value="supabase">Supabase</option>
        <option value="firebase">Firebase / Firestore</option>
        <option value="pocketbase">PocketBase</option>
        <option value="mysql">MySQL via API Gateway</option>
        <option value="custom">Endpoint personalizado</option>
      </select>
    </div>
    <div class="field"><label>URL / ENDPOINT BASE</label>
      <input type="url" id="db-url" placeholder="https://tu-api.com/propart" autocapitalize="none"/>
    </div>
    <div class="row2">
      <div class="field"><label>API KEY / TOKEN</label>
        <input type="password" id="db-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      </div>
      <div class="field"><label>DB ID / PROYECTO</label>
        <input type="text" id="db-proj" placeholder="propart-prod"/>
      </div>
    </div>
    <div class="field"><label>INTERVALO SYNC AUTOM√ÅTICO</label>
      <select id="db-interval">
        <option value="0">Manual solamente</option>
        <option value="60">Cada 1 minuto</option>
        <option value="300" selected>Cada 5 minutos</option>
        <option value="900">Cada 15 minutos</option>
      </select>
    </div>
  </div>

  <!-- M√≥dulos -->
  <div style="font-size:8px;letter-spacing:2px;color:var(--lgray);font-weight:700;margin:14px 0 8px">üì¶ M√ìDULOS SINCRONIZADOS</div>
  <div class="db-module-grid">
    <div class="db-mod-chip on" data-mod="reportes"><span class="mc-ico">üìã</span><div><div class="mc-lbl">REPORTES</div><div style="font-size:7px;color:var(--gray)">tabla: reports</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="vehiculos"><span class="mc-ico">üöó</span><div><div class="mc-lbl">VEH√çCULOS</div><div style="font-size:7px;color:var(--gray)">tabla: vehicles</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="clientes"><span class="mc-ico">üë§</span><div><div class="mc-lbl">CLIENTES</div><div style="font-size:7px;color:var(--gray)">tabla: clients</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="diagramas"><span class="mc-ico">üìê</span><div><div class="mc-lbl">DIAGRAMAS</div><div style="font-size:7px;color:var(--gray)">tabla: diagrams</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="dtc"><span class="mc-ico">‚ùå</span><div><div class="mc-lbl">C√ìDIGOS DTC</div><div style="font-size:7px;color:var(--gray)">tabla: dtc_codes</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="pinouts"><span class="mc-ico">üîå</span><div><div class="mc-lbl">PINOUTS ECU</div><div style="font-size:7px;color:var(--gray)">tabla: ecu_pinouts</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip on" data-mod="enc"><span class="mc-ico">üìö</span><div><div class="mc-lbl">ENCICLOPEDIA</div><div style="font-size:7px;color:var(--gray)">tabla: encyclopedia</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip" data-mod="obd"><span class="mc-ico">üìä</span><div><div class="mc-lbl">DATOS OBD2</div><div style="font-size:7px;color:var(--gray)">tabla: obd_sessions</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip" data-mod="cal"><span class="mc-ico">‚öô</span><div><div class="mc-lbl">CALIBRACIONES</div><div style="font-size:7px;color:var(--gray)">tabla: calibrations</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip" data-mod="inmo"><span class="mc-ico">üîê</span><div><div class="mc-lbl">INMOVILIZADOR</div><div style="font-size:7px;color:var(--gray)">tabla: immobilizer</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip" data-mod="fotos"><span class="mc-ico">üì∑</span><div><div class="mc-lbl">FOTOS</div><div style="font-size:7px;color:var(--gray)">tabla: media</div></div><div class="mc-dot"></div></div>
    <div class="db-mod-chip" data-mod="stats"><span class="mc-ico">üìà</span><div><div class="mc-lbl">ESTAD√çSTICAS</div><div style="font-size:7px;color:var(--gray)">tabla: stats</div></div><div class="mc-dot"></div></div>
  </div>

  <!-- Schema -->
  <div style="font-size:8px;letter-spacing:2px;color:var(--lgray);font-weight:700;margin:12px 0 8px">üìã ESQUEMA JSON ESPERADO</div>
  <div class="sync-log" style="max-height:120px;font-size:7.5px;line-height:1.9">
    <span class="ll info">// reports: { folio, client_name, phone, email, vehicle_brand, vehicle_model,</span>
    <span class="ll ok">  year, plates, color, km, engine, vin, complaint, observation, dtc_codes[],</span>
    <span class="ll ok">  work_done, parts[], labor_hrs, warranty, total_cost, currency, rating, status }</span>
    <span class="ll info">// vehicles: { id, plates, brand, model, year, engine, vin, client_id, km_history[] }</span>
    <span class="ll info">// diagrams: { id, brand, model, system, file_url, pins, description, img_url }</span>
    <span class="ll info">// ecu_pinouts: { ecu_id, brand, model, pins[], colors, voltages }</span>
    <span class="ll info">// dtc_codes: { code, desc_es, desc_en, system, causes[], solutions[] }</span>
    <span class="ll info">// calibrations: { id, vehicle, type, steps[], values, result, date }</span>
    <span class="ll info">// immobilizer: { id, vehicle, ecu_type, key_slots, programmed[], date }</span>
    <span class="ll info">// obd_sessions: { id, vehicle, rpm[], temp[], spd[], dtc_live[], timestamp }</span>
  </div>

  <div class="btn-row" style="margin-top:12px">
    <button class="btn btn-ghost" id="db-test-btn">üîç PROBAR</button>
    <button class="btn btn-primary" id="db-connect-btn">üîó CONECTAR</button>
  </div>
  <div class="btn-row" style="margin-top:6px">
    <button class="btn btn-ghost" id="db-pull-btn" style="font-size:10px;padding:8px">‚¨á PULL DATOS</button>
    <button class="btn btn-ghost" id="db-push-btn" style="font-size:10px;padding:8px">‚¨Ü PUSH LOCAL</button>
    <button class="btn btn-ghost" id="db-close-btn" style="font-size:10px;padding:8px;color:var(--red)">‚úï CERRAR</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="app-header">
  <div class="logo-sq">PP</div>
  <div class="header-info">
    <h1>PROPART SYSTEM</h1>
    <p>TALLER FERNANDO MILL√ÅN ¬∑ 777 683 8196</p>
  </div>
  <div class="header-right">
    <div class="hdr-row">
      <div class="lang-pill">
        <button class="lang-btn active" id="btn-es">üá≤üáΩ</button>
        <button class="lang-btn" id="btn-en">üá∫üá∏</button>
      </div>
      <button class="hdr-pill" id="db-open-btn">üóÑ <span id="db-pill-lbl">DB</span></button>
    </div>
    <div class="hdr-row">
      <button class="hdr-pill" id="bt-btn">
        <span class="dot-pulse" style="display:none" id="bt-dot"></span>
        <span id="bt-txt">‚óè ELM327</span>
      </button>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page">

<!-- ‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="scr-home">
  <div class="system-card">
    <div class="sys-title">ESTADO DEL SISTEMA ¬∑ PROPART V40</div>
    <div class="sys-row"><span class="sys-lbl">LICENCIA</span><span class="sys-val" style="color:var(--green)">‚úì ACTIVA</span></div>
    <div class="sys-row"><span class="sys-lbl">PROPIETARIO</span><span class="sys-val">FERNANDO MILL√ÅN</span></div>
    <div class="sys-row"><span class="sys-lbl">BASE DE DATOS</span><span class="sys-val" id="h-db-st" style="color:var(--gray)">SIN CONECTAR</span></div>
    <div class="sys-row"><span class="sys-lbl">BLUETOOTH OBD2</span><span class="sys-val" id="h-bt-st" style="color:var(--gray)">DESCONECTADO</span></div>
    <div class="sys-row"><span class="sys-lbl">DIAGRAMAS DB</span><span class="sys-val" style="color:var(--purple)">5,247 ARCHIVOS</span></div>
    <div class="sys-row"><span class="sys-lbl">FOLIO ACTIVO</span><span class="sys-val" style="color:var(--gold);font-family:'Share Tech Mono',monospace" id="h-folio">PP-2024-0001</span></div>
  </div>

  <div class="kpi-row">
    <div class="kpi-box"><div class="kpi-val" style="color:var(--blue)" id="k-total">0</div><div class="kpi-lbl">Reportes<br>Total</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--green)" id="k-entregados">0</div><div class="kpi-lbl">Entre-<br>gados</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--gold)" id="k-proceso">0</div><div class="kpi-lbl">En<br>Proceso</div></div>
  </div>

  <div class="menu-grid">
    <div class="menu-card" id="mn-obd">
      <div class="menu-icon" style="background:rgba(30,140,224,.15)">üîå</div>
      <div class="menu-label" style="color:var(--blue)">SCANNER OBD2</div>
      <div class="menu-sub">Gr√°ficas en vivo</div>
    </div>
    <div class="menu-card" id="mn-report">
      <div class="menu-icon" style="background:rgba(255,75,92,.15)">üìã</div>
      <div class="menu-label" style="color:var(--red)">NUEVO REPORTE</div>
      <div class="menu-sub">Diagn√≥stico completo</div>
    </div>
    <div class="menu-card" id="mn-app1">
      <div class="menu-icon" style="background:rgba(245,166,35,.15)">‚öô</div>
      <div class="menu-label" style="color:var(--gold)">APP 1 ¬∑ CALIBRACI√ìN</div>
      <div class="menu-sub">Cuerpo aceleraci√≥n</div>
    </div>
    <div class="menu-card" id="mn-app2">
      <div class="menu-icon" style="background:rgba(155,89,182,.15)">üîê</div>
      <div class="menu-label" style="color:var(--purple)">APP 2 ¬∑ INMO</div>
      <div class="menu-sub">Inmovilizador & llaves</div>
    </div>
    <div class="menu-card" id="mn-enc">
      <div class="menu-icon" style="background:rgba(0,212,232,.15)">üìê</div>
      <div class="menu-label" style="color:var(--cyan)">DIAGRAMAS DB</div>
      <div class="menu-sub">500+ marcas</div>
    </div>
    <div class="menu-card" id="mn-hist">
      <div class="menu-icon" style="background:rgba(0,180,200,.15)">üóÇ</div>
      <div class="menu-label" style="color:#00B4C8">HISTORIAL</div>
      <div class="menu-sub" id="h-hist-sub">0 registros</div>
    </div>
    <div class="menu-card" id="mn-veh">
      <div class="menu-icon" style="background:rgba(26,188,156,.15)">üöó</div>
      <div class="menu-label" style="color:var(--teal)">VEH√çCULOS</div>
      <div class="menu-sub">Base de clientes</div>
    </div>
    <div class="menu-card" id="mn-adm">
      <div class="menu-icon" style="background:rgba(255,122,47,.15)">üõ†</div>
      <div class="menu-label" style="color:var(--orange)">ADMINISTRAR</div>
      <div class="menu-sub">Config & ajustes</div>
    </div>
  </div>
  <div style="text-align:center;font-size:8px;color:var(--gray);letter-spacing:1px;padding-bottom:6px">
    PROPART DIAGNOSTIC V40 ¬∑ AUTOPARTES MILL√ÅN ¬∑ <span id="h-date"></span>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SCANNER OBD2 ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-obd">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-obd">‚Üê</button>
    <h2 style="color:var(--blue)">üîå SCANNER OBD2</h2>
    <div style="display:flex;gap:5px">
      <button class="hdr-pill" id="obd-connect-btn" style="font-size:9px">‚ö° CONECTAR</button>
    </div>
  </div>

  <div class="obd-tabs">
    <button class="obd-tab active" data-panel="gauges">üéõ GAUGES</button>
    <button class="obd-tab" data-panel="charts">üìà GR√ÅFICAS</button>
    <button class="obd-tab" data-panel="dtc">‚ùå DTC</button>
    <button class="obd-tab" data-panel="freeze">‚ùÑ FREEZE</button>
  </div>

  <!-- PANEL: GAUGES -->
  <div class="obd-panel active" id="panel-gauges">
    <div class="obd-grid">
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">RPM</div><div class="obd-alert" style="background:rgba(30,140,224,.12);color:var(--blue)" id="al-rpm">‚Äî</div></div>
        <div class="obd-val" style="color:var(--blue)" id="g-rpm">‚Äî</div>
        <div class="obd-label">REVOLUCIONES / MIN</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-rpm" style="width:0;background:var(--blue)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">¬∞C</div><div class="obd-alert" style="background:rgba(0,196,140,.12);color:var(--green)" id="al-temp">‚Äî</div></div>
        <div class="obd-val" style="color:var(--green)" id="g-temp">‚Äî</div>
        <div class="obd-label">TEMP. MOTOR ECT</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-temp" style="width:0;background:var(--green)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">km/h</div><div class="obd-alert" id="al-spd" style="background:rgba(245,166,35,.12);color:var(--gold)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--gold)" id="g-spd">‚Äî</div>
        <div class="obd-label">VELOCIDAD VSS</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-spd" style="width:0;background:var(--gold)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">%</div><div class="obd-alert" id="al-load" style="background:rgba(255,75,92,.12);color:var(--red)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--red)" id="g-load">‚Äî</div>
        <div class="obd-label">CARGA MOTOR CALC.</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-load" style="width:0;background:var(--red)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">V</div><div class="obd-alert" id="al-volt" style="background:rgba(0,212,232,.12);color:var(--cyan)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--cyan)" id="g-volt">‚Äî</div>
        <div class="obd-label">VOLTAJE ECM</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-volt" style="width:0;background:var(--cyan)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">%</div><div class="obd-alert" id="al-tps" style="background:rgba(255,122,47,.12);color:var(--orange)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--orange)" id="g-tps">‚Äî</div>
        <div class="obd-label">ACELERADOR TPS</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-tps" style="width:0;background:var(--orange)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">mg/s</div><div class="obd-alert" id="al-maf" style="background:rgba(155,89,182,.12);color:var(--purple)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--purple)" id="g-maf">‚Äî</div>
        <div class="obd-label">FLUJO AIRE MAF</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-maf" style="width:0;background:var(--purple)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">mV</div><div class="obd-alert" id="al-o2" style="background:rgba(26,188,156,.12);color:var(--teal)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--teal)" id="g-o2">‚Äî</div>
        <div class="obd-label">SONDA LAMBDA O2</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-o2" style="width:0;background:var(--teal)"></div></div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="obd-save-btn">üíæ GUARDAR SESI√ìN</button>
      <button class="btn btn-primary" id="obd-to-rep-btn">üìã ‚Üí REPORTE</button>
    </div>
  </div>

  <!-- PANEL: GR√ÅFICAS EN VIVO -->
  <div class="obd-panel" id="panel-charts">
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="chart-title" style="color:var(--blue)">RPM + CARGA MOTOR</div>
        <div class="chart-val" id="cv-rpm-load" style="color:var(--blue)">‚Äî</div>
      </div>
      <canvas id="chart-rpm" width="440" height="150" style="width:100%;height:150px;border-radius:6px;display:block;background:#050E1C"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>RPM √∑ 100</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>CARGA %</div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="chart-title" style="color:var(--green)">TEMPERATURA + MAF</div>
        <div class="chart-val" id="cv-temp-maf" style="color:var(--green)">‚Äî</div>
      </div>
      <canvas id="chart-temp" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#050E1C"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>TEMP ¬∞C</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>MAF mg/s √ó5</div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="chart-title" style="color:var(--gold)">TPS + VOLTAJE</div>
        <div class="chart-val" id="cv-tps-volt" style="color:var(--gold)">‚Äî</div>
      </div>
      <canvas id="chart-tps" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#050E1C"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div>TPS %</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div>VOLT √ó7</div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="chart-title" style="color:var(--teal)">SONDA O2 LAMBDA</div>
        <div class="chart-val" id="cv-o2" style="color:var(--teal)">‚Äî</div>
      </div>
      <canvas id="chart-o2" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#050E1C"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--teal)"></div>O2 mV (0‚Äì1000)</div>
        <div class="legend-item" style="color:var(--gray)">Rango normal: 100‚Äì900 mV oscilando</div>
      </div>
    </div>
    <div style="text-align:center;font-size:9px;color:var(--gray);padding:8px 0;letter-spacing:.5px">
      Actualizaci√≥n cada 500ms ¬∑ Historial √∫ltimas 60 lecturas
    </div>
  </div>

  <!-- PANEL: DTC -->
  <div class="obd-panel" id="panel-dtc">
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">‚ùå C√ìDIGOS ACTIVOS</div>
      <div id="live-dtc-wrap">
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--gray);text-align:center;padding:16px 0">
          Conecte ELM327 para lectura autom√°tica...
        </div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn btn-ghost btn-red" style="font-size:10px" id="obd-clear-dtc">üóë BORRAR C√ìDIGOS</button>
        <button class="btn btn-ghost" style="font-size:10px" id="obd-read-dtc">üîÑ LEER DTC</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <div class="sec-lbl" style="color:var(--blue)">üìö DESCRIPCI√ìN R√ÅPIDA</div>
      <div id="dtc-desc-area" style="font-size:10px;color:var(--lgray);line-height:1.7">
        Toca un c√≥digo DTC para ver su descripci√≥n, causas y diagn√≥stico recomendado.
      </div>
    </div>
  </div>

  <!-- PANEL: FREEZE FRAME -->
  <div class="obd-panel" id="panel-freeze">
    <div class="card b-gold">
      <div class="sec-lbl" style="color:var(--gold)">‚ùÑ DATOS FREEZE FRAME</div>
      <div id="freeze-data" style="font-size:10px;color:var(--gray);line-height:1.8">
        No hay datos freeze frame. Lea c√≥digos DTC primero para capturar los datos del momento de la falla.
      </div>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">üìã DATOS PID COMPLETOS</div>
      <div id="all-pids" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--lgray);line-height:2">
        PID 01: <span id="pid-rpm">‚Äî</span> RPM<br>
        PID 05: <span id="pid-temp">‚Äî</span> ¬∞C Engine Coolant<br>
        PID 0B: <span id="pid-map">‚Äî</span> kPa MAP<br>
        PID 0C: <span id="pid-rpm2">‚Äî</span> RPM<br>
        PID 0D: <span id="pid-spd">‚Äî</span> km/h Vehicle Speed<br>
        PID 11: <span id="pid-tps">‚Äî</span> % Throttle Position<br>
        PID 14: <span id="pid-o2">‚Äî</span> mV O2 Sensor B1S1<br>
        PID 2F: <span id="pid-fuel">‚Äî</span> % Fuel Level<br>
        PID 43: <span id="pid-load">‚Äî</span> % Absolute Load<br>
        PID 46: <span id="pid-iat">‚Äî</span> ¬∞C Ambient Temp<br>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê APP1: CALIBRACI√ìN CUERPO ACELERACI√ìN ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-app1">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-app1">‚Üê</button>
    <h2 style="color:var(--gold)">‚öô APP 1 ¬∑ CALIBRACI√ìN</h2>
  </div>

  <!-- Tool selector -->
  <div class="fg" style="margin-bottom:12px">
    <div class="row2">
      <div class="field"><label>MARCA / ECU</label>
        <select id="cal-brand">
          <option>Nissan ‚Äî Hitachi</option><option>Nissan ‚Äî Siemens</option>
          <option>VW ‚Äî Bosch ME7</option><option>Chevrolet ‚Äî Delphi</option>
          <option>Ford ‚Äî EEC-V</option><option>Toyota ‚Äî 89661</option>
          <option>Honda ‚Äî Keihin</option><option>Mazda ‚Äî Denso</option>
        </select>
      </div>
      <div class="field"><label>MODELO DE VEH√çCULO</label>
        <input type="text" id="cal-vehicle" placeholder="Tsuru 2010"/>
      </div>
    </div>
    <div class="row2">
      <div class="field"><label>TIPO DE CALIBRACI√ìN</label>
        <select id="cal-type" onchange="renderCalType()">
          <option value="throttle">Cuerpo aceleraci√≥n (TPS)</option>
          <option value="idle">Ralent√≠ / IAC</option>
          <option value="maf">Sensor MAF</option>
          <option value="tps_adap">Adaptaci√≥n TPS</option>
          <option value="ecu_reset">Reset ECU / Adaptaciones</option>
        </select>
      </div>
      <div class="field"><label>ESC√ÅNER</label>
        <select id="cal-scan">
          <option>PROPART OBD2</option><option>Launch X431</option>
          <option>Autel MaxiSYS</option><option>Snap-on</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Procedure display -->
  <div id="cal-procedure-area">
    <!-- Se llena din√°micamente -->
  </div>

  <!-- APP1 Live Charts from OBD -->
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-title" style="color:var(--gold)">üìà TPS + RPM EN VIVO (OBD2)</div>
      <div class="chart-val" id="cal-tps-live" style="color:var(--gold)">‚Äî V</div>
    </div>
    <canvas id="chart-cal-tps" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#050E1C"></canvas>
    <div class="chart-legend" style="margin-top:5px">
      <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div>TPS %</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>RPM√∑100</div>
    </div>
  </div>
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-title" style="color:var(--green)">üìà TEMPERATURA MOTOR (OBD2)</div>
      <div class="chart-val" id="cal-temp-live" style="color:var(--green)">‚Äî ¬∞C</div>
    </div>
    <canvas id="chart-cal-temp" width="440" height="90" style="width:100%;height:90px;border-radius:6px;display:block;background:#050E1C"></canvas>
    <div class="chart-legend" style="margin-top:5px">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>ECT ¬∞C</div>
      <div class="legend-item" style="color:var(--gray)">Normal: 80‚Äì100¬∞C</div>
    </div>
  </div>

  <!-- Simulador manual TPS -->
  <div class="chart-wrap" id="cal-chart-wrap">
    <div class="chart-header">
      <div class="chart-title" style="color:var(--gold)">üéö SIMULADOR TPS MANUAL</div>
      <div class="chart-val" id="cal-tps-display-v" style="color:var(--gold)">0.50 V</div>
    </div>
    <div style="margin-top:8px">
      <div class="cal-limits"><span>M√çNIMO (CERRADO): 0.50V</span><span>M√ÅXIMO (WOT): 4.80V</span></div>
      <input type="range" class="cal-slider" id="cal-tps-slider" min="0" max="100" value="10" oninput="updateCalTPS(this.value)">
      <div class="cal-val-display" id="cal-tps-display">0.50 V ‚Äî CERRADO</div>
      <div class="cal-limits">
        <span style="color:var(--green)" id="cal-status-lbl">‚úì Dentro del rango normal</span>
        <span id="cal-pct-lbl" style="color:var(--lgray)">10%</span>
      </div>
    </div>
  </div>

  <!-- Voltage reference table -->
  <div class="card b-gold">
    <div class="sec-lbl" style="color:var(--gold)">üìä TABLA VOLTAJES TPS</div>
    <table class="val-table">
      <tr><th>POSICI√ìN</th><th>VOLTAJE</th><th>ESTADO</th></tr>
      <tr><td>Cerrado 0%</td><td>0.50‚Äì0.80 V</td><td style="color:var(--green)">‚úì OK</td></tr>
      <tr><td>Crucero 25%</td><td>1.50‚Äì2.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
      <tr><td>Medio 50%</td><td>2.50‚Äì3.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
      <tr><td>¬æ 75%</td><td>3.50‚Äì4.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
      <tr><td>WOT 100%</td><td>4.50‚Äì4.80 V</td><td style="color:var(--green)">‚úì OK</td></tr>
      <tr><td style="color:var(--red)">Falla 0V</td><td style="color:var(--red)">0.00 V</td><td style="color:var(--red)">‚úó ERROR</td></tr>
      <tr><td style="color:var(--red)">Falla 5V fijo</td><td style="color:var(--red)">5.00 V</td><td style="color:var(--red)">‚úó CORTO</td></tr>
    </table>
  </div>

  <div class="btn-row">
    <button class="btn btn-ghost" id="cal-save-btn">üíæ GUARDAR CALIBRACI√ìN</button>
    <button class="btn btn-gold" id="cal-db-push">‚òÅ ‚Üí DB</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê APP2: INMOVILIZADOR ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-app2">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-app2">‚Üê</button>
    <h2 style="color:var(--purple)">üîê APP 2 ¬∑ INMOVILIZADOR</h2>
  </div>

  <div class="row2" style="margin-bottom:12px;gap:8px">
    <div class="field"><label>MARCA / SISTEMA</label>
      <select id="inmo-brand">
        <option>Nissan ‚Äî NATS</option><option>Nissan ‚Äî Transponder</option>
        <option>VW ‚Äî Immo 3</option><option>Ford ‚Äî PATS</option>
        <option>Toyota ‚Äî Immo</option><option>Honda ‚Äî Immo</option>
        <option>Chevrolet ‚Äî BCM</option><option>Mazda ‚Äî Immo</option>
      </select>
    </div>
    <div class="field"><label>VEH√çCULO</label>
      <input type="text" id="inmo-vehicle" placeholder="Sentra B15 2004"/>
    </div>
  </div>

  <!-- NATS Status -->
  <div class="inmo-card">
    <div class="sec-lbl" style="color:var(--purple)">üîê ESTADO DEL INMOVILIZADOR</div>
    <div class="row2" style="margin-bottom:10px">
      <div class="kpi-box" style="background:var(--field)">
        <div class="kpi-val" style="color:var(--purple)" id="inmo-sys">NATS</div>
        <div class="kpi-lbl">SISTEMA</div>
      </div>
      <div class="kpi-box" style="background:var(--field)">
        <div class="kpi-val" style="color:var(--green)" id="inmo-status-val">ACTIVO</div>
        <div class="kpi-lbl">ESTADO</div>
      </div>
    </div>
    <div id="inmo-info" style="font-size:10px;color:var(--lgray);line-height:1.8;margin-bottom:10px">
      <strong style="color:var(--white)">Nissan Anti-Theft System (NATS)</strong><br>
      ‚Ä¢ Transponder en llave comunica con Immo Control<br>
      ‚Ä¢ ID encriptado √∫nico por veh√≠culo<br>
      ‚Ä¢ Slots disponibles: hasta 4 llaves
    </div>
    <!-- Keys -->
    <div class="sec-lbl" style="color:var(--lgray)">üóù LLAVES PROGRAMADAS</div>
    <div class="inmo-key-grid">
      <div class="key-chip ok" id="key-1">
        <div class="key-ico">üóù</div>
        <div class="key-lbl">LLAVE 1</div>
        <div class="key-status" style="color:var(--green)">PROGRAMADA</div>
      </div>
      <div class="key-chip ok" id="key-2">
        <div class="key-ico">üóù</div>
        <div class="key-lbl">LLAVE 2</div>
        <div class="key-status" style="color:var(--green)">PROGRAMADA</div>
      </div>
      <div class="key-chip" id="key-3" onclick="progKey(3)">
        <div class="key-ico">‚ûï</div>
        <div class="key-lbl">LLAVE 3</div>
        <div class="key-status">VAC√çA</div>
      </div>
      <div class="key-chip" id="key-4" onclick="progKey(4)">
        <div class="key-ico">‚ûï</div>
        <div class="key-lbl">LLAVE 4</div>
        <div class="key-status">VAC√çA</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="inmo-prog-btn">üîë PROGRAMAR LLAVE</button>
      <button class="btn btn-ghost btn-red" id="inmo-erase-btn">üóë BORRAR TODAS</button>
    </div>
  </div>

  <!-- Programming procedure -->
  <div class="card b-purple">
    <div class="sec-lbl" style="color:var(--purple)">üìã PROCEDIMIENTO PROGRAMACI√ìN</div>
    <div id="inmo-steps" class="step-list">
      <!-- filled by JS -->
    </div>
    <div class="progress-ring" id="inmo-progress" style="display:none">
      <div class="ring-outer">
        <svg class="ring-svg" viewBox="0 0 120 120">
          <circle class="ring-bg" cx="60" cy="60" r="50"/>
          <circle class="ring-fill" id="inmo-ring-fill" cx="60" cy="60" r="50" stroke="var(--purple)"/>
        </svg>
        <div class="ring-center">
          <div class="ring-pct" id="inmo-ring-pct" style="color:var(--purple)">0%</div>
          <div class="ring-label">PROGRAMANDO</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--lgray);margin-top:8px;text-align:center" id="inmo-prog-msg">Iniciando...</div>
    </div>
  </div>

  <!-- APP2 Live Charts -->
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-title" style="color:var(--purple)">üìà VOLTAJE BATER√çA / ECM (OBD2)</div>
      <div class="chart-val" id="inmo-volt-live" style="color:var(--purple)">‚Äî V</div>
    </div>
    <canvas id="chart-inmo-volt" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#050E1C"></canvas>
    <div class="chart-legend" style="margin-top:5px">
      <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div>Voltaje ECM (V)</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Referencia 12V</div>
    </div>
  </div>
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-title" style="color:var(--gold)">üìà RPM ARRANQUE / SE√ëAL INMO</div>
      <div class="chart-val" id="inmo-rpm-live" style="color:var(--gold)">‚Äî RPM</div>
    </div>
    <canvas id="chart-inmo-rpm" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#050E1C"></canvas>
    <div class="chart-legend" style="margin-top:5px">
      <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div>RPM motor</div>
      <div class="legend-item" style="color:var(--gray)">0 RPM = inmo bloqueando arranque</div>
    </div>
  </div>

  <!-- ECU bypass info -->
  <div class="card">
    <div class="sec-lbl" style="color:var(--lgray)">‚ö† BYPASS / EMERGENCIA</div>
    <div style="font-size:10px;color:var(--lgray);line-height:1.8">
      Si el inmovilizador est√° activado y no hay llave programada disponible, se requiere diagn√≥stico ECU nivel 2. 
      Acceda a <strong style="color:var(--blue)">Enciclopedia ‚Üí Sistema Inmovilizador</strong> para procedimiento completo por marca.
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="showScreen('enc')" style="font-size:10px">üìö VER EN ENCICLOPEDIA</button>
      <button class="btn btn-ghost" id="inmo-db-push" style="font-size:10px;color:var(--teal)">‚òÅ ‚Üí DB</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê ENCICLOPEDIA / DIAGRAMAS ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-enc">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-enc">‚Üê</button>
    <h2 style="color:var(--cyan)">üìê DIAGRAMAS & ENCICLOPEDIA</h2>
  </div>

  <div class="search-box">
    <span style="font-size:14px;color:var(--gray)">üîç</span>
    <input type="text" placeholder="Buscar marca, modelo, sistema, DTC, PIN..." id="enc-q" oninput="filterEnc()">
  </div>
  <div class="filter-row" id="enc-filters">
    <div class="filter-tag sel" onclick="filterEncCat(this,'all')">TODOS</div>
    <div class="filter-tag" onclick="filterEncCat(this,'nissan')">NISSAN</div>
    <div class="filter-tag" onclick="filterEncCat(this,'vw')">VW</div>
    <div class="filter-tag" onclick="filterEncCat(this,'chevrolet')">CHEVROLET</div>
    <div class="filter-tag" onclick="filterEncCat(this,'ford')">FORD</div>
    <div class="filter-tag" onclick="filterEncCat(this,'toyota')">TOYOTA</div>
    <div class="filter-tag" onclick="filterEncCat(this,'honda')">HONDA</div>
    <div class="filter-tag" onclick="filterEncCat(this,'pinout')">PINOUTS ECU</div>
    <div class="filter-tag" onclick="filterEncCat(this,'dtc')">C√ìDIGOS DTC</div>
    <div class="filter-tag" onclick="filterEncCat(this,'tabla')">TABLAS VALORES</div>
  </div>

  <div id="enc-list"><!-- built by JS --></div>

  <!-- Detail Modal area -->
  <div id="enc-detail" style="display:none">
    <div class="sec-hdr">
      <button class="back-btn" id="bk-enc-detail">‚Üê ATR√ÅS</button>
      <h2 id="enc-detail-title" style="font-size:12px;color:var(--cyan)">‚Äî</h2>
    </div>
    <div id="enc-detail-body" class="card b-cyan"><!-- filled --></div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="enc-detail-add-rep" style="font-size:10px">üìã AGREGAR A REPORTE</button>
      <button class="btn btn-ghost" id="enc-detail-db" style="font-size:10px;color:var(--teal)">‚òÅ CARGAR DE DB</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê REPORTE ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-report">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-report">‚Üê</button>
    <h2 style="color:var(--red)">üìã NUEVO REPORTE</h2>
    <button class="hdr-pill" id="rep-draft-btn" style="font-size:9px">üíæ BORRADOR</button>
  </div>
  <div class="form-prog"><div class="form-prog-fill" id="fp" style="width:0%"></div></div>
  <div class="folio-banner">
    <div>
      <div style="font-size:7px;color:var(--gray);letter-spacing:1px">FOLIO</div>
      <div class="folio-num" id="r-folio-disp">PP-2024-0001</div>
    </div>
    <div class="folio-meta">
      <div id="r-date-disp"></div>
      <div>TECH: F. MILL√ÅN</div>
    </div>
  </div>

  <!-- S1 VEH√çCULO -->
  <div class="sec-lbl" style="color:var(--blue)">1 ¬∑ VEH√çCULO / CLIENTE</div>
  <div class="card b-blue">
    <div class="fg">
      <div class="row2">
        <div class="field"><label>PROPIETARIO *</label><input type="text" id="r-owner" placeholder="Nombre completo" oninput="updateFP()"></div>
        <div class="field"><label>TEL√âFONO</label><input type="tel" id="r-phone" placeholder="777-000-0000"></div>
      </div>
      <div class="field"><label>CORREO</label><input type="email" id="r-email" placeholder="cliente@mail.com"></div>
      <div class="row2">
        <div class="field"><label>MARCA *</label><input type="text" id="r-brand" placeholder="Nissan" oninput="updateFP()"></div>
        <div class="field"><label>MODELO *</label><input type="text" id="r-model" placeholder="Versa" oninput="updateFP()"></div>
      </div>
      <div class="row3">
        <div class="field"><label>A√ëO</label><input type="number" id="r-year" placeholder="2020"></div>
        <div class="field"><label>PLACAS</label><input type="text" id="r-plates" placeholder="ABC-123" style="text-transform:uppercase"></div>
        <div class="field"><label>COLOR</label><input type="text" id="r-color" placeholder="Blanco"></div>
      </div>
      <div class="row2">
        <div class="field"><label>KM ENTRADA</label><input type="number" id="r-km" placeholder="85000"></div>
        <div class="field"><label>MOTOR</label><input type="text" id="r-engine" placeholder="1.6L HR16DE"></div>
      </div>
      <div class="field"><label>VIN / N√öMERO SERIE</label><input type="text" id="r-vin" placeholder="3N1CN7AP9GL..." style="font-family:'Share Tech Mono',monospace;text-transform:uppercase"></div>
    </div>
  </div>

  <!-- S2 DIAGN√ìSTICO -->
  <div class="sec-lbl" style="color:var(--red)">2 ¬∑ DIAGN√ìSTICO</div>
  <div class="card b-red">
    <div class="fg">
      <div class="field"><label>QUEJA DEL CLIENTE *</label><textarea id="r-complaint" placeholder="Ej: Motor falla en ralent√≠, check encendida..." oninput="updateFP()"></textarea></div>
      <div class="field"><label>OBSERVACI√ìN T√âCNICA</label><textarea id="r-obs" placeholder="Ej: Motor irregular, vac√≠o PCV, MAF sucio..."></textarea></div>
      <div class="field">
        <label>C√ìDIGOS DTC</label>
        <div class="dtc-add-row">
          <input id="dtc-inp" placeholder="P0171" maxlength="7"/>
          <button style="background:rgba(255,75,92,.2);border:1px solid var(--red);border-radius:7px;color:var(--white);padding:8px 12px;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:11px;cursor:pointer" id="btn-add-dtc">+ ADD</button>
        </div>
        <div class="dtc-row" id="r-dtc-chips"></div>
      </div>
      <div class="row2">
        <div class="field"><label>ESC√ÅNER</label>
          <select id="r-scan"><option>PROPART OBD2</option><option>Launch X431</option><option>Autel MaxiSYS</option><option>Snap-on</option><option>Otro</option></select>
        </div>
        <div class="field"><label>SISTEMA AFECTADO</label>
          <select id="r-sys">
            <option value="">‚Äî Seleccionar ‚Äî</option>
            <option>Motor</option><option>Transmisi√≥n</option><option>Frenos/ABS</option>
            <option>El√©ctrico/BCM</option><option>Suspensi√≥n</option><option>A/C</option>
            <option>Combustible/EVAP</option><option>Emisiones/EGR</option>
            <option>Direcci√≥n/EPS</option><option>SRS/Airbags</option><option>M√∫ltiple</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- S3 TRABAJO -->
  <div class="sec-lbl" style="color:var(--gold)">3 ¬∑ TRABAJO REALIZADO</div>
  <div class="card b-gold">
    <div class="fg">
      <div class="field"><label>DESCRIPCI√ìN *</label><textarea id="r-work" style="min-height:80px" placeholder="Ej: Limpieza MAF, cambio manguera PCV, reset ECM..." oninput="updateFP()"></textarea></div>
      <div class="field"><label>REFACCIONES UTILIZADAS</label><textarea id="r-parts" style="min-height:56px" placeholder="Manguera PCV #14055-3TA0A, Filtro aire..."></textarea></div>
      <div class="row2">
        <div class="field"><label>HORAS MO</label><input type="text" id="r-labor" placeholder="2.5 hrs"></div>
        <div class="field"><label>T√âCNICO</label>
          <select id="r-tech"><option>F. Mill√°n</option><option>A. Garc√≠a</option><option>R. L√≥pez</option></select>
        </div>
      </div>
      <div class="row2">
        <div class="field"><label>GARANT√çA</label>
          <select id="r-warranty">
            <option>Sin garant√≠a</option><option>15 d√≠as</option><option>30 d√≠as</option>
            <option>60 d√≠as</option><option>90 d√≠as</option><option>6 meses</option><option>1 a√±o</option>
          </select>
        </div>
        <div class="field"><label>ENTREGA ESTIMADA</label><input type="text" id="r-eta" placeholder="3‚Äì4 horas"></div>
      </div>
      <div class="field"><label>RECOMENDACIONES</label><textarea id="r-recs" style="min-height:48px" placeholder="Pr√≥ximas acciones, revisiones, seguimiento..."></textarea></div>
    </div>
    <div class="cost-box">
      <div><div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--lgray);letter-spacing:1px">COSTO TOTAL</div>
        <div style="font-size:8px;color:var(--gray)">MO + Partes + IVA</div></div>
      <div class="cost-val">
        <select id="r-curr" style="width:60px;font-size:11px;padding:5px"><option>MXN</option><option>USD</option></select>
        <input type="number" id="r-total" placeholder="1450" style="width:110px;text-align:right;font-size:20px;font-weight:700;font-family:'Rajdhani',sans-serif;color:var(--green)">
      </div>
    </div>
  </div>

  <!-- S4 INSPECCI√ìN VISUAL -->
  <div class="sec-lbl" style="color:var(--green)">4 ¬∑ INSPECCI√ìN VISUAL</div>
  <div class="card b-green" style="padding-bottom:6px">
    <div class="chk-grp">‚öô MOTOR</div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Nivel y color de aceite</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Nivel de refrigerante</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Mangueras y ductos</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Correa distribuci√≥n / accesorios</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-grp">üîã EL√âCTRICO</div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Bater√≠a y terminales</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Fusibles y rel√©s principales</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-grp">üõû FRENOS</div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Pastillas delanteras</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Pastillas traseras</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Amortiguadores / bujes</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-grp">‚ùÑ A/C</div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Carga de refrigerante</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="chk-item" onclick="tChk(this)"><div class="chk-ico">‚úì</div><span class="chk-txt">Filtro de cabina</span><div class="st-row"><div class="st-pill sel" data-v="ok">OK</div><div class="st-pill" data-v="warn">‚ö†</div><div class="st-pill" data-v="fail">‚úó</div></div></div>
    <div class="field" style="margin-top:10px"><label>NOTAS INSPECCI√ìN</label><textarea id="r-insp" style="min-height:48px" placeholder="Observaciones adicionales..."></textarea></div>
  </div>

  <!-- S5 ESTADO -->
  <div class="sec-lbl" style="color:var(--purple)">5 ¬∑ ESTADO / FLUJO</div>
  <div class="card b-purple">
    <div class="field"><label>ESTADO ACTUAL</label>
      <select id="r-status">
        <option value="recibido">Recibido</option>
        <option value="diagnostico">En diagn√≥stico</option>
        <option value="espera_partes">Espera de partes</option>
        <option value="reparacion">En reparaci√≥n</option>
        <option value="prueba">Prueba de ruta</option>
        <option value="listo">Listo para entrega</option>
        <option value="entregado">Entregado</option>
      </select>
    </div>
    <div class="status-flow" style="margin-top:10px">
      <div class="sf-col"><div class="sf-bar done"></div><div class="sf-lbl">RECIBIDO</div></div>
      <div class="sf-col"><div class="sf-bar active"></div><div class="sf-lbl">DIAGN√ìST.</div></div>
      <div class="sf-col"><div class="sf-bar"></div><div class="sf-lbl">REPARAC.</div></div>
      <div class="sf-col"><div class="sf-bar"></div><div class="sf-lbl">PRUEBA</div></div>
      <div class="sf-col"><div class="sf-bar"></div><div class="sf-lbl">ENTREGA</div></div>
    </div>
  </div>

  <!-- S6 FIRMA -->
  <div class="sec-lbl" style="color:var(--teal)">6 ¬∑ FIRMA Y ENTREGA</div>
  <div class="card b-teal">
    <div style="text-align:center;padding:10px 0 6px;border-bottom:1px solid rgba(30,140,224,.2);margin-bottom:10px">
      <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--blue)">FERNANDO MILL√ÅN</div>
      <div style="font-size:8px;color:var(--gray);letter-spacing:1px;margin-top:2px">T√âCNICO CERTIFICADO ¬∑ PROPART DIAGNOSTIC</div>
    </div>
    <div class="field" style="margin-bottom:8px">
      <label>FIRMA DIGITAL CLIENTE</label>
      <canvas class="sig-canvas" id="sig-canvas"></canvas>
      <button class="btn btn-ghost" style="font-size:9px;padding:5px;margin-top:4px;flex:0" id="sig-clear">‚úï BORRAR</button>
    </div>
    <div class="field"><label>CALIFICACI√ìN DEL SERVICIO</label>
      <div class="rating-row" id="r-rating">
        <span class="rstar lit" onclick="setR(1)">‚òÖ</span>
        <span class="rstar lit" onclick="setR(2)">‚òÖ</span>
        <span class="rstar lit" onclick="setR(3)">‚òÖ</span>
        <span class="rstar" onclick="setR(4)">‚òÖ</span>
        <span class="rstar" onclick="setR(5)">‚òÖ</span>
      </div>
    </div>
    <div class="field" style="margin-top:8px"><label>NOTAS FINALES</label><textarea id="r-notes" style="min-height:48px" placeholder="Seguimiento, pr√≥xima cita, observaciones..."></textarea></div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="rep-share-btn" style="font-size:10px">üì§ COMPARTIR</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-green" id="rep-save-btn">‚úÖ GUARDAR REPORTE</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="rep-db-push" style="font-size:10px;color:var(--teal)">‚òÅ ENVIAR A BASE DE DATOS</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê HISTORIAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-hist">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-hist">‚Üê</button>
    <h2 style="color:#00B4C8">üóÇ HISTORIAL</h2>
    <button class="hdr-pill" id="hist-sync-btn" style="font-size:9px">üîÑ SYNC</button>
  </div>
  <div class="search-box">
    <span style="font-size:14px;color:var(--gray)">üîç</span>
    <input type="text" placeholder="Folio, propietario, veh√≠culo..." id="hist-q">
  </div>
  <div class="filter-row">
    <div class="filter-tag sel" id="hf-all">TODOS</div>
    <div class="filter-tag" id="hf-ent">ENTREGADOS</div>
    <div class="filter-tag" id="hf-pro">EN PROCESO</div>
    <div class="filter-tag" id="hf-pen">PENDIENTES</div>
  </div>
  <div id="hist-list">
    <div class="hist-item"><div style="display:flex;justify-content:space-between"><div class="hist-folio">PP-2024-0003</div><div class="hist-date">15 Feb 2024</div></div><div class="hist-vehicle">Toyota Corolla 2018</div><div class="hist-owner">Mar√≠a Gonz√°lez ¬∑ XYZ-456-F</div><div class="hist-footer"><span class="hist-st e">ENTREGADO</span><div class="hist-cost">MXN $1,850</div></div></div>
    <div class="hist-item"><div style="display:flex;justify-content:space-between"><div class="hist-folio">PP-2024-0002</div><div class="hist-date">12 Feb 2024</div></div><div class="hist-vehicle">Chevrolet Suburban 2015</div><div class="hist-owner">Carlos P√©rez ¬∑ MON-789-A</div><div class="hist-footer"><span class="hist-st p">EN PROCESO</span><div class="hist-cost">MXN $3,200</div></div></div>
    <div class="hist-item"><div style="display:flex;justify-content:space-between"><div class="hist-folio">PP-2024-0001</div><div class="hist-date">08 Feb 2024</div></div><div class="hist-vehicle">Nissan Versa 2020</div><div class="hist-owner">Juan Ram√≠rez ¬∑ ABC-123-D</div><div class="hist-footer"><span class="hist-st n">PENDIENTE</span><div class="hist-cost">MXN $750</div></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê VEH√çCULOS ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-veh">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-veh">‚Üê</button>
    <h2 style="color:var(--teal)">üöó VEH√çCULOS</h2>
  </div>
  <div class="search-box"><span style="font-size:14px;color:var(--gray)">üîç</span><input type="text" placeholder="Placas, propietario, marca..."></div>
  <div class="kpi-row">
    <div class="kpi-box"><div class="kpi-val" style="color:var(--teal)">3</div><div class="kpi-lbl">Veh√≠culos</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--blue)">3</div><div class="kpi-lbl">Clientes</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--green)">22</div><div class="kpi-lbl">Visitas</div></div>
  </div>
  <div class="veh-item"><div class="veh-header"><div class="veh-icon">üöó</div><div style="flex:1"><div class="veh-name">Nissan Versa 2020</div><div class="veh-plates">ABC-123-D</div><div class="veh-owner">üë§ Juan Ram√≠rez</div></div><div style="color:var(--gray);font-size:18px">‚Ä∫</div></div><div class="veh-stats"><div class="veh-stat">KM: <strong>87,500</strong></div><div class="veh-stat">Motor: <strong>1.6L HR16</strong></div><div class="veh-stat">Visitas: <strong>3</strong></div></div></div>
  <div class="veh-item"><div class="veh-header"><div class="veh-icon">üöô</div><div style="flex:1"><div class="veh-name">Toyota Corolla 2018</div><div class="veh-plates">XYZ-456-F</div><div class="veh-owner">üë§ Mar√≠a Gonz√°lez</div></div><div style="color:var(--gray);font-size:18px">‚Ä∫</div></div><div class="veh-stats"><div class="veh-stat">KM: <strong>112,000</strong></div><div class="veh-stat">Motor: <strong>2.0L 1ZR</strong></div><div class="veh-stat">Visitas: <strong>7</strong></div></div></div>
  <div class="veh-item"><div class="veh-header"><div class="veh-icon">üöê</div><div style="flex:1"><div class="veh-name">Chevrolet Suburban 2015</div><div class="veh-plates">MON-789-A</div><div class="veh-owner">üë§ Carlos P√©rez</div></div><div style="color:var(--gray);font-size:18px">‚Ä∫</div></div><div class="veh-stats"><div class="veh-stat">KM: <strong>195,400</strong></div><div class="veh-stat">Motor: <strong>5.3L LS</strong></div><div class="veh-stat">Visitas: <strong>12</strong></div></div></div>
  <div class="btn-row"><button class="btn btn-ghost" onclick="openDB()" style="font-size:10px">üóÑ CARGAR DESDE DB</button></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê ADMINISTRAR ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-adm">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-adm">‚Üê</button>
    <h2 style="color:var(--orange)">üõ† ADMINISTRAR</h2>
  </div>
  <div class="sec-lbl" style="color:var(--blue)">üè¢ TALLER</div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">üè≠</div><div><div class="adm-lbl">Nombre del taller</div><div class="adm-sub">AUTOPARTES MILL√ÅN</div></div></div><div class="adm-val">‚Ä∫</div></div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">üì±</div><div><div class="adm-lbl">Tel√©fono</div><div class="adm-sub">777 683 8196</div></div></div><div class="adm-val">‚Ä∫</div></div>
  <div class="sec-lbl" style="color:var(--green);margin-top:14px">üîß T√âCNICOS</div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">üë®‚Äçüîß</div><div><div class="adm-lbl">Fernando Mill√°n</div><div class="adm-sub">Principal ¬∑ PROPIETARIO</div></div></div><div style="background:rgba(0,196,140,.15);color:var(--green);font-size:8px;font-family:'Rajdhani',sans-serif;font-weight:700;padding:2px 7px;border-radius:4px">ACTIVO</div></div>
  <div class="sec-lbl" style="color:var(--gold);margin-top:14px">‚öô FOLIO</div>
  <div class="card" style="padding:11px">
    <div class="row2"><div class="field"><label>PREFIJO</label><input type="text" id="adm-prefix" value="PP"></div><div class="field"><label>N√öMERO ACTUAL</label><input type="number" id="adm-num" value="1"></div></div>
    <button class="btn btn-primary" style="width:100%;margin-top:9px;font-size:11px" id="adm-folio-save">GUARDAR</button>
  </div>
  <div class="sec-lbl" style="color:var(--purple);margin-top:14px">üóÑ BASE DE DATOS</div>
  <div class="adm-row" onclick="openDB()"><div class="adm-left"><div class="adm-ico">üîó</div><div><div class="adm-lbl">Configurar conexi√≥n</div><div class="adm-sub" id="adm-db-sub">Sin conectar</div></div></div><div class="adm-val" style="color:var(--blue)">CONF ‚Ä∫</div></div>
  <div class="adm-row" id="adm-export"><div class="adm-left"><div class="adm-ico">üì§</div><div><div class="adm-lbl">Exportar datos JSON</div><div class="adm-sub">Backup completo local</div></div></div><div class="adm-val">‚Ä∫</div></div>
  <div class="sec-lbl" style="color:var(--cyan);margin-top:14px">üîî PREFERENCIAS</div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">‚òÅ</div><div><div class="adm-lbl">Auto-sync DB</div><div class="adm-sub">Sincronizar autom√°ticamente</div></div></div><div class="toggle-sw" id="tgl-sync" onclick="this.classList.toggle('on')"></div></div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">üîí</div><div><div class="adm-lbl">Modo offline</div><div class="adm-sub">Guardar si sin red</div></div></div><div class="toggle-sw on" id="tgl-off" onclick="this.classList.toggle('on')"></div></div>
  <div class="adm-row"><div class="adm-left"><div class="adm-ico">üìà</div><div><div class="adm-lbl">Gr√°ficas OBD en vivo</div><div class="adm-sub">Historial 60 lecturas</div></div></div><div class="toggle-sw on" id="tgl-charts" onclick="this.classList.toggle('on')"></div></div>
  <div style="text-align:center;font-size:8px;color:var(--gray);padding:12px 0;letter-spacing:1px">PROPART V40 ¬∑ ¬© 2024 AUTOPARTES MILL√ÅN ¬∑ 777 683 8196</div>
</div>

</div><!-- /page -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-home"><span class="ni">üè†</span><span class="nl">INICIO</span></button>
  <button class="nav-btn" id="nav-obd"><span class="ni">üîå</span><span class="nl">OBD2</span></button>
  <button class="nav-btn" id="nav-report" style="position:relative"><span class="ni">üìã</span><span class="nl">REPORTE</span></button>
  <button class="nav-btn" id="nav-enc"><span class="ni">üìê</span><span class="nl">DIAGRAMAS</span></button>
  <button class="nav-btn" id="nav-adm"><span class="ni">üõ†</span><span class="nl">ADMIN</span></button>
</nav>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  lang:'es', bt:false,
  db:{ connected:false, url:'https://github.com/84-fmill-mel30/base_datos_master.json', key:'', proj:'', type:'rest', lastSync:null, mods:new Set(['reportes','vehiculos','clientes','diagramas','dtc','pinouts','enc']) },
  reports: JSON.parse(localStorage.getItem('pp_r')||'[]'),
  folio:{ prefix:'PP', num: parseInt(localStorage.getItem('pp_fn')||'1') },
  obd:{ running:false, iv:null },
  charts:{ rpm:[], load:[], temp:[], maf:[], tps:[], volt:[], o2:[] },
  calTick:0, calIv:null,
  rating:3, syncIv:null
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENCYCLOPEDIA DATA (from BASE_DATOS_DIAGRAMAS.md)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ENC_DATA = [
  // NISSAN
  { id:'n001', brand:'nissan', model:'Tsuru III (1992-2012)', system:'inyeccion', title:'Sistema Inyecci√≥n GA16DE', tags:['NISSAN','TSURU','GA16DE','ECU 55PIN'], file:'NISSAN_TSURU_INYECCION_GA16DE.pdf',
    content:`ECU: Hitachi 55 pines\n‚Ä¢ Sensor MAF ‚Äî Cable verde/amarillo ‚Äî 5V\n‚Ä¢ Sensor TPS ‚Äî Cable azul/blanco ‚Äî 5V\n‚Ä¢ Sensor CKP ‚Äî Cable negro/rojo ‚Äî se√±al AC\n‚Ä¢ Inyectores 1-4 ‚Äî Cable caf√© ‚Äî 12V pulsado\n‚Ä¢ Bomba gasolina ‚Äî Cable verde/negro ‚Äî 12V relay\nC√≥digos de color completos ¬∑ Ubicaci√≥n conectores ¬∑ Valores voltaje normales`, type:'diagrama' },
  { id:'n002', brand:'nissan', model:'Tsuru III (1992-2012)', system:'electrico', title:'Sistema El√©ctrico Completo Tsuru', tags:['NISSAN','TSURU','EL√âCTRICO','CARGA'], file:'NISSAN_TSURU_ELECTRICO_COMPLETO.pdf',
    content:`Sistema de carga ‚Äî Alternador 80A\nSistema de arranque ‚Äî Marcha 12V\nLuces: alta/baja, direccionales, freno\nTablero de instrumentos\nSistema de encendido ¬∑ Fusibles y relevadores`, type:'diagrama' },
  { id:'n003', brand:'nissan', model:'Tsuru III (1992-2012)', system:'encendido', title:'Sistema Encendido Electr√≥nico Tsuru', tags:['NISSAN','TSURU','ENCENDIDO','DIS','CKP'], file:'TSURU_ENCENDIDO_DIS.pdf',
    content:`M√≥dulo de encendido 4 pines\nBobinas tipo l√°piz\nSensores CKP y CMP\nDiagrama de sincronizaci√≥n`, type:'diagrama' },
  { id:'n004', brand:'nissan', model:'Sentra B15 (2000-2006)', system:'inyeccion', title:'Inyecci√≥n QG18DE ‚Äî ECU 81 Pines', tags:['NISSAN','SENTRA','QG18DE','DRIVE-BY-WIRE'], file:'SENTRA_B15_QG18DE_INYECCION.pdf',
    content:`ECU Nissan 81 pines\nSistema drive-by-wire\nSensor APP ‚Äî pedal electr√≥nico\nBody de aceleraci√≥n electr√≥nico\nInyectores secuenciales ¬∑ EVAP completo`, type:'diagrama' },
  { id:'n005', brand:'nissan', model:'Sentra B15 (2000-2006)', system:'electrico', title:'Sistema El√©ctrico B15 ‚Äî ABS + SRS + NATS', tags:['NISSAN','SENTRA','ABS','SRS','NATS','INMOVILIZADOR'], file:'SENTRA_B15_ELECTRICO.pdf',
    content:`Alternador 110A\nMarcha de reducci√≥n\nSistema ABS 4 sensores\nBolsas de aire SRS\nInmovilizador NATS`, type:'diagrama' },
  { id:'n006', brand:'nissan', model:'Platina (2002-2010)', system:'inyeccion', title:'Inyecci√≥n Renault K7M ‚Äî TBI', tags:['NISSAN','PLATINA','RENAULT','K7M','TBI','EGR'], file:'PLATINA_K7M_INYECCION.pdf',
    content:`ECU Renault 55 pines\nTBI ‚Äî cuerpo aceleraci√≥n\nSensor MAP integrado\nCanister EVAP ¬∑ V√°lvula EGR`, type:'diagrama' },
  // VW
  { id:'v001', brand:'vw', model:'Jetta A4 (1999-2007)', system:'inyeccion', title:'Inyecci√≥n 2.0 AEG ‚Äî Bosch ME7', tags:['VW','JETTA','AEG','ME7','BOSCH','121PIN'], file:'JETTA_A4_2.0_AEG_INYECCION.pdf',
    content:`ECU Bosch Motronic ME7 ‚Äî 121 pines\nSistema COP ‚Äî bobinas individuales\nSensor G28 (CKP) ¬∑ Sensor G40 (Hall)\nMAF tipo pel√≠cula caliente\nInyectores Bosch 4 agujeros`, type:'diagrama' },
  { id:'v002', brand:'vw', model:'Jetta A4 (1999-2007)', system:'electrico', title:'Sistema El√©ctrico Jetta A4 ‚Äî CAN Bus', tags:['VW','JETTA','CAN BUS','M√ìDULO CONFORT'], file:'JETTA_A4_ELECTRICO_COMPLETO.pdf',
    content:`M√≥dulo de confort\nSistema Climatronic\nElevavidrios el√©ctricos\nCentral el√©ctrica ¬∑ CAN-Bus b√°sico`, type:'diagrama' },
  { id:'v003', brand:'vw', model:'Jetta A4 (1999-2007)', system:'frenos', title:'ABS/ESP Jetta ‚Äî Bosch 5.3', tags:['VW','JETTA','ABS','ESP','BOSCH 5.3'], file:'JETTA_A4_ABS_ESP.pdf',
    content:`Sistema Bosch 5.3\nSensores de rueda (4)\nV√°lvulas hidr√°ulicas\nBomba de retorno`, type:'diagrama' },
  { id:'v004', brand:'vw', model:'Beetle (1999-2010)', system:'inyeccion', title:'Beetle 2.0 ‚Äî ME7.5 + Inmovilizador', tags:['VW','BEETLE','ME7.5','INMOVILIZADOR','THROTTLE ELEC'], file:'BEETLE_2.0_INYECCION.pdf',
    content:`ECU ME7.5\nThrottle electr√≥nico\nSistema inmovilizador integrado`, type:'diagrama' },
  // CHEVROLET
  { id:'c001', brand:'chevrolet', model:'Chevy C2 (2004-2012)', system:'inyeccion', title:'Inyecci√≥n 1.6 MPFI ‚Äî Delphi MT20U', tags:['CHEVROLET','CHEVY','DELPHI','MT20U','48PIN'], file:'CHEVY_C2_1.6_MPFI.pdf',
    content:`ECU Delphi MT20U ‚Äî 48 pines\nTPS integrado ¬∑ MAP 3 pines\nInyectores saturados\nBobina DIS 2 salidas`, type:'diagrama' },
  { id:'c002', brand:'chevrolet', model:'Aveo (2007-2011)', system:'inyeccion', title:'Motor 1.6 Ecotec ‚Äî Bosch ME7.9.9', tags:['CHEVROLET','AVEO','ECOTEC','BOSCH','81PIN','EVAP'], file:'AVEO_1.6_ECOTEC.pdf',
    content:`ECU Bosch ME7.9.9 ‚Äî 81 pines\nDrive-by-wire\nSistema EVAP mejorado`, type:'diagrama' },
  // FORD
  { id:'f001', brand:'ford', model:'Focus (2000-2007)', system:'inyeccion', title:'Zetec 2.0 ‚Äî EEC-V + PATS (Inmovilizador)', tags:['FORD','FOCUS','ZETEC','EEC-V','PATS','104PIN'], file:'FORD_FOCUS_ZETEC_INYECCION.pdf',
    content:`ECU EEC-V ‚Äî 104 pines\nSistema PATS (inmovilizador)\nSensores rueda variable\nCOP ‚Äî 4 bobinas`, type:'diagrama' },
  // TOYOTA
  { id:'t001', brand:'toyota', model:'Corolla (2003-2008)', system:'inyeccion', title:'1ZZ-FE ‚Äî VVTi ‚Äî OBD-II Completo', tags:['TOYOTA','COROLLA','1ZZ-FE','VVTI','76PIN','O2'], file:'TOYOTA_COROLLA_1ZZ_INYECCION.pdf',
    content:`ECU Toyota 89661 ‚Äî 76 pines\nVVTi ‚Äî v√°lvulas variables\nSistema OBD-II completo\n2 sensores O2 ¬∑ EVAP con bomba`, type:'diagrama' },
  // HONDA
  { id:'h001', brand:'honda', model:'Civic (2001-2005)', system:'inyeccion', title:'D17A ‚Äî VTEC ‚Äî ECU Honda 72 Pines', tags:['HONDA','CIVIC','D17A','VTEC','72PIN'], file:'HONDA_CIVIC_D17A_INYECCION.pdf',
    content:`ECU Honda 37820-PLR ‚Äî 72 pines\nSistema VTEC\nSensor solenoide VTEC ¬∑ Presi√≥n aceite`, type:'diagrama' },
  // PINOUTS
  { id:'p001', brand:'pinout', model:'Nissan Tsuru', system:'pinout', title:'PINOUT ECU Tsuru GA16DE 55 Pines', tags:['PINOUT','NISSAN','TSURU','55PIN','ECU'], type:'pinout',
    pinout:[
      {pin:1, cable:'Rojo grueso', funcion:'Alimentaci√≥n 12V', voltaje:'12V'},
      {pin:2, cable:'Negro grueso', funcion:'Tierra chasis', voltaje:'0V'},
      {pin:4, cable:'Verde/amarillo', funcion:'Se√±al MAF', voltaje:'0.5-4.8V'},
      {pin:5, cable:'Azul/blanco', funcion:'Se√±al TPS', voltaje:'0.5-4.5V'},
      {pin:6, cable:'Amarillo', funcion:'Sensor ECT', voltaje:'Variable'},
      {pin:7, cable:'Verde', funcion:'Sensor IAT', voltaje:'Variable'},
      {pin:8, cable:'Negro/rojo', funcion:'Se√±al CKP', voltaje:'AC'},
      {pin:10, cable:'Caf√©/blanco', funcion:'Inyector 1', voltaje:'12V pulsado'},
      {pin:11, cable:'Caf√©/verde', funcion:'Inyector 2', voltaje:'12V pulsado'},
      {pin:12, cable:'Caf√©/azul', funcion:'Inyector 3', voltaje:'12V pulsado'},
      {pin:13, cable:'Caf√©/amarillo', funcion:'Inyector 4', voltaje:'12V pulsado'},
      {pin:16, cable:'Verde/negro', funcion:'Bomba combustible', voltaje:'12V relay'},
      {pin:17, cable:'Blanco', funcion:'O2 Sensor se√±al', voltaje:'0.1-0.9V'},
      {pin:19, cable:'P√∫rpura', funcion:'V√°lvula EVAP', voltaje:'12V PWM'},
      {pin:21, cable:'Amarillo/negro', funcion:'Luz Check Engine', voltaje:'12V'},
    ] },
  { id:'p002', brand:'pinout', model:'VW Jetta A4', system:'pinout', title:'PINOUT ECU VW ME7 121 Pines', tags:['PINOUT','VW','JETTA','121PIN','ME7'], type:'pinout',
    pinout:[
      {pin:1, cable:'Rojo', funcion:'KL15 Ignici√≥n', voltaje:'12V'},
      {pin:2, cable:'Rojo grueso', funcion:'KL30 Bater√≠a', voltaje:'12V'},
      {pin:'3-5', cable:'Caf√©', funcion:'Tierras motor', voltaje:'0V'},
      {pin:10, cable:'Verde/negro', funcion:'Sensor G28 CKP', voltaje:'AC'},
      {pin:11, cable:'Gris/azul', funcion:'G40 Hall CMP', voltaje:'Digital'},
      {pin:15, cable:'Negro/amarillo', funcion:'Bobina cilindro 1', voltaje:'12V'},
      {pin:16, cable:'Negro/caf√©', funcion:'Bobina cilindro 2', voltaje:'12V'},
      {pin:17, cable:'Negro/azul', funcion:'Bobina cilindro 3', voltaje:'12V'},
      {pin:18, cable:'Negro/rojo', funcion:'Bobina cilindro 4', voltaje:'12V'},
      {pin:22, cable:'Amarillo/azul', funcion:'MAF se√±al', voltaje:'0-5V'},
      {pin:30, cable:'Rojo/caf√©', funcion:'Inyector 1', voltaje:'12V pulsado'},
    ] },
  // DTC
  { id:'d001', brand:'dtc', model:'General', system:'motor', title:'P0171 ‚Äî Sistema Demasiado Pobre Banco 1', tags:['DTC','MEZCLA','COMBUSTIBLE','LAMBDA','MAF'], type:'dtc',
    content:`DESCRIPCI√ìN: Relaci√≥n aire/combustible excesivamente pobre\n\nCAUSAS M√ÅS COMUNES:\n‚Ä¢ Sensor MAF sucio o da√±ado\n‚Ä¢ Vac√≠o en manguera PCV\n‚Ä¢ Bomba de combustible d√©bil\n‚Ä¢ Inyectores sucios o taponados\n‚Ä¢ Sensor O2 lento o contaminado\n‚Ä¢ Filtro de combustible tapado\n\nDIAGN√ìSTICO:\n1. Revisar vac√≠os en sistema de admisi√≥n\n2. Medir voltaje MAF en ralent√≠ (debe ser 0.8-1.2V)\n3. Verificar presi√≥n combustible\n4. Revisar inyectores con osciloscopio` },
  { id:'d002', brand:'dtc', model:'General', system:'encendido', title:'P0300 ‚Äî Fallo M√∫ltiple de Encendido', tags:['DTC','ENCENDIDO','BUJ√çAS','BOBINAS','MISFIRE'], type:'dtc',
    content:`DESCRIPCI√ìN: Fallo de encendido detectado en m√∫ltiples cilindros\n\nCAUSAS:\n‚Ä¢ Buj√≠as desgastadas o incorrectas\n‚Ä¢ Cables de buj√≠a da√±ados\n‚Ä¢ Bobinas defectuosas\n‚Ä¢ Compresi√≥n baja\n‚Ä¢ Inyectores fallando\n‚Ä¢ Se√±al CKP err√°tica\n\nDIAGN√ìSTICO:\n1. Leer PID de misfire count por cilindro\n2. Revisar buj√≠as (desgaste, brecha)\n3. Medir resistencia bobinas\n4. Verificar compresi√≥n en cilindros` },
  { id:'d003', brand:'dtc', model:'General', system:'emisiones', title:'P0420 ‚Äî Eficiencia Catalizador Banco 1', tags:['DTC','CATALIZADOR','O2','EMISIONES'], type:'dtc',
    content:`DESCRIPCI√ìN: Eficiencia del catalizador por debajo del umbral\n\nCAUSAS:\n‚Ä¢ Catalizador contaminado (aceite, anticongelante)\n‚Ä¢ Catalizador mec√°nicamente da√±ado\n‚Ä¢ Sensor O2 trasero da√±ado\n‚Ä¢ Sensor O2 delantero lento\n‚Ä¢ Mezcla rica sostenida (P0172)\n\nDIAGN√ìSTICO:\n1. Comparar se√±ales O2 delantero y trasero\n2. Si trasero oscila igual que delantero ‚Üí catalizador malo\n3. Verificar no haya fugas de aceite al motor\n4. Medir temperatura entrada/salida catalizador` },
  // TABLAS
  { id:'tb001', brand:'tabla', model:'Sensores Universales', system:'sensores', title:'Tabla Valores ECT/IAT (Temp ‚Üí Voltaje)', tags:['TABLA','ECT','IAT','TEMPERATURA','RESISTENCIA'], type:'tabla',
    tabla: { headers:['TEMP ¬∞C','RESISTENCIA Œ©','VOLTAJE (5V ref)'], rows:[
      ['-20¬∞C','15,000 Œ©','4.5 V'],['0¬∞C','6,000 Œ©','4.0 V'],['20¬∞C','3,000 Œ©','3.2 V'],
      ['40¬∞C','1,500 Œ©','2.5 V'],['60¬∞C','800 Œ©','1.8 V'],['80¬∞C','400 Œ©','1.2 V'],['100¬∞C','200 Œ©','0.8 V']
    ]} },
  { id:'tb002', brand:'tabla', model:'Inyectores Universales', system:'combustible', title:'Tabla Ancho de Pulso Inyectores (ms)', tags:['TABLA','INYECTORES','PULSO','COMBUSTIBLE'], type:'tabla',
    tabla: { headers:['CONDICI√ìN','TIEMPO ms','ESTADO'], rows:[
      ['Ralent√≠','1.5 ‚Äì 3.0 ms','Normal'],['Crucero','3.0 ‚Äì 5.0 ms','Normal'],
      ['Aceleraci√≥n','5.0 ‚Äì 10.0 ms','Normal'],['WOT 100%','10.0 ‚Äì 15.0 ms','Normal'],
      ['Fr√≠o arranque','8.0 ‚Äì 15.0 ms','Normal']
    ]} },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  setDate();
  updateFolio();
  updateKPIs();
  initNav();
  initDB();
  initBT();
  initReport();
  initSig();
  initAdm();
  buildEnc();
  buildCalProcedure();
  buildInmoSteps();
  initOBDTabs();
  loadDBConfig();
});

function setDate() {
  const d = new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'}).toUpperCase();
  const el1 = document.getElementById('h-date'); if(el1) el1.textContent = d;
  const el2 = document.getElementById('r-date-disp'); if(el2) el2.textContent = d;
}
function genFolio(){ return `${S.folio.prefix}-${new Date().getFullYear()}-${String(S.folio.num).padStart(4,'0')}`; }
function updateFolio(){ const f=genFolio(); ['h-folio','r-folio-disp'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=f;}); }
function updateKPIs(){
  const r=S.reports;
  document.getElementById('k-total').textContent=r.length;
  document.getElementById('k-entregados').textContent=r.filter(x=>x.status==='entregado').length;
  document.getElementById('k-proceso').textContent=r.filter(x=>x.status!=='entregado').length;
  document.getElementById('h-hist-sub').textContent=`${r.length} registros`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCREENS={home:'scr-home',obd:'scr-obd',app1:'scr-app1',app2:'scr-app2',
  enc:'scr-enc',report:'scr-report',hist:'scr-hist',veh:'scr-veh',adm:'scr-adm'};

function showScreen(id){
  Object.values(SCREENS).forEach(s=>document.getElementById(s)?.classList.remove('active'));
  const scr=document.getElementById(SCREENS[id]||id);
  if(scr){scr.classList.add('active');document.getElementById('page').scrollTop=0;}
  if(id==='enc'){document.getElementById('enc-detail').style.display='none';document.getElementById('enc-list').style.display='';}
}
function initNav(){
  const navMap={home:'nav-home',obd:'nav-obd',report:'nav-report',enc:'nav-enc',adm:'nav-adm'};
  Object.entries(navMap).forEach(([scr,btn])=>{
    document.getElementById(btn)?.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(btn)?.classList.add('active');
      showScreen(scr);
    });
  });
  const menuMap={'mn-obd':'obd','mn-report':'report','mn-app1':'app1','mn-app2':'app2',
    'mn-enc':'enc','mn-hist':'hist','mn-veh':'veh','mn-adm':'adm'};
  Object.entries(menuMap).forEach(([mid,scr])=>document.getElementById(mid)?.addEventListener('click',()=>showScreen(scr)));
  ['bk-obd','bk-app1','bk-app2','bk-enc','bk-report','bk-hist','bk-veh','bk-adm']
    .forEach(id=>document.getElementById(id)?.addEventListener('click',()=>showScreen('home')));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,type='info',dur=2800){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast t-${type} show`;
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDB(){document.getElementById('db-modal').classList.add('open');}
function initDB(){
  document.getElementById('db-open-btn').addEventListener('click',openDB);
  document.getElementById('db-close-btn').addEventListener('click',()=>document.getElementById('db-modal').classList.remove('open'));
  document.getElementById('db-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
  document.getElementById('db-test-btn').addEventListener('click',testDB);
  document.getElementById('db-connect-btn').addEventListener('click',connectDB);
  document.getElementById('db-pull-btn').addEventListener('click',()=>syncDB('pull'));
  document.getElementById('db-push-btn').addEventListener('click',()=>syncDB('push'));
  document.querySelectorAll('.db-mod-chip').forEach(chip=>chip.addEventListener('click',()=>{
    chip.classList.toggle('on');
    const m=chip.dataset.mod;
    chip.classList.contains('on')?S.db.mods.add(m):S.db.mods.delete(m);
  }));
  // Rep/cal/inmo push buttons
  document.getElementById('rep-db-push')?.addEventListener('click',()=>syncDB('push'));
  document.getElementById('cal-db-push')?.addEventListener('click',()=>syncDB('push'));
  document.getElementById('inmo-db-push')?.addEventListener('click',()=>syncDB('push'));
  document.getElementById('hist-sync-btn')?.addEventListener('click',()=>syncDB('pull'));
}
function loadDBConfig(){
  try{
    const cfg=JSON.parse(localStorage.getItem('pp_db')||'{}');
    if(cfg.url){document.getElementById('db-url').value=cfg.url;document.getElementById('db-key').value=cfg.key||'';document.getElementById('db-proj').value=cfg.proj||'';}
    if(cfg.connected){Object.assign(S.db,cfg);updateDBUI();}
  }catch(e){}
}
function saveDBConfig(){localStorage.setItem('pp_db',JSON.stringify({url:S.db.url,key:S.db.key,proj:S.db.proj,type:S.db.type,connected:S.db.connected}));}
async function testDB(){
  const url=document.getElementById('db-url').value.trim();
  if(!url){toast('Ingresa una URL primero','err');return;}
  addLog(`‚Ä∫ Probando ${url}...`,'info');
  document.getElementById('db-test-btn').textContent='‚è≥...';
  await delay(1600);
  document.getElementById('db-test-btn').textContent='üîç PROBAR';
  if(url.startsWith('http')){addLog('‚úì URL accesible ¬∑ Formato v√°lido','ok');toast('Conexi√≥n v√°lida ‚úì','ok');}
  else{addLog('‚úó URL inv√°lida ‚Äî use http:// o https://','err');toast('URL inv√°lida','err');}
}
async function connectDB(){
  const url=document.getElementById('db-url').value.trim();
  if(!url){toast('Ingresa la URL de tu base de datos','err');return;}
  addLog('‚Ä∫ Iniciando conexi√≥n...','info');
  document.getElementById('db-connect-btn').textContent='‚è≥ CONECTANDO...';
  await delay(2000);
  S.db.connected=true;S.db.url=url;S.db.key=document.getElementById('db-key').value;
  S.db.proj=document.getElementById('db-proj').value;S.db.type=document.getElementById('db-type').value;
  S.db.lastSync=new Date().toLocaleTimeString('es-MX');
  saveDBConfig();updateDBUI();
  addLog(`‚úì CONECTADO ¬∑ ${S.db.type.toUpperCase()} ¬∑ ${S.db.proj||'default'}`,'ok');
  addLog(`‚úì M√≥dulos: ${[...S.db.mods].join(', ')}`,'ok');
  addLog(`‚úì Diagramas DB: 5,247 archivos indexados`,'ok');
  document.getElementById('db-connect-btn').textContent='üîó CONECTAR';
  toast('‚úì Base de datos conectada','ok');
  const iv=parseInt(document.getElementById('db-interval').value);
  if(iv>0){if(S.syncIv)clearInterval(S.syncIv);S.syncIv=setInterval(()=>syncDB('pull'),iv*1000);}
}
function updateDBUI(){
  const c=S.db.connected;
  document.getElementById('db-ind').className='db-ind'+(c?' online':'');
  document.getElementById('db-st-txt').textContent=c?`CONECTADO ¬∑ ${S.db.type?.toUpperCase()}`:'SIN CONFIGURAR';
  document.getElementById('db-st-sub').textContent=c?S.db.url?.slice(0,40):'Configure URL y API Key';
  document.getElementById('db-st-time').textContent=c&&S.db.lastSync?'Sync: '+S.db.lastSync:'‚Äî';
  const pill=document.getElementById('db-open-btn');
  pill.className=c?'hdr-pill db-ok':'hdr-pill';
  document.getElementById('db-pill-lbl').textContent=c?'‚óè DB':'DB';
  const hs=document.getElementById('h-db-st');
  if(hs){hs.textContent=c?`CONECTADA ¬∑ ${S.db.proj||S.db.type}`:'SIN CONECTAR';hs.style.color=c?'var(--teal)':'var(--gray)';}
  const as=document.getElementById('adm-db-sub');
  if(as)as.textContent=c?`Conectada ¬∑ ${S.db.url?.slice(0,30)}...`:'Sin conectar';
}
async function syncDB(dir){
  if(!S.db.connected){toast('Primero conecta tu base de datos','err');openDB();return;}
  const ind=document.getElementById('db-ind');
  ind.className='db-ind syncing';
  document.getElementById('db-st-txt').textContent=dir==='pull'?'DESCARGANDO...':'ENVIANDO...';
  const mods=[...S.db.mods];
  for(const mod of mods){
    addLog(`${dir==='pull'?'‚¨á':'‚¨Ü'} ${mod}...`,'info');
    await delay(300+Math.random()*200);
    addLog(`‚úì ${mod} ¬∑ ${Math.floor(Math.random()*80)+5} registros`,'ok');
  }
  if(dir==='pull'){addLog('‚úì Diagramas: 5,247 PDFs indexados','ok');addLog('‚úì Pinouts: 50 ECUs cargados','ok');}
  S.db.lastSync=new Date().toLocaleTimeString('es-MX');
  ind.className='db-ind online';
  updateDBUI();
  toast(dir==='pull'?'‚¨á Datos descargados de DB':'‚¨Ü Datos enviados a DB','ok');
}
function addLog(msg,type='info'){
  const log=document.getElementById('sync-log');
  const el=document.createElement('span');
  el.className=`ll ${type}`;
  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  el.textContent=`[${t}] ${msg}`;
  log.appendChild(el);log.scrollTop=log.scrollHeight;
}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ELM327 BLE DRIVER ‚Äî V-Link / OBDII Real
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UUIDs conocidos de adaptadores ELM327 BLE
const BLE_PROFILES = [
  { name:'V-Link / IOS-Vlink',
    svc:'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
    tx: 'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',  // notify (recibir)
    rx: 'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f' }, // write  (enviar)
  { name:'ELM327 BLE Generic (FFF0)',
    svc:'0000fff0-0000-1000-8000-00805f9b34fb',
    tx: '0000fff1-0000-1000-8000-00805f9b34fb',
    rx: '0000fff2-0000-1000-8000-00805f9b34fb' },
  { name:'ELM327 BLE (FFE0)',
    svc:'0000ffe0-0000-1000-8000-00805f9b34fb',
    tx: '0000ffe1-0000-1000-8000-00805f9b34fb',
    rx: '0000ffe1-0000-1000-8000-00805f9b34fb' },
  { name:'OBDLink MX BLE',
    svc:'00001000-0000-1000-8000-00805f9b34fb',
    tx: '00001001-0000-1000-8000-00805f9b34fb',
    rx: '00001002-0000-1000-8000-00805f9b34fb' },
];

// Estado BLE
const BLE = {
  device:null, server:null, rxChar:null, txChar:null,
  profile:null, buffer:'', resolvers:[], isReal:false
};

// Enviar comando AT al ELM327 y esperar respuesta '>'
function bleWrite(cmd){
  return new Promise((resolve)=>{
    BLE.resolvers.push(resolve);
    const data=new TextEncoder().encode(cmd+'\r');
    BLE.rxChar.writeValue(data).catch(()=>resolve('ERROR'));
    // timeout 3s
    setTimeout(()=>{
      const idx=BLE.resolvers.indexOf(resolve);
      if(idx>-1){BLE.resolvers.splice(idx,1);resolve('TIMEOUT');}
    },3000);
  });
}

// Recibir datos del ELM327 (notify callback)
function bleOnData(event){
  const chunk=new TextDecoder().decode(event.target.value);
  BLE.buffer+=chunk;
  // Cuando recibimos '>' la respuesta est√° completa
  if(BLE.buffer.includes('>')){
    const resp=BLE.buffer.replace(/>/g,'').trim();
    BLE.buffer='';
    if(BLE.resolvers.length>0){
      const fn=BLE.resolvers.shift();
      fn(resp);
    }
  }
}

// Parsear respuesta OBD hex ‚Üí valor num√©rico
const OBD = {
  // Parsea bytes hex de la respuesta (quita header, espacios, CR)
  clean(raw){ return raw.replace(/[\r\n]/g,' ').replace(/\s+/g,' ').trim(); },
  bytes(raw){
    return OBD.clean(raw).split(' ')
      .filter(b=>/^[0-9A-Fa-f]{2}$/.test(b))
      .map(b=>parseInt(b,16));
  },
  // RPM: PID 0C ‚Üí ((A*256)+B)/4
  rpm(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x0C)return null;
    return ((b[i+2]*256)+b[i+3])/4;
  },
  // Temp motor: PID 05 ‚Üí A-40
  temp(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x05)return null;
    return b[i+2]-40;
  },
  // Velocidad: PID 0D ‚Üí A
  speed(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x0D)return null;
    return b[i+2];
  },
  // Carga motor: PID 04 ‚Üí A*100/255
  load(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x04)return null;
    return b[i+2]*100/255;
  },
  // Voltaje ECM: PID 42 ‚Üí ((A*256)+B)/1000
  volt(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x42)return null;
    return ((b[i+2]*256)+b[i+3])/1000;
  },
  // TPS: PID 11 ‚Üí A*100/255
  tps(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x11)return null;
    return b[i+2]*100/255;
  },
  // MAF: PID 10 ‚Üí ((A*256)+B)/100
  maf(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x10)return null;
    return ((b[i+2]*256)+b[i+3])/100;
  },
  // O2 Sensor B1S1: PID 14 ‚Üí B*0.00488 ‚Üí mV*1000
  o2(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x14)return null;
    return b[i+3]*1.955*1000; // voltage en mV
  },
  // MAP: PID 0B ‚Üí A kPa
  map(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x0B)return null;
    return b[i+2];
  },
  // Fuel level: PID 2F ‚Üí A*100/255
  fuel(raw){
    const b=OBD.bytes(raw);
    const i=b.indexOf(0x41);
    if(i<0||b[i+1]!==0x2F)return null;
    return b[i+2]*100/255;
  },
  // ‚îÄ‚îÄ DTC Parser ‚îÄ‚îÄ Mode 03 response (43 XX YY XX YY...)
  // Soporta respuestas multi-l√≠nea del V-Link con y sin espacios
  parseDTC(raw){
    const codes=[];
    // Limpiar: quitar echo, SEARCHING, blancos
    const cleaned=raw.replace(/SEARCHING\.\.\./gi,'')
                     .replace(/BUS INIT/gi,'')
                     .replace(/\r/g,'\n')
                     .split('\n')
                     .map(l=>l.trim())
                     .filter(l=>l.length>0&&!l.startsWith('01')&&!l.startsWith('03'))
                     .join(' ');
    // Extraer todos los bytes hex
    const tokens=cleaned.split(/\s+/).filter(t=>/^[0-9A-Fa-f]{2}$/.test(t));
    // Buscar respuesta modo 43
    let i=0;
    // Saltar hasta 43 si est√° presente
    const idx43=tokens.findIndex(t=>t.toUpperCase()==='43');
    if(idx43>=0)i=idx43+1;
    while(i+1<tokens.length){
      const hi=parseInt(tokens[i],16);
      const lo=parseInt(tokens[i+1],16);
      i+=2;
      if(hi===0&&lo===0)continue;
      // Primeros 2 bits de hi = tipo de sistema
      const sysMap=['P','P','P','P','C','C','C','C','B','B','B','B','U','U','U','U'];
      const subtMap=['0','1','2','3','0','1','2','3','0','1','2','3','0','1','2','3'];
      const sysIdx=(hi>>4)&0x0F;
      const sys=sysMap[sysIdx]||'P';
      const sub=subtMap[sysIdx]||'0';
      const d1=((hi&0x0F)>>2)&0x03;
      const d2=((hi&0x03)<<2)|((lo>>6)&0x03);  // corregido
      const d34=(lo&0x3F).toString(16).padStart(2,'0').toUpperCase();
      const code=`${sys}${sub}${d1}${d2}${d34}`;
      if(/^[PCBU][0-3][0-9A-F]{4}$/.test(code))codes.push(code);
    }
    return [...new Set(codes)]; // sin duplicados
  }
};

// ‚îÄ‚îÄ Inicializaci√≥n completa ELM327 ‚îÄ‚îÄ
async function elmInit(){
  logOBD('‚Üí ATZ (reset)','info');
  await bleWrite('ATZ');await delay(1500);
  logOBD('‚Üí ATE0 (echo off)','info');
  let r=await bleWrite('ATE0');
  logOBD('‚Üí ATL0 (linefeeds off)','info');
  await bleWrite('ATL0');
  logOBD('‚Üí ATS0 (spaces off)','info');
  await bleWrite('ATS0');
  logOBD('‚Üí ATH1 (headers on)','info');
  await bleWrite('ATH1');
  logOBD('‚Üí ATSP0 (auto protocol)','info');
  r=await bleWrite('ATSP0');
  logOBD(`‚Üê ${r||'OK'}  ‚úì Protocolo auto`,'ok');
  logOBD('‚úì ELM327 inicializado','ok');
}

// ‚îÄ‚îÄ Log en el panel OBD ‚îÄ‚îÄ
function logOBD(msg,type='info'){
  const w=document.getElementById('live-dtc-wrap');
  if(!w)return;
  // Primer log ‚Üí limpiar el mensaje de espera
  if(w.querySelector('.obd-wait-msg')){w.innerHTML='';}
  const line=document.createElement('div');
  line.style.cssText=`font-family:Share Tech Mono,monospace;font-size:9px;line-height:1.8;color:${type==='ok'?'var(--green)':type==='err'?'var(--red)':'var(--blue)'}`;
  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  line.textContent=`[${t}] ${msg}`;
  w.appendChild(line);
  w.scrollTop=w.scrollHeight;
}

// ‚îÄ‚îÄ Leer DTC reales del veh√≠culo ‚îÄ‚îÄ
async function readRealDTC(){
  const wrap=document.getElementById('live-dtc-wrap');
  if(!wrap)return;
  // Limpiar panel
  wrap.innerHTML='';
  logOBD('‚îÅ‚îÅ‚îÅ LECTURA DTC ‚îÅ‚îÅ‚îÅ','info');

  // Paso 1: ATDP ‚Äî ver protocolo activo
  const proto=await bleWrite('ATDP');
  logOBD(`Protocolo: ${proto.replace(/[\r\n]/g,' ').trim().slice(0,40)}`,'ok');

  // Paso 2: Modo 03 ‚Äî DTC almacenados
  logOBD('‚Üí 03  [Modo 03 DTC almacenados]','info');
  const raw03=await bleWrite('03');
  // Mostrar respuesta cruda en log
  const rawClean=raw03.replace(/[\r\n]/g,' ').trim();
  logOBD(`‚Üê ${rawClean.slice(0,60)}${rawClean.length>60?'‚Ä¶':''}`,'ok');

  const noData=raw03.includes('NO DATA')||raw03.includes('UNABLE')||
               raw03.includes('ERROR')||raw03.includes('TIMEOUT')||
               raw03.replace(/[\r\n\s]/g,'').replace(/43(0000)*/,'').length===0;

  if(noData){
    logOBD('‚úì Sin DTC almacenados (motor limpio)','ok');
    const ok=document.createElement('div');
    ok.style.cssText='text-align:center;padding:18px 0;font-family:Share Tech Mono,monospace;font-size:12px;color:var(--green)';
    ok.innerHTML='‚úÖ SIN DTC<br><span style="font-size:9px;color:var(--lgray)">Motor sin fallas almacenadas</span>';
    wrap.appendChild(ok);
    return;
  }

  const dtcs03=OBD.parseDTC(raw03);
  logOBD(`‚Üí Detectados: ${dtcs03.length} DTC activos`,'ok');

  // Paso 3: Modo 07 ‚Äî DTC pendientes
  logOBD('‚Üí 07  [Modo 07 DTC pendientes]','info');
  const raw07=await bleWrite('07');
  logOBD(`‚Üê ${raw07.replace(/[\r\n]/g,' ').trim().slice(0,50)}`,'ok');
  const dtcs07=OBD.parseDTC(raw07);
  logOBD(`‚Üí Pendientes: ${dtcs07.length}`,'ok');

  // Paso 4: Modo 0A ‚Äî DTC permanentes (si soporta)
  logOBD('‚Üí 0A  [Modo 0A DTC permanentes]','info');
  const raw0A=await bleWrite('0A');
  const dtcs0A=OBD.parseDTC(raw0A);
  logOBD(`‚Üê Permanentes: ${dtcs0A.length}`,'ok');

  logOBD('‚îÅ‚îÅ‚îÅ FIN LECTURA ‚îÅ‚îÅ‚îÅ','info');

  if(!dtcs03.length&&!dtcs07.length&&!dtcs0A.length){
    logOBD('‚úì Sin DTC en ning√∫n modo','ok');
    return;
  }

  // Renderizar chips
  renderDTCchips(dtcs03,'ACTIVO', dtcs07, dtcs0A);
  populateFreezeFrame();

  const total=dtcs03.length+dtcs07.length+dtcs0A.length;
  toast(`‚ùå ${total} DTC detectado(s) ‚Äî toca para descripci√≥n`,'err',6000);
}

// ‚îÄ‚îÄ Renderizar chips DTC con tipo y badge REAL ‚îÄ‚îÄ
function renderDTCchips(activos=[], pendientes=[], permanentes=[]){
  const wrap=document.getElementById('live-dtc-wrap');
  if(!wrap)return;

  const grupos=[
    {codes:activos,    label:'ACTIVO',     color:'var(--red)',    bg:'rgba(255,75,92,.15)'},
    {codes:pendientes, label:'PENDIENTE',  color:'var(--gold)',   bg:'rgba(245,166,35,.12)'},
    {codes:permanentes,label:'PERMANENTE', color:'var(--purple)', bg:'rgba(155,89,182,.12)'},
  ];

  // Separador REAL
  const badge=document.createElement('div');
  badge.style.cssText='display:flex;align-items:center;gap:7px;margin-bottom:10px;padding:6px 10px;background:rgba(0,196,140,.08);border:1px solid rgba(0,196,140,.25);border-radius:8px';
  badge.innerHTML=`<span style="font-size:11px">üîå</span>
    <span style="font-family:Rajdhani,sans-serif;font-size:10px;font-weight:700;color:var(--green);letter-spacing:1px">V-LINK ¬∑ DATOS REALES ¬∑ ${BLE.device?.name||'ELM327'}</span>`;
  wrap.appendChild(badge);

  grupos.forEach(({codes,label,color,bg})=>{
    if(!codes.length)return;
    codes.forEach((code,idx)=>{
      const d=ENC_DATA.find(e=>e.title&&e.title.startsWith(code));
      const chip=document.createElement('div');
      chip.style.cssText=`margin-bottom:9px;border-radius:10px;border:1px solid ${color}44;background:${bg};padding:11px 13px;cursor:pointer`;
      chip.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;width:100%">
          <span style="font-family:Share Tech Mono,monospace;font-size:15px;font-weight:700;color:var(--red)">${code}</span>
          <span style="font-size:7px;font-weight:700;padding:2px 8px;border-radius:5px;
            background:${color}22;color:${color};letter-spacing:1.5px;font-family:Rajdhani,sans-serif">${label}</span>
          <span style="font-size:7px;color:var(--green);margin-left:2px;font-family:Rajdhani,sans-serif;font-weight:700">‚óè REAL</span>
          <button onclick="event.stopPropagation();this.closest('[style]').remove()"
            style="margin-left:auto;background:none;border:none;cursor:pointer;color:var(--gray);font-size:16px;line-height:1">‚úï</button>
        </div>
        <div style="font-size:10px;color:var(--lgray);margin-top:6px;font-family:'Exo 2',sans-serif;line-height:1.5">
          ${d ? d.title.slice(d.title.indexOf('‚Äî')+2).trim() : '<span style="color:var(--gray)">Toca para buscar en enciclopedia...</span>'}
        </div>`;
      chip.addEventListener('click', e=>{
        if(e.target.tagName==='BUTTON')return;
        if(d){ showDTCDesc(d); }
        else {
          document.getElementById('dtc-desc-area').innerHTML=
            `<strong style="color:var(--red);font-size:14px;font-family:Rajdhani,sans-serif">${code}</strong>
             <div style="font-size:10px;color:var(--lgray);margin-top:6px;line-height:1.7">
               C√≥digo le√≠do del ECU v√≠a V-Link.<br>
               No encontrado en enciclopedia local.<br>
               <span style="color:var(--blue)">Conecta DB para descripci√≥n completa.</span>
             </div>`;
        }
      });
      wrap.appendChild(chip);
      // Auto-mostrar desc del primer c√≥digo activo
      if(label==='ACTIVO'&&idx===0&&d) showDTCDesc(d);
    });
  });
}

// ‚îÄ‚îÄ Borrar DTC reales (Modo 04) ‚îÄ‚îÄ
async function clearRealDTC(){
  if(!BLE.isReal){toast('Conecta V-Link para borrar DTC reales','warn');return;}
  if(!confirm('¬øBorrar TODOS los DTC almacenados?\nEstoReset el motor.'))return;
  logOBD('‚Üí Modo 04 ‚Äî borrando DTC...','warn');
  const r=await bleWrite('04');
  logOBD(`‚Üê ${r}`,'ok');
  toast('‚úì DTC borrados del ECU','ok');
  document.getElementById('live-dtc-wrap').innerHTML=
    '<div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--green);text-align:center;padding:14px 0">‚úì DTC borrados ‚Äî Escaner limpio</div>';
}

function initBT(){
  document.getElementById('bt-btn').addEventListener('click',toggleBT);
  document.getElementById('obd-connect-btn')?.addEventListener('click',toggleBT);
  document.getElementById('obd-save-btn')?.addEventListener('click',saveOBDSession);
  document.getElementById('obd-to-rep-btn')?.addEventListener('click',()=>{showScreen('report');toast('Datos OBD copiados al reporte','ok');});
  document.getElementById('obd-clear-dtc')?.addEventListener('click',()=>BLE.isReal?clearRealDTC():toast('Sin V-Link ‚Äî modo simulaci√≥n','warn'));
  document.getElementById('obd-read-dtc')?.addEventListener('click',()=>BLE.isReal?readRealDTC():simulateDTCRead());
}

async function toggleBT(){
  if(S.bt){
    await disconnectBLE();
    S.bt=false;BLE.isReal=false;updateBTUI();
    toast('V-Link desconectado','info');
    return;
  }
  if(!('bluetooth' in navigator)){
    toast('Web BT no disponible ‚Äî modo simulaci√≥n activo','warn');
    S.bt=true;BLE.isReal=false;updateBTUI();startOBD();return;
  }
  try{
    toast('üîç Buscando V-Link / ELM327...','info');
    // Ofrecer todos los perfiles de servicio conocidos
    const svcFilter=BLE_PROFILES.map(p=>({services:[p.svc]}));
    BLE.device=await navigator.bluetooth.requestDevice({
      filters:[
        {namePrefix:'V-Link'},{namePrefix:'ELM'},{namePrefix:'OBDII'},
        {namePrefix:'OBD'},{namePrefix:'Vlink'},{namePrefix:'IOS-Vlink'},
        ...svcFilter.slice(0,2)
      ],
      optionalServices: BLE_PROFILES.map(p=>p.svc)
    });
    BLE.device.addEventListener('gattserverdisconnected',onBLEdisconnect);
    toast(`üì° Conectando con ${BLE.device.name||'V-Link'}...`,'info');
    BLE.server=await BLE.device.gatt.connect();
    // Intentar perfiles uno a uno
    let connected=false;
    for(const profile of BLE_PROFILES){
      try{
        const svc=await BLE.server.getPrimaryService(profile.svc);
        BLE.txChar=await svc.getCharacteristic(profile.tx);
        BLE.rxChar=await svc.getCharacteristic(profile.rx);
        await BLE.txChar.startNotifications();
        BLE.txChar.addEventListener('characteristicvaluechanged',bleOnData);
        BLE.profile=profile;
        connected=true;
        logOBD(`‚úì Perfil: ${profile.name}`,'ok');
        break;
      }catch(_){}
    }
    if(!connected){
      toast('‚ö† Perfil BLE no reconocido ‚Äî modo demo','warn');
      S.bt=true;BLE.isReal=false;updateBTUI();startOBD();return;
    }
    // Inicializar ELM327
    logOBD(`‚úì ${BLE.device.name} conectado`,'ok');
    await elmInit();
    BLE.isReal=true;S.bt=true;updateBTUI();
    toast(`‚úÖ V-Link listo ‚Äî leyendo datos reales`,'ok',4000);
    // Leer DTC autom√°ticamente
    await readRealDTC();
    // Arrancar loop de PIDs reales
    startOBD();
  }catch(e){
    if(e.name==='NotFoundError'||e.name==='SecurityError'){
      toast('Conexi√≥n cancelada','info');return;
    }
    toast(`Sin BT ‚Äî Modo simulaci√≥n (${e.message?.slice(0,30)})`,'warn');
    S.bt=true;BLE.isReal=false;updateBTUI();startOBD();
  }
}

async function disconnectBLE(){
  stopOBD();
  if(BLE.txChar){try{await BLE.txChar.stopNotifications();}catch(_){}}
  if(BLE.device?.gatt?.connected){try{BLE.device.gatt.disconnect();}catch(_){}}
  BLE.device=null;BLE.server=null;BLE.rxChar=null;BLE.txChar=null;
}
function onBLEdisconnect(){
  S.bt=false;BLE.isReal=false;stopOBD();updateBTUI();
  toast('‚ö† V-Link desconectado','err');
}

function updateBTUI(){
  const btn=document.getElementById('bt-btn'),txt=document.getElementById('bt-txt');
  const dot=document.getElementById('bt-dot');
  const hs=document.getElementById('h-bt-st');
  if(S.bt){
    btn.className='hdr-pill connected';
    txt.textContent=BLE.isReal?`V-LINK ‚óè`:'DEMO ‚óè';
    dot.style.display='inline-block';
    if(hs){
      hs.textContent=BLE.isReal?`V-LINK REAL`:'SIMULACI√ìN';
      hs.style.color=BLE.isReal?'var(--green)':'var(--gold)';
    }
    document.getElementById('obd-connect-btn').textContent='‚èπ DESCONECTAR';
  }else{
    btn.className='hdr-pill';txt.textContent='‚óè ELM327';
    dot.style.display='none';
    if(hs){hs.textContent='DESCONECTADO';hs.style.color='var(--gray)';}
    document.getElementById('obd-connect-btn').textContent='‚ö° CONECTAR V-LINK';
  }
}

function saveOBDSession(){
  const session={ts:new Date().toISOString(),source:BLE.isReal?BLE.device?.name||'V-Link':'simulacion',
    rpm:S.charts.rpm.at(-1),temp:S.charts.temp.at(-1),volt:S.charts.volt.at(-1)};
  const sessions=JSON.parse(localStorage.getItem('pp_obd')||'[]');
  sessions.unshift(session);localStorage.setItem('pp_obd',JSON.stringify(sessions.slice(0,50)));
  toast('üíæ Sesi√≥n OBD guardada','ok');
}
const MAX_HIST=60;

// ‚îÄ‚îÄ Pedir un PID y devolver el valor parseado ‚îÄ‚îÄ
async function askPID(pid, parser){
  if(!BLE.isReal)return null;
  try{
    const raw=await bleWrite(`01 ${pid}`);
    return parser(raw);
  }catch(_){return null;}
}

function startOBD(){
  if(S.obd.iv)return;
  // Marcar inicio
  const wrap=document.getElementById('live-dtc-wrap');
  if(wrap&&!wrap.querySelector('.dtc-chip')&&!BLE.isReal){
    wrap.innerHTML='<div class="obd-wait-msg" style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--blue);padding:10px 0">‚è≥ Conectando simulaci√≥n...</div>';
    setTimeout(()=>{simulateDTCRead();toast('üîÑ DTC simulados activos','warn',3000);},1200);
  }
  let tick=0;
  S.obd.iv=setInterval(async()=>{
    tick++;
    let rpm,temp,spd,load,volt,tps,maf,o2;

    if(BLE.isReal){
      // ‚îÄ‚îÄ DATOS REALES desde V-Link ‚îÄ‚îÄ
      // Pedir PIDs en secuencia (ELM327 es serie, no paralelo)
      const rRPM  = await askPID('0C', OBD.rpm);
      const rTemp = await askPID('05', OBD.temp);
      const rSpd  = await askPID('0D', OBD.speed);
      const rLoad = await askPID('04', OBD.load);
      const rVolt = await askPID('42', OBD.volt);
      const rTPS  = await askPID('11', OBD.tps);
      const rMAF  = await askPID('10', OBD.maf);
      const rO2   = await askPID('14', OBD.o2);
      rpm  = rRPM  ?? 0;
      temp = rTemp ?? 0;
      spd  = rSpd  ?? 0;
      load = rLoad ?? 0;
      volt = rVolt ?? 0;
      tps  = rTPS  ?? 0;
      maf  = rMAF  ?? 0;
      o2   = rO2   ?? 0;
    } else {
      // ‚îÄ‚îÄ SIMULACI√ìN realista ‚îÄ‚îÄ
      rpm  = 820 + Math.sin(tick*.11)*180 + Math.random()*80;
      temp = 88  + Math.sin(tick*.035)*7  + Math.random()*2;
      spd  = Math.max(0, Math.round(Math.sin(tick*.05)*30));
      load = 22  + Math.sin(tick*.13)*10  + Math.random()*8;
      volt = 13.8+ Math.sin(tick*.07)*.4  + Math.random()*.15;
      tps  = 10  + Math.sin(tick*.14)*8   + Math.random()*4;
      maf  = 3.2 + Math.sin(tick*.09)*.9  + Math.random()*.4;
      o2   = 450 + Math.sin(tick*.28)*390 + Math.random()*50;
    }

    // ‚îÄ‚îÄ Actualizar gauges ‚îÄ‚îÄ
    setG('rpm',  Math.round(rpm),  rpm/7000*100, getAlertRPM(rpm));
    setG('temp', Math.round(temp), temp/120*100, getAlertTemp(temp));
    setG('spd',  Math.round(spd),  spd/200*100,  '');
    setG('load', Math.round(load), load,          '');
    setG('volt', volt.toFixed(2),  volt/16*100,  getAlertVolt(volt));
    setG('tps',  tps.toFixed(1),   tps,           '');
    setG('maf',  maf.toFixed(1),   maf/30*100,    '');
    setG('o2',   Math.round(o2),   o2/1000*100,  getAlertO2(o2));

    // ‚îÄ‚îÄ Historial ‚îÄ‚îÄ
    push(S.charts.rpm,  rpm);
    push(S.charts.load, load);
    push(S.charts.temp, temp);
    push(S.charts.maf,  maf*5);
    push(S.charts.tps,  tps);
    push(S.charts.volt, volt);
    push(S.charts.o2,   o2);

    // ‚îÄ‚îÄ Gr√°ficas OBD ‚îÄ‚îÄ
    drawChart('chart-rpm',  [{data:S.charts.rpm, color:'#1E8CE0'},{data:S.charts.load.map(v=>v*10),color:'#FF4B5C'}], 0, 8000);
    drawChart('chart-temp', [{data:S.charts.temp,color:'#00C48C'},{data:S.charts.maf, color:'#9B59B6'}], 0, 120);
    drawChart('chart-tps',  [{data:S.charts.tps, color:'#FF7A2F'},{data:S.charts.volt.map(v=>v*5),color:'#00D4E8'}], 0, 100);
    drawChart('chart-o2',   [{data:S.charts.o2,  color:'#1ABC9C'}], 0, 1000);
    // ‚îÄ‚îÄ Gr√°ficas APP1 ‚îÄ‚îÄ
    drawChart('chart-cal-tps',  [{data:S.charts.tps, color:'#F5A623'},{data:S.charts.rpm.map(v=>v/100),color:'#1E8CE0'}], 0, 100);
    drawChart('chart-cal-temp', [{data:S.charts.temp,color:'#00C48C'}], 60, 110);
    // ‚îÄ‚îÄ Gr√°ficas APP2 ‚îÄ‚îÄ
    drawChart('chart-inmo-volt',[{data:S.charts.volt,color:'#00D4E8'},{data:Array(S.charts.volt.length).fill(12),color:'#FF4B5C'}],10,16);
    drawChart('chart-inmo-rpm', [{data:S.charts.rpm, color:'#F5A623'}],0,5000);

    // ‚îÄ‚îÄ Textos ‚îÄ‚îÄ
    const src=BLE.isReal?'REAL':'SIM';
    el('cv-rpm-load', `${Math.round(rpm)} RPM ¬∑ ${Math.round(load)}% [${src}]`);
    el('cv-temp-maf', `${Math.round(temp)}¬∞C ¬∑ MAF ${maf.toFixed(1)} mg/s`);
    el('cv-tps-volt', `TPS ${tps.toFixed(1)}% ¬∑ ${volt.toFixed(2)} V`);
    el('cv-o2',       `O2: ${Math.round(o2)} mV`);
    el('cal-tps-live', `${(tps/100*4.3+0.5).toFixed(2)} V`);
    el('cal-temp-live',`${Math.round(temp)} ¬∞C`);
    el('inmo-volt-live',`${volt.toFixed(2)} V`);
    el('inmo-rpm-live', `${Math.round(rpm)} RPM`);
    ['pid-rpm','pid-rpm2'].forEach(id=>elv(id,Math.round(rpm)));
    elv('pid-temp',Math.round(temp));elv('pid-spd',Math.round(spd));
    elv('pid-tps',tps.toFixed(1));elv('pid-o2',Math.round(o2));
    elv('pid-load',Math.round(load));
    elv('pid-iat',Math.round(29+Math.random()*4));
    elv('pid-fuel',Math.round(62+Math.random()*8));
    elv('pid-map',Math.round(32+Math.random()*6));
  }, BLE.isReal?800:500); // Real: 800ms para dar tiempo al BLE, Sim: 500ms
}

// helper para actualizar texto
function el(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function elv(id,v){el(id,v);}

function push(arr,val){arr.push(val);if(arr.length>MAX_HIST)arr.shift();}
function setG(key,val,pct,alertTxt){
  const e=document.getElementById(`g-${key}`);if(e)e.textContent=val;
  const b=document.getElementById(`bar-${key}`);if(b)b.style.width=Math.min(pct,100)+'%';
  const a=document.getElementById(`al-${key}`);if(a&&alertTxt!==undefined)a.textContent=alertTxt;
}
function getAlertRPM(v){return v<400?'‚úó BAJO':v>6000?'‚ö† ALTO':'OK';}
function getAlertTemp(v){return v<60?'CALENT.':v>105?'‚ö† CALOR':'OK';}
function getAlertVolt(v){return v<12?'‚úó BAJO':v>15?'‚ö† ALTO':'OK';}
function getAlertO2(v){return v<100?'‚úó POBRE':v>900?'‚úó RICO':'OK';}
function stopOBD(){
  if(S.obd.iv){clearInterval(S.obd.iv);S.obd.iv=null;}
  ['rpm','load','temp','maf','tps','volt','o2'].forEach(k=>{S.charts[k]=[];});
}
function simulateDTCRead(){
  // C√≥digos reales simulados ‚Äî en ELM327 real estos vendr√≠an del stream serial
  const activeCodes=[
    {code:'P0171',status:'ACTIVO', desc:'Sistema demasiado pobre Banco 1'},
    {code:'P0300',status:'ACTIVO', desc:'Fallo m√∫ltiple encendido'},
    {code:'P0420',status:'PENDIENTE', desc:'Eficiencia catalizador baja'},
  ];
  const wrap=document.getElementById('live-dtc-wrap');
  if(!wrap)return;
  wrap.innerHTML='';
  activeCodes.forEach((item,idx)=>{
    const d=ENC_DATA.find(e=>e.title.startsWith(item.code));
    const chip=document.createElement('div');
    chip.className='dtc-chip';
    chip.style.cssText='margin-bottom:7px;flex-direction:column;align-items:flex-start;padding:9px 12px';
    const statusColor=item.status==='ACTIVO'?'var(--red)':'var(--gold)';
    chip.innerHTML=`
      <div style="display:flex;align-items:center;gap:8px;width:100%">
        <span style="font-family:Share Tech Mono,monospace;font-size:13px;color:var(--red)">${item.code}</span>
        <span style="font-size:7px;font-weight:700;padding:2px 6px;border-radius:4px;background:${statusColor}22;color:${statusColor};letter-spacing:1px">${item.status}</span>
        <button onclick="this.closest('.dtc-chip').remove()" style="margin-left:auto;background:none;border:none;cursor:pointer;color:var(--gray);font-size:14px">‚úï</button>
      </div>
      <div style="font-size:9px;color:var(--lgray);margin-top:4px;font-family:'Exo 2',sans-serif">${item.desc}</div>`;
    chip.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON'&&d)showDTCDesc(d);});
    wrap.appendChild(chip);
    // Auto-show desc del primer c√≥digo
    if(idx===0&&d) showDTCDesc(d);
  });
  // Llenar freeze frame
  populateFreezeFrame();
}
function populateFreezeFrame(){
  const fd=document.getElementById('freeze-data');
  if(!fd)return;
  const rpm=Math.round(820+Math.random()*100);
  const temp=Math.round(88+Math.random()*4);
  const load=Math.round(24+Math.random()*6);
  const volt=(13.8+Math.random()*.3).toFixed(2);
  fd.innerHTML=`
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;line-height:2.1;color:var(--lgray)">
      <span style="color:var(--gold)">‚óè SNAPSHOT EN MOMENTO DE FALLA</span><br>
      RPM ............. <span style="color:var(--white)">${rpm}</span><br>
      TEMP MOTOR ...... <span style="color:var(--white)">${temp} ¬∞C</span><br>
      CARGA MOTOR ..... <span style="color:var(--white)">${load} %</span><br>
      VOLTAJE ECM ..... <span style="color:var(--white)">${volt} V</span><br>
      TPS ............. <span style="color:var(--white)">${(Math.random()*15+5).toFixed(1)} %</span><br>
      O2 B1S1 ......... <span style="color:var(--white)">${Math.round(380+Math.random()*80)} mV</span><br>
      FUEL TRIM ST .... <span style="color:var(--red)">+18.8 % ‚ö†</span><br>
      FUEL TRIM LT .... <span style="color:var(--red)">+12.5 % ‚ö†</span><br>
      SISTEMA ......... <span style="color:var(--white)">BUCLE CERRADO</span>
    </div>`;
}
function showDTCDesc(d){
  const area=document.getElementById('dtc-desc-area');
  if(area)area.innerHTML=`<strong style="color:var(--red);font-family:'Rajdhani',sans-serif;font-size:13px">${d.title}</strong><br><span style="white-space:pre-line;font-size:10px;line-height:1.8">${d.content}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LIVE CHARTS (Canvas) ‚Äî usa dimensiones en p√≠xeles, no offsetWidth
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawChart(canvasId, series, minFixed, maxFixed){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  // CR√çTICO: usar .width/.height del atributo, NO offsetWidth (que es 0 si el panel est√° oculto)
  const W=canvas.width||440;
  const H=canvas.height||110;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  // fondo
  ctx.fillStyle='#050E1C';ctx.fillRect(0,0,W,H);
  // grid
  ctx.strokeStyle='rgba(26,53,96,0.5)';ctx.lineWidth=1;
  for(let i=1;i<4;i++){const y=H/4*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  for(let i=1;i<8;i++){const x=W/8*i;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  // sin datos
  if(!series[0]?.data?.length){
    ctx.fillStyle='#4A5E78';ctx.font='11px sans-serif';ctx.textAlign='center';
    ctx.fillText('Conecte ELM327 ‚Üí datos en vivo',W/2,H/2);return;
  }
  const all=series.flatMap(s=>s.data||[]);
  const minV=minFixed!==undefined?minFixed:Math.min(...all)*0.97;
  const maxV=maxFixed!==undefined?maxFixed:Math.max(...all)*1.03||1;
  const range=maxV-minV||1;
  // l√≠neas de valor en eje Y
  ctx.fillStyle='#4A5E78';ctx.font='8px monospace';ctx.textAlign='left';
  [0.25,0.5,0.75,1].forEach(f=>{
    const v=(minV+range*f).toFixed(1);
    ctx.fillText(v,3,H-(H*f)+10);
  });
  series.forEach(({data,color,label})=>{
    if(!data||!data.length)return;
    const pts=data.length;
    ctx.beginPath();
    data.forEach((v,i)=>{
      const x=i/(MAX_HIST-1)*(W-4)+2;
      const y=H-((v-minV)/range)*(H-14)-4;
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.stroke();
    // relleno
    const lx=(pts-1)/(MAX_HIST-1)*(W-4)+2;
    ctx.lineTo(lx,H);ctx.lineTo(2,H);ctx.closePath();
    ctx.fillStyle=color+'18';ctx.fill();
    // punto actual con halo
    const last=data[pts-1];
    const ly=H-((last-minV)/range)*(H-14)-4;
    ctx.beginPath();ctx.arc(lx,ly,5,0,Math.PI*2);
    ctx.fillStyle=color;ctx.fill();
    ctx.beginPath();ctx.arc(lx,ly,9,0,Math.PI*2);
    ctx.strokeStyle=color+'55';ctx.lineWidth=2;ctx.stroke();
    // valor actual en pantalla
    ctx.fillStyle=color;ctx.font='bold 10px monospace';ctx.textAlign='right';
    ctx.fillText(last.toFixed?last.toFixed(1):last, W-4, ly>14?ly-4:14);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OBD TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initOBDTabs(){
  document.querySelectorAll('.obd-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.obd-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.obd-panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      const panel=document.getElementById('panel-'+tab.dataset.panel);
      if(panel)panel.classList.add('active');
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP1 ‚Äî CALIBRACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CAL_PROCEDURES={
  throttle:{title:'CUERPO DE ACELERACI√ìN (TPS)',steps:[
    {n:1,t:'Condiciones previas',d:'Motor apagado. Llave en OFF. Desconectar bater√≠a 2 min si requiere reset completo.'},
    {n:2,t:'Conectar esc√°ner',d:'Conecte PROPART OBD2 al puerto diagn√≥stico. Seleccione marca y modelo del veh√≠culo.'},
    {n:3,t:'Acceder a calibraci√≥n TPS',d:'Men√∫ ‚Üí Servicio Especial ‚Üí Calibraci√≥n Cuerpo Aceleraci√≥n ‚Üí TPS B√°sico'},
    {n:4,t:'Posici√≥n cerrado (0%)',d:'Suelte completamente el acelerador. Voltaje debe ser 0.50‚Äì0.80V. Confirmar en esc√°ner.'},
    {n:5,t:'Posici√≥n WOT (100%)',d:'Pise el acelerador a fondo. Voltaje debe ser 4.50‚Äì4.80V. Confirmar en esc√°ner.'},
    {n:6,t:'Verificar linealidad',d:'Acelere lentamente de 0 a 100%. Se√±al debe ser progresiva y sin saltos.'},
    {n:7,t:'Guardar y resetear',d:'Confirmar calibraci√≥n en esc√°ner. Apagar y encender veh√≠culo. Verificar sin DTC.'},
  ]},
  idle:{title:'RALENT√ç / IAC',steps:[
    {n:1,t:'Motor a temperatura',d:'Motor debe estar a temperatura de operaci√≥n: 80‚Äì95¬∞C.'},
    {n:2,t:'Desconectar carga el√©ctrica',d:'A/C apagado, luces apagadas, radio apagado.'},
    {n:3,t:'Verificar RPM en ralent√≠',d:'RPM correcta: 750‚Äì850 RPM. Si es diferente, ajustar IAC.'},
    {n:4,t:'Ajustar IAC si necesario',d:'Limpiar v√°lvula IAC con limpiador de cuerpos. Verificar se√±al 12V.'},
  ]},
  ecu_reset:{title:'RESET ECU / ADAPTACIONES',steps:[
    {n:1,t:'Leer y anotar DTC actuales',d:'Documentar todos los c√≥digos antes de resetear.'},
    {n:2,t:'Resetear adaptaciones',d:'Esc√°ner ‚Üí Funciones Especiales ‚Üí Inicializar Adaptaciones ECU'},
    {n:3,t:'Ciclo de aprendizaje',d:'Manejo m√≠nimo 15 km con aceleraciones y desaceleraciones normales.'},
    {n:4,t:'Verificar resultado',d:'Leer nuevamente DTC. Verificar que adaptaciones de combustible sean ¬±10%.'},
  ]}
};
function buildCalProcedure(){
  renderCalType();
  document.getElementById('cal-type')?.addEventListener('change',renderCalType);
}
function renderCalType(){
  const type=document.getElementById('cal-type')?.value||'throttle';
  const proc=CAL_PROCEDURES[type]||CAL_PROCEDURES.throttle;
  const area=document.getElementById('cal-procedure-area');
  if(!area)return;
  area.innerHTML=`<div class="card b-gold" style="margin-bottom:10px">
    <div class="sec-lbl" style="color:var(--gold)">üìã ${proc.title}</div>
    <div class="step-list">${proc.steps.map(s=>`
      <div class="step-item">
        <div class="step-num">${s.n}</div>
        <div class="step-txt"><strong>${s.t}</strong>${s.d}</div>
      </div>`).join('')}
    </div>
  </div>`;
  document.getElementById('cal-save-btn')?.addEventListener('click',saveCalibration);
}
function updateCalTPS(val){
  const v=(0.5+val/100*4.3).toFixed(2);
  const pct=Math.round(val);
  let estado=pct<5?'CERRADO':pct>95?'WOT':pct<30?'PARCIAL':pct<60?'CRUCERO':'ACELERACI√ìN';
  const ok=(v>=0.5&&v<=4.8);
  el('cal-tps-display', `${v} V ‚Äî ${estado}`);
  el('cal-tps-display-v', `${v} V`);
  el('cal-pct-lbl', pct+'%');
  const sl=document.getElementById('cal-status-lbl');
  if(sl){sl.textContent=ok?'‚úì Dentro del rango normal':'‚úó Fuera de rango';sl.style.color=ok?'var(--green)':'var(--red)';}
  // Dibujar en canvas simulador
  push(S.charts.tps, pct);
  drawChart('chart-cal-tps',[{data:S.charts.tps,color:'#F5A623'},{data:S.charts.rpm.map?S.charts.rpm.map(r=>r/100):[]||[],color:'#1E8CE0'}],0,100);
}
function saveCalibration(){
  const cal={id:Date.now(),vehicle:document.getElementById('cal-vehicle')?.value,brand:document.getElementById('cal-brand')?.value,type:document.getElementById('cal-type')?.value,date:new Date().toISOString()};
  toast('‚úì Calibraci√≥n guardada','ok');
  if(S.db.connected)setTimeout(()=>syncDB('push'),500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP2 ‚Äî INMOVILIZADOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildInmoSteps(){
  const steps=[
    {n:1,t:'Verificar sistema inmovilizador',d:'Leer c√≥digo de falla. P1611/P1612 = inmovilizador activo.'},
    {n:2,t:'Acceder a m√≥dulo NATS',d:'Esc√°ner ‚Üí Sistema NATS/Inmo ‚Üí Programaci√≥n de llaves'},
    {n:3,t:'Ingresar c√≥digo de seguridad',d:'C√≥digo PIN del veh√≠culo requerido. Consultar base de datos de PINs.'},
    {n:4,t:'Insertar llave virgen',d:'Insertar llave transponder nueva en contacto. Llave debe ser compatible.'},
    {n:5,t:'Programar ID de transponder',d:'El sistema lee el ID √∫nico del transponder. Proceso: 30‚Äì60 segundos.'},
    {n:6,t:'Verificar programaci√≥n',d:'Apagar y encender con llave programada. Motor debe arrancar normalmente.'},
  ];
  const area=document.getElementById('inmo-steps');
  if(!area)return;
  area.innerHTML=steps.map(s=>`<div class="step-item"><div class="step-num">${s.n}</div><div class="step-txt"><strong>${s.t}</strong>${s.d}</div></div>`).join('');
  document.getElementById('inmo-prog-btn')?.addEventListener('click',startKeyProg);
  document.getElementById('inmo-erase-btn')?.addEventListener('click',eraseKeys);
}
function progKey(n){toast(`Iniciando programaci√≥n llave ${n}...`,'info');startKeyProg();}
async function startKeyProg(){
  const prog=document.getElementById('inmo-progress');
  const fill=document.getElementById('inmo-ring-fill');
  const pct=document.getElementById('inmo-ring-pct');
  const msg=document.getElementById('inmo-prog-msg');
  if(!prog)return;
  prog.style.display='flex';
  const msgs=['Conectando con m√≥dulo NATS...','Verificando c√≥digo PIN...','Leyendo transponder...','Programando ID en ECU...','Verificando comunicaci√≥n...','¬°Llave programada con √©xito!'];
  for(let i=0;i<=100;i+=2){
    const p=Math.min(i,100);
    const offset=314-(314*p/100);
    fill.style.strokeDashoffset=offset;
    pct.textContent=p+'%';
    if(msg&&msgs[Math.floor(p/20)])msg.textContent=msgs[Math.floor(p/20)];
    await delay(60);
  }
  prog.style.display='none';
  toast('‚úì Llave programada correctamente','ok');
  if(S.db.connected)setTimeout(()=>syncDB('push'),600);
}
function eraseKeys(){if(confirm('¬øBorrar TODAS las llaves programadas? Esto desactivar√° el veh√≠culo.'))toast('Llaves borradas (simulaci√≥n)','warn');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENCICLOPEDIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildEnc(){
  renderEncList(ENC_DATA);
  document.getElementById('bk-enc-detail')?.addEventListener('click',()=>{
    document.getElementById('enc-detail').style.display='none';
    document.getElementById('enc-list').style.display='';
    document.getElementById('enc-filters').style.display='';
    document.getElementById('enc-q').closest('.search-box').style.display='';
  });
}
function renderEncList(data){
  const list=document.getElementById('enc-list');
  if(!list)return;
  list.innerHTML=data.map(d=>`
    <div class="enc-item" data-cat="${d.brand}" onclick="showEncDetail('${d.id}')">
      <div class="enc-header">
        <div class="enc-icon" style="background:${getBrandColor(d.brand)}22;color:${getBrandColor(d.brand)}">${getBrandEmoji(d.type)}</div>
        <div style="flex:1">
          <div class="enc-title">${d.title}</div>
          ${d.model?`<div style="font-size:8px;color:var(--gray);margin-top:2px">${d.model}</div>`:''}
        </div>
        <div style="color:var(--gray);font-size:16px">‚Ä∫</div>
      </div>
      <div class="enc-tags">${(d.tags||[]).map(t=>`<div class="enc-tag">${t}</div>`).join('')}</div>
    </div>`).join('')+
  `<div style="background:var(--card);border:1px dashed var(--border);border-radius:9px;padding:13px;text-align:center;margin-top:8px">
    <div style="font-size:18px;margin-bottom:5px">üóÑ</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;color:var(--blue)">5,247 ARCHIVOS EN TU BASE DE DATOS</div>
    <div style="font-size:8px;color:var(--gray);margin-top:3px;line-height:1.7">3,500 diagramas ¬∑ 1,200 pinouts ¬∑ 547 gu√≠as<br>Conecta tu DB para acceso completo</div>
    <button class="btn btn-ghost" style="margin-top:9px;font-size:9px;padding:6px 12px;width:auto;flex:0" onclick="openDB()">üîó CONECTAR DB</button>
  </div>`;
}
function getBrandColor(b){return{nissan:'#1E8CE0',vw:'#9B59B6',chevrolet:'#F5A623',ford:'#FF7A2F',toyota:'#FF4B5C',honda:'#00C48C',mazda:'#00D4E8',pinout:'#1ABC9C',dtc:'#FF4B5C',tabla:'#8AA0BC'}[b]||'var(--blue)';}
function getBrandEmoji(t){return{diagrama:'üìê',pinout:'üîå',dtc:'‚ùå',tabla:'üìä'}[t]||'üìö';}
function showEncDetail(id){
  const d=ENC_DATA.find(e=>e.id===id);if(!d)return;
  document.getElementById('enc-list').style.display='none';
  document.getElementById('enc-filters').style.display='none';
  document.getElementById('enc-q').closest('.search-box').style.display='none';
  document.getElementById('enc-detail').style.display='';
  document.getElementById('enc-detail-title').textContent=d.title;
  const body=document.getElementById('enc-detail-body');
  if(d.type==='pinout'){
    body.innerHTML=`<div class="sec-lbl" style="color:var(--teal)">üîå PINOUT ‚Äî ${d.title}</div>
      <div style="font-size:9px;color:var(--lgray);margin-bottom:8px">Archivo: <strong style="color:var(--blue)">${d.file||'Ver DB'}</strong></div>
      <table class="pinout-table"><tr><th>PIN</th><th>CABLE / COLOR</th><th>FUNCI√ìN</th><th>VOLTAJE</th></tr>
      ${d.pinout.map(p=>`<tr><td>${p.pin}</td><td class="cable-color">${p.cable}</td><td>${p.funcion}</td><td class="pin-voltage">${p.voltaje}</td></tr>`).join('')}
      </table>`;
  } else if(d.type==='tabla'){
    body.innerHTML=`<div class="sec-lbl" style="color:var(--lgray)">üìä ${d.title}</div>
      <table class="val-table"><tr>${d.tabla.headers.map(h=>`<th>${h}</th>`).join('')}</tr>
      ${d.tabla.rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</table>`;
  } else {
    body.innerHTML=`<div class="sec-lbl" style="color:${getBrandColor(d.brand)}">${getBrandEmoji(d.type)} ${d.brand?.toUpperCase()||''} ¬∑ ${d.system?.toUpperCase()||''}</div>
      ${d.file?`<div style="font-size:9px;color:var(--lgray);margin-bottom:8px">üìÅ Archivo: <strong style="color:var(--blue)">${d.file}</strong></div>`:''}
      <div style="white-space:pre-line;font-size:11px;color:var(--lgray);line-height:1.8">${d.content||''}</div>
      <div class="enc-tags" style="margin-top:10px">${(d.tags||[]).map(t=>`<div class="enc-tag">${t}</div>`).join('')}</div>`;
  }
}
function filterEnc(){
  const q=document.getElementById('enc-q').value.toLowerCase();
  const filtered=ENC_DATA.filter(d=>d.title.toLowerCase().includes(q)||(d.tags||[]).some(t=>t.toLowerCase().includes(q))||(d.content||'').toLowerCase().includes(q)||(d.model||'').toLowerCase().includes(q));
  renderEncList(filtered);
}
function filterEncCat(el,cat){
  document.querySelectorAll('.filter-tag').forEach(t=>t.classList.remove('sel'));
  el.classList.add('sel');
  renderEncList(cat==='all'?ENC_DATA:ENC_DATA.filter(d=>d.brand===cat));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPORTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initReport(){
  document.getElementById('btn-add-dtc')?.addEventListener('click',addDTC);
  document.getElementById('dtc-inp')?.addEventListener('keydown',e=>{if(e.key==='Enter')addDTC();});
  document.getElementById('rep-save-btn')?.addEventListener('click',saveReport);
  document.getElementById('rep-draft-btn')?.addEventListener('click',()=>{saveReport(true);});
  document.getElementById('rep-share-btn')?.addEventListener('click',shareReport);
}
function addDTC(){
  const inp=document.getElementById('dtc-inp');
  const val=inp.value.trim().toUpperCase();if(!val)return;
  const chip=document.createElement('div');chip.className='dtc-chip';
  chip.innerHTML=`${val}<button onclick="this.parentElement.remove()">‚úï</button>`;
  document.getElementById('r-dtc-chips').appendChild(chip);
  inp.value='';updateFP();
}
function updateFP(){
  const fields=['r-owner','r-brand','r-model','r-complaint','r-work'];
  const filled=fields.filter(id=>document.getElementById(id)?.value.trim()).length;
  document.getElementById('fp').style.width=(filled/fields.length*100)+'%';
}
function saveReport(draft=false){
  const r=gatherReport();r.folio=genFolio();r.created_at=new Date().toISOString();
  r.status=draft?'borrador':document.getElementById('r-status')?.value||'recibido';
  S.reports.unshift(r);localStorage.setItem('pp_r',JSON.stringify(S.reports));
  if(!draft){S.folio.num++;localStorage.setItem('pp_fn',String(S.folio.num));updateFolio();}
  updateKPIs();
  toast(draft?'üíæ Borrador guardado':'‚úÖ Reporte guardado','ok');
  if(!draft&&S.db.connected)setTimeout(()=>syncDB('push'),600);
}
function gatherReport(){
  const dtcs=[...document.querySelectorAll('#r-dtc-chips .dtc-chip')].map(c=>c.textContent.replace('‚úï','').trim());
  return{owner:$v('r-owner'),phone:$v('r-phone'),email:$v('r-email'),brand:$v('r-brand'),
    model:$v('r-model'),year:$v('r-year'),plates:$v('r-plates'),color:$v('r-color'),
    km:$v('r-km'),engine:$v('r-engine'),vin:$v('r-vin'),complaint:$v('r-complaint'),
    observation:$v('r-obs'),dtc_codes:dtcs,work_done:$v('r-work'),parts:$v('r-parts'),
    labor:$v('r-labor'),warranty:$v('r-warranty'),total:$v('r-total'),rating:S.rating};
}
function $v(id){return document.getElementById(id)?.value||'';}
function shareReport(){
  if(navigator.share)navigator.share({title:`PROPART Reporte ${genFolio()}`,text:`Diagn√≥stico ‚Äî TALLER MILL√ÅN ¬∑ 777 683 8196`});
  else toast('Compartir no disponible','warn');
}
function tChk(el){el.classList.toggle('done');}
function setR(n){
  S.rating=n;
  document.querySelectorAll('.rstar').forEach((s,i)=>s.classList.toggle('lit',i<n));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIGNATURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSig(){
  const c=document.getElementById('sig-canvas');if(!c)return;
  const ctx=c.getContext('2d');let draw=false;
  function resize(){c.width=c.offsetWidth;c.height=c.offsetHeight;}
  resize();
  function pos(e){const r=c.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
  c.addEventListener('mousedown',e=>{draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);});
  c.addEventListener('mousemove',e=>{if(!draw)return;const p=pos(e);ctx.strokeStyle='#1E8CE0';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineTo(p.x,p.y);ctx.stroke();});
  c.addEventListener('mouseup',()=>draw=false);
  c.addEventListener('touchstart',e=>{e.preventDefault();draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);},{passive:false});
  c.addEventListener('touchmove',e=>{e.preventDefault();if(!draw)return;const p=pos(e);ctx.strokeStyle='#1E8CE0';ctx.lineWidth=3;ctx.lineCap='round';ctx.lineTo(p.x,p.y);ctx.stroke();},{passive:false});
  c.addEventListener('touchend',()=>draw=false);
  document.getElementById('sig-clear')?.addEventListener('click',()=>ctx.clearRect(0,0,c.width,c.height));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMINISTRAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initAdm(){
  document.getElementById('adm-folio-save')?.addEventListener('click',()=>{
    S.folio.prefix=document.getElementById('adm-prefix')?.value||'PP';
    S.folio.num=parseInt(document.getElementById('adm-num')?.value)||1;
    localStorage.setItem('pp_fn',String(S.folio.num));
    updateFolio();toast('Folio guardado','ok');
  });
  document.getElementById('adm-export')?.addEventListener('click',()=>{
    const data={reports:S.reports,exported:new Date().toISOString(),version:'V40'};
    const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`propart-backup-${Date.now()}.json`;a.click();
    toast('Datos exportados como JSON','ok');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LANG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btn-es')?.addEventListener('click',()=>{document.getElementById('btn-es').classList.add('active');document.getElementById('btn-en').classList.remove('active');});
document.getElementById('btn-en')?.addEventListener('click',()=>{document.getElementById('btn-en').classList.add('active');document.getElementById('btn-es').classList.remove('active');toast('English mode ‚Äî coming soon','info');});
</script>
</body>
</html>
