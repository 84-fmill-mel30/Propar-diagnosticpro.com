<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="bluetooth=*, microphone=*">
    <title>ProPart Diagnostic Pro - Scanner Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        .voice-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s;
        }
        .voice-btn:hover { transform: scale(1.1); }
        .voice-btn.listening {
            background: linear-gradient(135deg, #f44336, #da190b);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .card h2 { color: #667eea; margin-bottom: 20px; }
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin: 20px 0;
            border-left: 6px solid #667eea;
        }
        .status-box.connected {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        button {
            padding: 16px;
            font-size: 1.05em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f44336, #da190b); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #fb8c00); color: white; }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .sensor-card {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .sensor-card h3 {
            font-size: 0.7em;
            color: #667eea;
            margin-bottom: 6px;
        }
        .sensor-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
            min-height: 35px;
        }
        .sensor-unit {
            font-size: 0.65em;
            color: #666;
            margin-top: 3px;
        }
        
        .graph-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .graph-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .graph-controls label {
            font-weight: bold;
            color: #667eea;
            min-width: 80px;
        }
        .graph-controls select {
            flex: 1;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
        }
        .graph {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 8px;
        }
        
        .dtc-item {
            background: #fff4e6;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #f44336;
        }
        .dtc-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #f44336;
        }
        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75em;
            max-height: 250px;
            overflow-y: auto;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <button class="voice-btn" id="voiceBtn" title="Asistente de voz">üé§</button>
        <h1>‚ö° PROPART DIAGNOSTIC PRO</h1>
        <p>Scanner OBD2 Profesional con Asistente de Voz</p>
        <p style="font-size: 0.9em;">Fernando Mill√°n | 777 683 8196</p>
    </div>

    <div class="container">
        <!-- CONEXI√ìN -->
        <div class="card">
            <h2>üì° Conexi√≥n Bluetooth OBD2</h2>
            <div class="status-box" id="status">üî¥ DESCONECTADO</div>
            
            <button class="btn-primary" id="btnConnect">üîç CONECTAR BLUETOOTH</button>
            <button class="btn-danger hidden" id="btnDisconnect">‚ùå DESCONECTAR</button>
            <button class="btn-warning hidden" id="btnDTC">üìã LEER C√ìDIGOS DTC</button>
            <button class="btn-danger hidden" id="btnClear">üóëÔ∏è BORRAR C√ìDIGOS</button>
            <button class="btn-warning hidden" id="btnExtended" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                üìä MODO EXTENDIDO (12 sensores)
            </button>
            
            <div id="dtcResults" class="hidden">
                <h3 style="color: #ff9800; margin: 20px 0;">üìã C√≥digos de Falla:</h3>
                <div id="dtcList"></div>
            </div>
        </div>

        <!-- SENSORES -->
        <div class="card">
            <h2>üìä Sensores en Tiempo Real (14 Sensores)</h2>
            <div class="sensor-grid">
                <div class="sensor-card"><h3>RPM</h3><div class="sensor-value" id="rpm">----</div></div>
                <div class="sensor-card"><h3>Velocidad</h3><div class="sensor-value" id="speed">----</div><div class="sensor-unit">km/h</div></div>
                <div class="sensor-card"><h3>Temp Motor</h3><div class="sensor-value" id="temp">----</div><div class="sensor-unit">¬∞C</div></div>
                <div class="sensor-card"><h3>Temp Aire</h3><div class="sensor-value" id="iat">----</div><div class="sensor-unit">¬∞C</div></div>
                <div class="sensor-card"><h3>Voltaje</h3><div class="sensor-value" id="voltage">----</div><div class="sensor-unit">V</div></div>
                <div class="sensor-card"><h3>Carga</h3><div class="sensor-value" id="load">----</div><div class="sensor-unit">%</div></div>
                <div class="sensor-card"><h3>TPS</h3><div class="sensor-value" id="tps">----</div><div class="sensor-unit">%</div></div>
                <div class="sensor-card"><h3>APP1</h3><div class="sensor-value" id="app1">----</div><div class="sensor-unit">%</div></div>
                <div class="sensor-card"><h3>APP2</h3><div class="sensor-value" id="app2">----</div><div class="sensor-unit">%</div></div>
                <div class="sensor-card"><h3>MAP</h3><div class="sensor-value" id="map">----</div><div class="sensor-unit">kPa</div></div>
                <div class="sensor-card"><h3>MAF</h3><div class="sensor-value" id="maf">----</div><div class="sensor-unit">g/s</div></div>
                <div class="sensor-card"><h3>O2 Sensor</h3><div class="sensor-value" id="o2">----</div><div class="sensor-unit">V</div></div>
                <div class="sensor-card"><h3>STFT</h3><div class="sensor-value" id="stft">----</div><div class="sensor-unit">%</div></div>
                <div class="sensor-card"><h3>LTFT</h3><div class="sensor-value" id="ltft">----</div><div class="sensor-unit">%</div></div>
            </div>
        </div>

        <!-- GR√ÅFICAS -->
        <div class="card">
            <h2>üìà Gr√°ficas Personalizables</h2>
            
            <div class="graph-section">
                <div class="graph-controls">
                    <label>Gr√°fica 1:</label>
                    <select id="select1" onchange="updateGraphs()">
                        <option value="rpm" selected>RPM</option>
                        <option value="speed">Velocidad</option>
                        <option value="temp">Temperatura Motor</option>
                        <option value="iat">Temperatura Aire</option>
                        <option value="load">Carga Motor</option>
                        <option value="tps">TPS</option>
                        <option value="app1">APP1 (Pedal 1)</option>
                        <option value="app2">APP2 (Pedal 2)</option>
                        <option value="map">MAP</option>
                        <option value="maf">MAF</option>
                        <option value="o2">O2 Sensor</option>
                        <option value="stft">STFT</option>
                        <option value="ltft">LTFT</option>
                        <option value="voltage">Voltaje</option>
                    </select>
                </div>
                <canvas class="graph" id="graph1"></canvas>
            </div>
            
            <div class="graph-section">
                <div class="graph-controls">
                    <label>Gr√°fica 2:</label>
                    <select id="select2" onchange="updateGraphs()">
                        <option value="rpm">RPM</option>
                        <option value="speed">Velocidad</option>
                        <option value="temp" selected>Temperatura Motor</option>
                        <option value="iat">Temperatura Aire</option>
                        <option value="load">Carga Motor</option>
                        <option value="tps">TPS</option>
                        <option value="app1">APP1 (Pedal 1)</option>
                        <option value="app2">APP2 (Pedal 2)</option>
                        <option value="map">MAP</option>
                        <option value="maf">MAF</option>
                        <option value="o2">O2 Sensor</option>
                        <option value="stft">STFT</option>
                        <option value="ltft">LTFT</option>
                        <option value="voltage">Voltaje</option>
                    </select>
                </div>
                <canvas class="graph" id="graph2"></canvas>
            </div>
            
            <div class="graph-section">
                <div class="graph-controls">
                    <label>Gr√°fica 3:</label>
                    <select id="select3" onchange="updateGraphs()">
                        <option value="rpm">RPM</option>
                        <option value="speed">Velocidad</option>
                        <option value="temp">Temperatura Motor</option>
                        <option value="iat">Temperatura Aire</option>
                        <option value="load" selected>Carga Motor</option>
                        <option value="tps">TPS</option>
                        <option value="app1">APP1 (Pedal 1)</option>
                        <option value="app2">APP2 (Pedal 2)</option>
                        <option value="map">MAP</option>
                        <option value="maf">MAF</option>
                        <option value="o2">O2 Sensor</option>
                        <option value="stft">STFT</option>
                        <option value="ltft">LTFT</option>
                        <option value="voltage">Voltaje</option>
                    </select>
                </div>
                <canvas class="graph" id="graph3"></canvas>
            </div>
        </div>

        <!-- LOG -->
        <div class="card">
            <h2>üìù Log de Comunicaci√≥n</h2>
            <div class="log-box" id="logBox"></div>
        </div>
    </div>

    <script>
        const UUIDS = ['000018f0-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
        let device, server, service, writeChar, notifyChar, loop;
        let allDtcData = '';
        let waitingForDTC = false;
        let extendedMode = false;
        
        const sensorData = {
            rpm: [], speed: [], temp: [], iat: [], voltage: [], load: [],
            tps: [], app1: [], app2: [], map: [], maf: [], o2: [], stft: [], ltft: []
        };
        
        const graphConfig = {
            rpm: { max: 7000, color: '#667eea' },
            speed: { max: 200, color: '#2196F3' },
            temp: { max: 120, color: '#f44336' },
            iat: { max: 60, color: '#FF5722' },
            voltage: { max: 16, color: '#FFC107' },
            load: { max: 100, color: '#4CAF50' },
            tps: { max: 100, color: '#9C27B0' },
            app1: { max: 100, color: '#E91E63' },
            app2: { max: 100, color: '#F06292' },
            map: { max: 255, color: '#3F51B5' },
            maf: { max: 100, color: '#00BCD4' },
            o2: { max: 1, color: '#009688' },
            stft: { max: 50, color: '#8BC34A' },
            ltft: { max: 50, color: '#CDDC39' }
        };
        
        const DTC_DB = {
            'P0036':'O2 calentador B1S2 circuito',
            'P0141':'O2 calentador B1S2 falla',
            'P0501':'VSS rango/rendimiento',
            'P0606':'ECM error procesador',
            'P0100':'MAF circuito',
            'P0171':'Sistema muy pobre',
            'P0300':'Fallas encendido',
            'P0420':'Catalizador bajo'
        };

        function log(msg, color='#00ff00') {
            const box = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function drawGraph(canvasId, sensorKey) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const data = sensorData[sensorKey];
            const config = graphConfig[sensorKey];
            
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, w, h);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (h/4)*i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }
            
            if (data.length < 2) return;
            
            ctx.strokeStyle = config.color;
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            
            const points = Math.min(data.length, 50);
            const stepX = w / (points - 1);
            
            for (let i = 0; i < points; i++) {
                const value = data[data.length - points + i] || 0;
                const x = i * stepX;
                const y = h - (value / config.max) * h;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function updateGraphs() {
            drawGraph('graph1', document.getElementById('select1').value);
            drawGraph('graph2', document.getElementById('select2').value);
            drawGraph('graph3', document.getElementById('select3').value);
        }

        // BLUETOOTH
        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                log('üîç Buscando dispositivo...', '#8be9fd');
                document.getElementById('status').textContent = "üîç Buscando...";
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: UUIDS
                });
                
                log(`Conectando: ${device.name}`, '#50fa7b');
                server = await device.gatt.connect();
                
                for (let uuid of UUIDS) {
                    try {
                        service = await server.getPrimaryService(uuid);
                        log('Servicio encontrado', '#50fa7b');
                        break;
                    } catch(e) {}
                }
                
                const chars = await service.getCharacteristics();
                for (let char of chars) {
                    if (char.properties.write) writeChar = char;
                    if (char.properties.notify) notifyChar = char;
                }
                
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                log('Notificaciones activadas', '#50fa7b');
                
                document.getElementById('status').textContent = "‚úÖ CONECTADO";
                document.getElementById('status').classList.add('connected');
                document.getElementById('btnConnect').classList.add('hidden');
                document.getElementById('btnDisconnect').classList.remove('hidden');
                document.getElementById('btnDTC').classList.remove('hidden');
                document.getElementById('btnClear').classList.remove('hidden');
                document.getElementById('btnExtended').classList.remove('hidden');
                
                log('Inicializando ELM327...', '#8be9fd');
                await send("AT Z"); await wait(2000);
                await send("AT E0"); await wait(500);
                await send("AT L0"); await wait(500);
                await send("AT SP0"); await wait(800);
                log('ELM327 listo', '#50fa7b');
                
                startLoop();
                
            } catch(error) {
                log('ERROR: ' + error.message, '#ff5555');
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('btnDisconnect').addEventListener('click', () => {
            if (loop) clearInterval(loop);
            if (device && device.gatt.connected) device.gatt.disconnect();
            document.getElementById('status').textContent = "üî¥ DESCONECTADO";
            document.getElementById('status').classList.remove('connected');
            document.getElementById('btnConnect').classList.remove('hidden');
            document.getElementById('btnDisconnect').classList.add('hidden');
            document.getElementById('btnDTC').classList.add('hidden');
            document.getElementById('btnClear').classList.add('hidden');
            document.getElementById('btnExtended').classList.add('hidden');
            extendedMode = false;
            log('Desconectado', '#ffb86c');
        });

        document.getElementById('btnDTC').addEventListener('click', async () => {
            if (loop) clearInterval(loop);
            allDtcData = '';
            waitingForDTC = true;
            
            document.getElementById('dtcResults').classList.remove('hidden');
            document.getElementById('dtcList').innerHTML = '<p style="text-align:center; padding:30px; font-size:1.2em;">‚è≥ ESCANEANDO C√ìDIGOS DTC...<br><br>Esto puede tardar 15-20 segundos<br>Por favor espera...</p>';
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#8be9fd');
            log('üìã INICIANDO LECTURA DTC PROFUNDA', '#8be9fd');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#8be9fd');
            
            // LIMPIAR BUFFER PRIMERO
            await send("AT AL"); await wait(500);
            
            // Enviar M√öLTIPLES comandos DTC con MUCHO tiempo de espera
            log('Enviando comando 03 (p√°gina 0)...', '#f1fa8c');
            await send("03"); await wait(3500);
            
            log('Enviando comando 03 01 (p√°gina 1)...', '#f1fa8c');
            await send("03 01"); await wait(3500);
            
            log('Enviando comando 03 02 (p√°gina 2)...', '#f1fa8c');
            await send("03 02"); await wait(3500);
            
            log('Enviando comando 03 03 (p√°gina 3)...', '#f1fa8c');
            await send("03 03"); await wait(3500);
            
            log('Enviando comando 03 04 (p√°gina 4)...', '#f1fa8c');
            await send("03 04"); await wait(3500);
            
            log('Enviando comando 03 05 (p√°gina 5)...', '#f1fa8c');
            await send("03 05"); await wait(3500);
            
            // Esperar extra y procesar
            log('Esperando datos finales...', '#f1fa8c');
            setTimeout(() => {
                waitingForDTC = false;
                displayDTC();
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#50fa7b');
                log('‚úÖ LECTURA DTC COMPLETADA', '#50fa7b');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#50fa7b');
                setTimeout(() => startLoop(), 3000);
            }, 2000);
        });

        function displayDTC() {
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#f1fa8c');
            log('üìä PROCESANDO DATOS DTC RECIBIDOS', '#f1fa8c');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#f1fa8c');
            log(`DATOS COMPLETOS (${allDtcData.length} caracteres):`, '#f1fa8c');
            log(allDtcData, '#ffff00');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#f1fa8c');
            
            const codes = new Set();
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê M√âTODO 1: C√≥digos directos (P0141, etc) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            log('üîç M√âTODO 1: Buscando c√≥digos directos...', '#8be9fd');
            const directMatches = allDtcData.match(/[PCBU][0-9A-F]{4}/gi);
            if (directMatches) {
                directMatches.forEach(c => {
                    codes.add(c.toUpperCase());
                    log(`  ‚úì C√≥digo directo encontrado: ${c.toUpperCase()}`, '#50fa7b');
                });
            } else {
                log('  ‚úó No se encontraron c√≥digos directos', '#ffb86c');
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê M√âTODO 2: Respuestas 43 con espacios ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            log('üîç M√âTODO 2: Parseando respuestas 43 XX XX...', '#8be9fd');
            const hexPattern = /43[\s]+((?:[0-9A-F]{2}[\s]*)+)/gi;
            const hexMatches = [...allDtcData.matchAll(hexPattern)];
            
            if (hexMatches.length > 0) {
                hexMatches.forEach((match, idx) => {
                    const hex = match[1].replace(/\s/g, '');
                    log(`  Respuesta 43 #${idx+1}: ${hex}`, '#8be9fd');
                    
                    for (let i = 0; i < hex.length; i += 4) {
                        const chunk = hex.substring(i, i + 4);
                        if (chunk !== '0000' && chunk.length === 4) {
                            const dtc = hexToDTC(chunk);
                            if (dtc) {
                                codes.add(dtc);
                                log(`    ‚úì ${chunk} ‚Üí ${dtc}`, '#50fa7b');
                            }
                        }
                    }
                });
            } else {
                log('  ‚úó No se encontraron respuestas 43', '#ffb86c');
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê M√âTODO 3: Buscar 43 SIN espacios ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            log('üîç M√âTODO 3: Buscando 43 sin espacios...', '#8be9fd');
            const hex43Pattern = /43([0-9A-F]{2,})/gi;
            const hex43Matches = [...allDtcData.matchAll(hex43Pattern)];
            
            if (hex43Matches.length > 0) {
                hex43Matches.forEach((match, idx) => {
                    const hex = match[1];
                    log(`  Respuesta 43 compacta #${idx+1}: ${hex}`, '#8be9fd');
                    
                    for (let i = 0; i < hex.length; i += 4) {
                        const chunk = hex.substring(i, i + 4);
                        if (chunk !== '0000' && chunk.length === 4) {
                            const dtc = hexToDTC(chunk);
                            if (dtc) {
                                codes.add(dtc);
                                log(`    ‚úì ${chunk} ‚Üí ${dtc}`, '#50fa7b');
                            }
                        }
                    }
                });
            } else {
                log('  ‚úó No se encontraron respuestas 43 compactas', '#ffb86c');
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê M√âTODO 4: Buscar CUALQUIER patr√≥n 4 d√≠gitos hex ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            log('üîç M√âTODO 4: Buscando patrones sospechosos...', '#8be9fd');
            const allHexGroups = allDtcData.match(/[0-9A-F]{4}/gi);
            if (allHexGroups) {
                const suspicious = allHexGroups.filter(h => 
                    h !== '0000' && 
                    h !== 'FFFF' && 
                    !h.startsWith('41') &&
                    !h.startsWith('AT')
                );
                suspicious.forEach(h => {
                    const dtc = hexToDTC(h);
                    if (dtc && dtc.match(/^[PCBU][0-9]{4}$/)) {
                        log(`  ? Patr√≥n sospechoso: ${h} ‚Üí ${dtc}`, '#ffb86c');
                    }
                });
            }
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#f1fa8c');
            log(`üìã TOTAL C√ìDIGOS √öNICOS ENCONTRADOS: ${codes.size}`, codes.size > 0 ? '#50fa7b' : '#f44336');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#f1fa8c');
            
            const listEl = document.getElementById('dtcList');
            
            if (codes.size === 0) {
                listEl.innerHTML = `
                    <div style="text-align:center; padding:30px;">
                        <div style="font-size:3em; margin-bottom:15px;">‚ö†Ô∏è</div>
                        <div style="font-size:1.3em; font-weight:bold; color:#f44336; margin-bottom:15px;">
                            NO SE DETECTARON C√ìDIGOS
                        </div>
                        <div style="color:#666; margin-bottom:20px;">
                            El scanner recibi√≥ ${allDtcData.length} caracteres de datos<br>
                            pero no pudo extraer c√≥digos DTC v√°lidos.
                        </div>
                        <div style="background:#fff4e6; padding:15px; border-radius:8px; text-align:left; margin:20px auto; max-width:500px;">
                            <strong>üí° Posibles causas:</strong><br>
                            ‚Ä¢ El veh√≠culo realmente no tiene c√≥digos<br>
                            ‚Ä¢ El scanner necesita m√°s tiempo<br>
                            ‚Ä¢ El protocolo OBD2 es diferente<br>
                            ‚Ä¢ Problema de comunicaci√≥n
                        </div>
                        <button onclick="document.getElementById('btnDTC').click()" 
                                style="padding:12px 24px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1.1em; margin-top:10px;">
                            üîÑ Intentar de Nuevo
                        </button>
                    </div>
                `;
                log('‚ùå RESULTADO: Sin c√≥digos detectados', '#f44336');
            } else {
                Array.from(codes).forEach(code => {
                    log(`  ‚úÖ ${code}`, '#50fa7b');
                });
                
                listEl.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center;">
                        <div style="font-size:1.2em; font-weight:bold; color:#155724;">
                            ‚úÖ ${codes.size} C√ìDIGO${codes.size > 1 ? 'S' : ''} DETECTADO${codes.size > 1 ? 'S' : ''}
                        </div>
                    </div>
                ` + Array.from(codes).map(code => {
                    const desc = DTC_DB[code] || 'C√≥digo gen√©rico OBD2 - Consultar base de datos';
                    return `
                        <div class="dtc-item">
                            <div class="dtc-code">‚ùå ${code}</div>
                            <div style="margin-top:10px; color:#666; font-size:1.05em;">${desc}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function hexToDTC(hex) {
            const d = parseInt(hex[0], 16);
            const prefixes = ['P0','P1','P2','P3','C0','C1','C2','C3','B0','B1','B2','B3','U0','U1','U2','U3'];
            return prefixes[d] + hex.substring(1);
        }

        document.getElementById('btnClear').addEventListener('click', async () => {
            if (confirm('¬øBorrar c√≥digos DTC?')) {
                if (loop) clearInterval(loop);
                log('üóëÔ∏è Borrando c√≥digos...', '#ffb86c');
                await send("04");
                await wait(1000);
                document.getElementById('dtcResults').classList.add('hidden');
                log('‚úÖ C√≥digos borrados', '#50fa7b');
                alert('‚úÖ C√≥digos borrados exitosamente');
                await wait(500);
                startLoop();
            }
        });

        async function send(cmd) {
            if (!writeChar) return;
            await writeChar.writeValue(new TextEncoder().encode(cmd + "\r"));
            log(`TX: ${cmd}`, '#bd93f9');
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleData(event) {
            const value = new TextDecoder().decode(event.target.value).trim();
            if (!value || value === '>') return;
            
            log(`RX: ${value}`, '#f1fa8c');
            
            if (waitingForDTC) {
                allDtcData += value + ' ';
                return;
            }
            
            // Parsear sensores
            try {
                // RPM (PID 0C)
                if (value.includes('41 0C') || value.includes('410C')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/410C([0-9A-F]{4})/i);
                    if (match && match[1].length === 4) {
                        const rpm = Math.round(parseInt(match[1], 16) / 4);
                        document.getElementById('rpm').textContent = rpm;
                        sensorData.rpm.push(rpm);
                        if (sensorData.rpm.length > 50) sensorData.rpm.shift();
                        updateGraphs();
                    }
                }
                
                // Velocidad (PID 0D)
                if (value.includes('41 0D') || value.includes('410D')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/410D([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const speed = parseInt(match[1], 16);
                        document.getElementById('speed').textContent = speed;
                        sensorData.speed.push(speed);
                        if (sensorData.speed.length > 50) sensorData.speed.shift();
                        updateGraphs();
                    }
                }
                
                // Temperatura Motor (PID 05)
                if (value.includes('41 05') || value.includes('4105')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4105([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const temp = parseInt(match[1], 16) - 40;
                        document.getElementById('temp').textContent = temp;
                        sensorData.temp.push(temp);
                        if (sensorData.temp.length > 50) sensorData.temp.shift();
                        updateGraphs();
                    }
                }
                
                // Temperatura Aire (PID 0F)
                if (value.includes('41 0F') || value.includes('410F')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/410F([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const iat = parseInt(match[1], 16) - 40;
                        document.getElementById('iat').textContent = iat;
                        sensorData.iat.push(iat);
                        if (sensorData.iat.length > 50) sensorData.iat.shift();
                        updateGraphs();
                    }
                }
                
                // Voltaje (ATRV)
                if (value.includes('V') && !value.includes('41')) {
                    const match = value.match(/(\d+\.?\d*)/);
                    if (match) {
                        const voltage = parseFloat(match[1]);
                        document.getElementById('voltage').textContent = voltage.toFixed(1);
                        sensorData.voltage.push(voltage);
                        if (sensorData.voltage.length > 50) sensorData.voltage.shift();
                        updateGraphs();
                    }
                }
                
                // Carga (PID 04)
                if (value.includes('41 04') || value.includes('4104')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4104([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const load = Math.round((parseInt(match[1], 16) * 100) / 255);
                        document.getElementById('load').textContent = load;
                        sensorData.load.push(load);
                        if (sensorData.load.length > 50) sensorData.load.shift();
                        updateGraphs();
                    }
                }
                
                // TPS (PID 11)
                if (value.includes('41 11') || value.includes('4111')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4111([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const tps = Math.round((parseInt(match[1], 16) * 100) / 255);
                        document.getElementById('tps').textContent = tps;
                        sensorData.tps.push(tps);
                        if (sensorData.tps.length > 50) sensorData.tps.shift();
                        updateGraphs();
                    }
                }
                
                // MAP (PID 0B)
                if (value.includes('41 0B') || value.includes('410B')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/410B([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const map = parseInt(match[1], 16);
                        document.getElementById('map').textContent = map;
                        sensorData.map.push(map);
                        if (sensorData.map.length > 50) sensorData.map.shift();
                        updateGraphs();
                    }
                }
                
                // MAF (PID 10)
                if (value.includes('41 10') || value.includes('4110')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4110([0-9A-F]{4})/i);
                    if (match && match[1].length === 4) {
                        const maf = parseInt(match[1], 16) / 100;
                        document.getElementById('maf').textContent = maf.toFixed(1);
                        sensorData.maf.push(maf);
                        if (sensorData.maf.length > 50) sensorData.maf.shift();
                        updateGraphs();
                    }
                }
                
                // O2 (PID 14)
                if (value.includes('41 14') || value.includes('4114')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4114([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const o2 = parseInt(match[1], 16) / 200;
                        document.getElementById('o2').textContent = o2.toFixed(2);
                        sensorData.o2.push(o2);
                        if (sensorData.o2.length > 50) sensorData.o2.shift();
                        updateGraphs();
                    }
                }
                
                // STFT (PID 06)
                if (value.includes('41 06') || value.includes('4106')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4106([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const stft = ((parseInt(match[1], 16) - 128) * 100 / 128).toFixed(1);
                        document.getElementById('stft').textContent = stft;
                        sensorData.stft.push(parseFloat(stft));
                        if (sensorData.stft.length > 50) sensorData.stft.shift();
                        updateGraphs();
                    }
                }
                
                // LTFT (PID 07)
                if (value.includes('41 07') || value.includes('4107')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4107([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const ltft = ((parseInt(match[1], 16) - 128) * 100 / 128).toFixed(1);
                        document.getElementById('ltft').textContent = ltft;
                        sensorData.ltft.push(parseFloat(ltft));
                        if (sensorData.ltft.length > 50) sensorData.ltft.shift();
                        updateGraphs();
                    }
                }
                
                // APP1 - Accelerator Pedal Position 1 (PID 49)
                if (value.includes('41 49') || value.includes('4149')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/4149([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const app1 = Math.round((parseInt(match[1], 16) * 100) / 255);
                        document.getElementById('app1').textContent = app1;
                        sensorData.app1.push(app1);
                        if (sensorData.app1.length > 50) sensorData.app1.shift();
                        updateGraphs();
                    }
                }
                
                // APP2 - Accelerator Pedal Position 2 (PID 4A)
                if (value.includes('41 4A') || value.includes('414A')) {
                    const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                    const match = hex.match(/414A([0-9A-F]{2})/i);
                    if (match && match[1].length === 2) {
                        const app2 = Math.round((parseInt(match[1], 16) * 100) / 255);
                        document.getElementById('app2').textContent = app2;
                        sensorData.app2.push(app2);
                        if (sensorData.app2.length > 50) sensorData.app2.shift();
                        updateGraphs();
                    }
                }
            } catch(e) {
                log(`Error parseando: ${e.message}`, '#ff5555');
            }
        }

        function startLoop() {
            if (extendedMode) {
                log('üîÑ MODO EXTENDIDO: Monitoreando 12 sensores (m√°s lento)', '#8be9fd');
                loop = setInterval(async () => {
                    await send("010C"); await wait(800);  // RPM
                    await send("010D"); await wait(800);  // Velocidad
                    await send("0105"); await wait(800);  // Temp Motor
                    await send("010F"); await wait(800);  // Temp Aire
                    await send("0104"); await wait(800);  // Carga
                    await send("0111"); await wait(800);  // TPS
                    await send("010B"); await wait(800);  // MAP
                    await send("0110"); await wait(800);  // MAF
                    await send("0114"); await wait(800);  // O2
                    await send("0106"); await wait(800);  // STFT
                    await send("0107"); await wait(800);  // LTFT
                    await send("ATRV"); await wait(800);  // Voltaje
                }, 12000); // Loop cada 12 segundos (12 sensores √ó 800ms + margen)
            } else {
                log('üîÑ MODO NORMAL: Monitoreando 6 sensores principales', '#8be9fd');
                loop = setInterval(async () => {
                    await send("010C"); await wait(800);  // RPM
                    await send("010D"); await wait(800);  // Velocidad
                    await send("0105"); await wait(800);  // Temp Motor
                    await send("0104"); await wait(800);  // Carga
                    await send("0111"); await wait(800);  // TPS
                    await send("ATRV"); await wait(800);  // Voltaje
                }, 6000); // Loop cada 6 segundos
            }
        }
        
        document.getElementById('btnExtended').addEventListener('click', () => {
            if (loop) clearInterval(loop);
            extendedMode = !extendedMode;
            
            if (extendedMode) {
                document.getElementById('btnExtended').textContent = '‚ö° MODO R√ÅPIDO (6 sensores)';
                document.getElementById('btnExtended').style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                log('‚úÖ Modo extendido activado - 12 sensores', '#50fa7b');
            } else {
                document.getElementById('btnExtended').textContent = 'üìä MODO EXTENDIDO (12 sensores)';
                document.getElementById('btnExtended').style.background = 'linear-gradient(135deg, #9C27B0, #7B1FA2)';
                log('‚úÖ Modo normal activado - 6 sensores', '#50fa7b');
            }
            
            startLoop();
        });

        log('‚úÖ Sistema iniciado - Listo para conectar', '#50fa7b');
    </script>
</body>
</html>
