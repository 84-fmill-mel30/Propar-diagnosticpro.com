<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="bluetooth=*">
    <title>ProPart Diagnostic Pro - Fernando Mill√°n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .card h2 { color: #667eea; margin-bottom: 20px; }
        button {
            padding: 16px;
            font-size: 1.05em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f44336, #da190b); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #fb8c00); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin: 20px 0;
            border-left: 6px solid #667eea;
        }
        .status-box.connected { background: #d4edda; border-left-color: #28a745; color: #155724; }
        .hidden { display: none !important; }
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .sensor-card {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .sensor-card h3 { font-size: 0.7em; color: #667eea; margin-bottom: 6px; }
        .sensor-value { font-size: 1.6em; font-weight: bold; color: #333; }
        
        /* Disclaimer Modal */
        #disclaimerModal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .disclaimer-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        .disclaimer-header {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
        }
        .disclaimer-body {
            padding: 30px;
            line-height: 1.8;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .danger-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- DISCLAIMER MODAL -->
    <div id="disclaimerModal">
        <div class="disclaimer-content">
            <div class="disclaimer-header">
                <h2 style="margin:0; font-size:1.8em;">‚ö†Ô∏è AVISO LEGAL IMPORTANTE</h2>
            </div>
            <div class="disclaimer-body">
                <p style="font-size:1.1em; margin-bottom:20px;"><strong>PROPART DIAGNOSTIC PRO</strong> es una herramienta <strong>INFORMATIVA</strong> de diagn√≥stico automotriz.</p>
                
                <div class="warning-box">
                    <strong>‚ö° IMPORTANTE:</strong>
                    <ul style="margin:10px 0 0 20px;">
                        <li>Solo para t√©cnicos <strong>CAPACITADOS</strong></li>
                        <li>Uso bajo su <strong>PROPIO RIESGO</strong></li>
                        <li>Verifique siempre con manuales oficiales</li>
                    </ul>
                </div>
                
                <div class="danger-box">
                    <strong>üö´ EXENCI√ìN DE RESPONSABILIDAD:</strong>
                    <ul style="margin:10px 0 0 20px;">
                        <li>NO nos hacemos responsables por da√±os a veh√≠culos</li>
                        <li>NO nos hacemos responsables por m√≥dulos quemados</li>
                        <li>NO nos hacemos responsables por diagn√≥sticos incorrectos</li>
                        <li>El usuario asume TODA la responsabilidad</li>
                    </ul>
                </div>
                
                <p style="font-size:0.95em; color:#666; margin-top:20px;">
                    <strong>Fernando Mill√°n - Refaccionaria Mill√°n</strong><br>
                    Esta herramienta es un apoyo al diagn√≥stico profesional.
                </p>
            </div>
            <div style="padding:0 30px 30px 30px; display:flex; gap:10px;">
                <button onclick="window.location.href='about:blank'" style="flex:1; padding:15px; background:#999; color:white; border:none; border-radius:8px; font-size:1.1em; font-weight:bold; cursor:pointer;">
                    ‚ùå NO ACEPTO
                </button>
                <button onclick="acceptDisclaimer()" style="flex:1; padding:15px; background:linear-gradient(135deg, #4CAF50, #45a049); color:white; border:none; border-radius:8px; font-size:1.1em; font-weight:bold; cursor:pointer;">
                    ‚úÖ ACEPTO Y CONTINUAR
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
        <div class="header">
            <h1>‚ö° PROPART DIAGNOSTIC PRO</h1>
            <p>Scanner Profesional OBD2</p>
            <p style="font-size: 0.9em;">Fernando Mill√°n | 777 683 8196</p>
        </div>

        <div class="container">
            <!-- CONEXI√ìN -->
            <div class="card">
                <h2>üì° Conexi√≥n Bluetooth OBD2</h2>
                <div class="status-box" id="status">üî¥ DESCONECTADO</div>
                
                <button class="btn-primary" id="btnConnect">üîç CONECTAR BLUETOOTH</button>
                <button class="btn-danger hidden" id="btnDisconnect">‚ùå DESCONECTAR</button>
                <button class="btn-warning hidden" id="btnDTC">üìã LEER C√ìDIGOS DTC</button>
                <button class="btn-danger hidden" id="btnClear">üóëÔ∏è BORRAR C√ìDIGOS</button>
                <button class="btn-info hidden" id="btnTPS" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                    ‚öôÔ∏è CALIBRAR TPS / CUERPO
                </button>
                <button class="btn-info hidden" id="btnInjectors" style="background: linear-gradient(135deg, #FF5722, #E64A19);">
                    üíâ AJUSTE INYECTORES
                </button>
                
                <div id="dtcResults" class="hidden"></div>
            </div>

            <!-- SENSORES -->
            <div class="card">
                <h2>üìä Sensores en Tiempo Real</h2>
                <div class="sensor-grid">
                    <div class="sensor-card"><h3>RPM</h3><div class="sensor-value" id="rpm">----</div></div>
                    <div class="sensor-card"><h3>Velocidad</h3><div class="sensor-value" id="speed">----</div><div style="font-size:0.65em;">km/h</div></div>
                    <div class="sensor-card"><h3>Temp Motor</h3><div class="sensor-value" id="temp">----</div><div style="font-size:0.65em;">¬∞C</div></div>
                    <div class="sensor-card"><h3>Voltaje</h3><div class="sensor-value" id="voltage">----</div><div style="font-size:0.65em;">V</div></div>
                    <div class="sensor-card"><h3>Carga</h3><div class="sensor-value" id="load">----</div><div style="font-size:0.65em;">%</div></div>
                    <div class="sensor-card"><h3>TPS</h3><div class="sensor-value" id="tps">----</div><div style="font-size:0.65em;">%</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const UUIDS = ['000018f0-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
        let device, server, service, writeChar, notifyChar, loop;
        let allDtcData = '', waitingDTC = false;

        // BASE DE DATOS DTC
        const DTC_DB = {
            'P0030':{d:'O2 Heater B1S1',c:['Calentador quemado','Cable roto','Fusible'],s:['Medir 8-12Œ©','Verificar fusible','Cambiar O2']},
            'P0036':{d:'O2 Heater B1S2',c:['Calentador trasero','Cable roto','Fusible'],s:['Medir resistencia','Verificar voltaje','Cambiar O2']},
            'P0100':{d:'MAF Circuit',c:['MAF sucio','Cable roto','MAF defectuoso'],s:['Limpiar MAF','Revisar cables','Reemplazar MAF']},
            'P0101':{d:'MAF Range',c:['MAF sucio','Fuga vac√≠o','Filtro sucio'],s:['Limpiar MAF','Buscar fugas','Cambiar filtro']},
            'P0120':{d:'TPS Circuit',c:['TPS defectuoso','Pista desgastada','Cable roto'],s:['Medir 0.5V reposo','Verificar 4.5V abierto','Reemplazar TPS']},
            'P0130':{d:'O2 Circuit B1S1',c:['O2 defectuoso','Cable cortado','Fuga escape'],s:['Verificar 0.1-0.9V','Buscar fugas','Reemplazar O2']},
            'P0141':{d:'O2 Heater B1S2',c:['Calentador quemado','Fusible','Rel√©'],s:['Medir 8-12Œ©','Verificar fusible','Cambiar O2']},
            'P0171':{d:'System Too Lean B1',c:['Fuga vac√≠o','MAF sucio','Presi√≥n baja','Inyectores'],s:['Buscar fugas con humo','Limpiar MAF','Medir presi√≥n','Limpiar inyectores']},
            'P0172':{d:'System Too Rich B1',c:['Inyectores goteando','MAF sucio','Presi√≥n alta'],s:['Probar inyectores','Limpiar MAF','Medir presi√≥n']},
            'P0300':{d:'Random Misfire',c:['Buj√≠as gastadas','Bobinas d√©biles','Inyectores sucios'],s:['Cambiar buj√≠as','Probar bobinas','Limpiar inyectores']},
            'P0301':{d:'Misfire Cyl 1',c:['Buj√≠a 1','Bobina 1','Inyector 1'],s:['Cambiar buj√≠a 1','Intercambiar bobina','Test compresi√≥n']},
            'P0302':{d:'Misfire Cyl 2',c:['Buj√≠a 2','Bobina 2','Inyector 2'],s:['Cambiar buj√≠a 2','Intercambiar bobina','Test compresi√≥n']},
            'P0303':{d:'Misfire Cyl 3',c:['Buj√≠a 3','Bobina 3','Inyector 3'],s:['Cambiar buj√≠a 3','Intercambiar bobina','Test compresi√≥n']},
            'P0304':{d:'Misfire Cyl 4',c:['Buj√≠a 4','Bobina 4','Inyector 4'],s:['Cambiar buj√≠a 4','Intercambiar bobina','Test compresi√≥n']},
            'P0335':{d:'CKP Sensor',c:['CKP defectuoso','Cable roto','Reluctor sucio'],s:['Verificar se√±al CKP','Limpiar sensor','Ajustar gap 0.5-1mm']},
            'P0340':{d:'CMP Sensor',c:['CMP defectuoso','Cable da√±ado','Timing incorrecto'],s:['Verificar se√±al','Revisar timing','Reemplazar CMP']},
            'P0420':{d:'Catalyst Low B1',c:['Catalizador deteriorado','O2 trasero malo','Fuga escape'],s:['Probar eficiencia cat','Verificar O2 trasero','Resolver mezcla primero']},
            'P0440':{d:'EVAP System',c:['Tapa gasolina floja','L√≠neas rajadas','V√°lvula purga'],s:['Apretar tapa','Buscar fugas','Probar purga']},
            'P0442':{d:'EVAP Small Leak',c:['Tapa gasolina','Manguera rajada','Conector suelto'],s:['Nueva tapa','Test humo','Apretar conectores']},
            'P0455':{d:'EVAP Large Leak',c:['Tapa perdida','Manguera desconectada','Canister roto'],s:['Verificar tapa','Test humo','Reparar fugas']},
            'P0500':{d:'VSS Circuit',c:['VSS defectuoso','Cable roto','Engrane roto'],s:['Verificar se√±al','Revisar cables','Reemplazar VSS']},
            'P0501':{d:'VSS Range',c:['VSS intermitente','Cable da√±ado','Se√±al err√°tica'],s:['Probar se√±al en movimiento','Revisar conectores','Cambiar VSS']},
            'P0562':{d:'System Voltage Low',c:['Bater√≠a baja','Alternador malo','Cable bater√≠a'],s:['Probar bater√≠a','Test alternador 13.5-14.5V','Revisar cables']},
            'P0606':{d:'ECM Processor Error',c:['ECM defectuoso','Sobrecalentamiento','Agua en ECM'],s:['Verificar ECM seco','Revisar temperatura','Reemplazar ECM']},
            'P0700':{d:'Transmission Control',c:['TCM detect√≥ falla','Sensor transmisi√≥n','Solenoide'],s:['Escanear TCM','Revisar niveles ATF','Probar solenoides']}
        };

        // DISCLAIMER
        function acceptDisclaimer() {
            localStorage.setItem('disclaimerAccepted', 'true');
            document.getElementById('disclaimerModal').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
        }

        window.onload = function() {
            if (localStorage.getItem('disclaimerAccepted') === 'true') {
                acceptDisclaimer();
            }
        };

        // BLUETOOTH
        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: UUIDS
                });
                
                server = await device.gatt.connect();
                
                for (let uuid of UUIDS) {
                    try {
                        service = await server.getPrimaryService(uuid);
                        break;
                    } catch(e) {}
                }
                
                const chars = await service.getCharacteristics();
                for (let char of chars) {
                    if (char.properties.write) writeChar = char;
                    if (char.properties.notify) notifyChar = char;
                }
                
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('status').textContent = "‚úÖ CONECTADO";
                document.getElementById('status').classList.add('connected');
                document.getElementById('btnConnect').classList.add('hidden');
                document.getElementById('btnDisconnect').classList.remove('hidden');
                document.getElementById('btnDTC').classList.remove('hidden');
                document.getElementById('btnClear').classList.remove('hidden');
                document.getElementById('btnTPS').classList.remove('hidden');
                document.getElementById('btnInjectors').classList.remove('hidden');
                
                await send("AT Z"); await wait(2000);
                await send("AT E0"); await wait(500);
                await send("AT SP0"); await wait(800);
                
                startLoop();
                
            } catch(error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('btnDisconnect').addEventListener('click', () => {
            if (loop) clearInterval(loop);
            if (device && device.gatt.connected) device.gatt.disconnect();
            document.getElementById('status').textContent = "üî¥ DESCONECTADO";
            document.getElementById('status').classList.remove('connected');
            document.getElementById('btnConnect').classList.remove('hidden');
            document.getElementById('btnDisconnect').classList.add('hidden');
            document.getElementById('btnDTC').classList.add('hidden');
            document.getElementById('btnClear').classList.add('hidden');
            document.getElementById('btnTPS').classList.add('hidden');
            document.getElementById('btnInjectors').classList.add('hidden');
        });

        document.getElementById('btnDTC').addEventListener('click', async () => {
            if (loop) clearInterval(loop);
            allDtcData = '';
            waitingDTC = true;
            
            document.getElementById('dtcResults').classList.remove('hidden');
            document.getElementById('dtcResults').innerHTML = '<p style="text-align:center; padding:30px;">‚è≥ ESCANEANDO (35 segundos)...</p>';
            
            await send("AT AL"); await wait(500);
            for (let i = 0; i <= 7; i++) {
                await send(i === 0 ? "03" : `03 0${i}`);
                await wait(4000);
            }
            
            setTimeout(() => {
                waitingDTC = false;
                displayDTC();
                setTimeout(() => startLoop(), 3000);
            }, 2000);
        });

        function displayDTC() {
            const codes = new Set();
            
            const directMatches = allDtcData.match(/[PCBU][0-9A-F]{4}/gi);
            if (directMatches) directMatches.forEach(c => codes.add(c.toUpperCase()));
            
            const hexPattern = /43[\s]+((?:[0-9A-F]{2}[\s]*)+)/gi;
            const hexMatches = [...allDtcData.matchAll(hexPattern)];
            
            hexMatches.forEach(match => {
                const hex = match[1].replace(/\s/g, '');
                for (let i = 0; i < hex.length; i += 4) {
                    const chunk = hex.substring(i, i + 4);
                    if (chunk !== '0000' && chunk.length === 4) {
                        const dtc = hexToDTC(chunk);
                        if (dtc) codes.add(dtc);
                    }
                }
            });
            
            const results = document.getElementById('dtcResults');
            
            if (codes.size === 0) {
                results.innerHTML = '<p style="text-align:center; padding:30px; font-size:1.2em;">‚úÖ SIN C√ìDIGOS DE FALLA</p>';
            } else {
                results.innerHTML = `<h3 style="color:#f44336;margin:20px 0;">‚ùå ${codes.size} C√≥digo${codes.size > 1 ? 's' : ''}</h3>` +
                    Array.from(codes).map(code => {
                        const dtc = DTC_DB[code];
                        return `<div style="background:#fff5f5; border-left:5px solid #f44336; border-radius:10px; padding:20px; margin:15px 0;">
                            <div style="font-size:2em; font-weight:bold; color:#f44336;">${code}</div>
                            <div style="font-size:1.1em; margin:10px 0;">${dtc ? dtc.d : 'C√≥digo OBD2 gen√©rico'}</div>
                            ${dtc ? `
                                <div style="margin-top:15px;">
                                    <strong>üîç Causas:</strong><br>
                                    ${dtc.c.map(c => `‚Ä¢ ${c}`).join('<br>')}
                                </div>
                                <div style="margin-top:15px;">
                                    <strong>üîß Soluciones:</strong><br>
                                    ${dtc.s.map(s => `‚Ä¢ ${s}`).join('<br>')}
                                </div>
                            ` : ''}
                        </div>`;
                    }).join('');
            }
        }

        function hexToDTC(hex) {
            const d = parseInt(hex[0], 16);
            const prefixes = ['P0','P1','P2','P3','C0','C1','C2','C3','B0','B1','B2','B3','U0','U1','U2','U3'];
            return prefixes[d] + hex.substring(1);
        }

        document.getElementById('btnClear').addEventListener('click', async () => {
            if (confirm('¬øBorrar c√≥digos DTC?')) {
                if (loop) clearInterval(loop);
                await send("04");
                await wait(1000);
                document.getElementById('dtcResults').classList.add('hidden');
                alert('‚úÖ C√≥digos borrados');
                await wait(500);
                startLoop();
            }
        });

        document.getElementById('btnTPS').addEventListener('click', async () => {
            if (!confirm('‚ö†Ô∏è CALIBRACI√ìN TPS / CUERPO\n\n‚ö° IMPORTANTE:\n1. Motor APAGADO\n2. Llave ON (sin arrancar)\n3. Espera 30 segundos\n4. Arranca motor\n5. Deja calentar 2 minutos\n\n¬øContinuar?')) return;
            
            if (loop) clearInterval(loop);
            
            alert('1Ô∏è‚É£ APAGA el motor completamente');
            await wait(3000);
            alert('2Ô∏è‚É£ Gira llave a ON (sin arrancar)');
            await wait(3000);
            await send("AT Z"); await wait(3000);
            await send("AT WS"); 
            alert('3Ô∏è‚É£ Esperando 30 segundos...');
            await wait(30000);
            alert('4Ô∏è‚É£ ARRANCA el motor AHORA');
            await wait(5000);
            alert('5Ô∏è‚É£ Deja en ralent√≠ 2 minutos.\n\n‚úÖ Calibraci√≥n completa.\nEl motor aprender√° en pr√≥ximos km.');
            
            setTimeout(() => startLoop(), 2000);
        });

        document.getElementById('btnInjectors').addEventListener('click', () => {
            const type = prompt('AJUSTE INYECTORES\n\n1 = Gasolina\n2 = Diesel\n\nEscribe 1 o 2:');
            
            if (type === '1') {
                alert('üíâ INYECTORES GASOLINA\n\nüìä Funciones disponibles:\n‚Ä¢ Leer ancho de pulso\n‚Ä¢ Balance por cilindro\n‚Ä¢ Reset adaptaciones\n\n‚ö†Ô∏è Funci√≥n en desarrollo\nConsulte manual del veh√≠culo');
            } else if (type === '2') {
                alert('üíâ INYECTORES DIESEL\n\nüìä Funciones disponibles:\n‚Ä¢ Codificar inyectores\n‚Ä¢ Ajustar cantidad\n‚Ä¢ Reset adaptaciones\n\n‚ö†Ô∏è Requiere esc√°ner espec√≠fico\nConsulte con distribuidor autorizado');
            }
        });

        async function send(cmd) {
            if (!writeChar) return;
            await writeChar.writeValue(new TextEncoder().encode(cmd + "\r"));
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleData(event) {
            const value = new TextDecoder().decode(event.target.value).trim();
            if (!value || value === '>') return;
            
            if (waitingDTC) {
                allDtcData += value + ' ';
                return;
            }
            
            if (value.includes('41 0C') || value.includes('410C')) {
                const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                const match = hex.match(/410C([0-9A-F]{4})/i);
                if (match && match[1].length === 4) {
                    document.getElementById('rpm').textContent = Math.round(parseInt(match[1], 16) / 4);
                }
            }
            
            if (value.includes('41 0D') || value.includes('410D')) {
                const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                const match = hex.match(/410D([0-9A-F]{2})/i);
                if (match) document.getElementById('speed').textContent = parseInt(match[1], 16);
            }
            
            if (value.includes('41 05') || value.includes('4105')) {
                const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                const match = hex.match(/4105([0-9A-F]{2})/i);
                if (match) document.getElementById('temp').textContent = parseInt(match[1], 16) - 40;
            }
            
            if (value.includes('V') && !value.includes('41')) {
                const match = value.match(/(\d+\.?\d*)/);
                if (match) document.getElementById('voltage').textContent = parseFloat(match[1]).toFixed(1);
            }
            
            if (value.includes('41 04') || value.includes('4104')) {
                const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                const match = hex.match(/4104([0-9A-F]{2})/i);
                if (match) document.getElementById('load').textContent = Math.round((parseInt(match[1], 16) * 100) / 255);
            }
            
            if (value.includes('41 11') || value.includes('4111')) {
                const hex = value.replace(/\s/g, '').replace(/[^0-9A-F]/gi, '');
                const match = hex.match(/4111([0-9A-F]{2})/i);
                if (match) document.getElementById('tps').textContent = Math.round((parseInt(match[1], 16) * 100) / 255);
            }
        }

        function startLoop() {
            loop = setInterval(async () => {
                await send("010C"); await wait(800);
                await send("010D"); await wait(800);
                await send("0105"); await wait(800);
                await send("0104"); await wait(800);
                await send("0111"); await wait(800);
                await send("ATRV"); await wait(800);
            }, 6000);
        }
    </script>
</body>
</html>
