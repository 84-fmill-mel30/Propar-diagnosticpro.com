<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>PROPART PRO V6 ¬∑ DIAGNOSTIC SYSTEM</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Exo+2:wght@300;400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#04090F;--bg2:#07111C;--card:#0A1A2E;--card2:#0D2040;
  --blue:#1E8CE0;--blue2:#0A5FA0;--green:#00C48C;--red:#FF4B5C;
  --gold:#F5A623;--purple:#9B59B6;--cyan:#00D4E8;--orange:#FF7A2F;
  --teal:#1ABC9C;--pink:#E91E8C;--white:#EEF5FF;--lgray:#7A96B4;
  --gray:#3A5270;--border:#182E50;--field:#040C18;--r:11px;
  --diesel:#FF6B2B;--immo:#A855F7;--module:#06B6D4;--hp:#EF4444;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--white);font-family:'Exo 2',sans-serif;
  display:flex;flex-direction:column;max-width:480px;margin:0 auto;
  box-shadow:0 0 80px rgba(0,0,0,.95);position:relative}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(30,140,224,.018) 1px,transparent 1px),
  linear-gradient(90deg,rgba(30,140,224,.018) 1px,transparent 1px);background-size:28px 28px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header{background:linear-gradient(180deg,#030810,#060F1E);
  border-bottom:2px solid var(--blue);padding:7px 11px;
  display:flex;align-items:center;gap:8px;flex-shrink:0;position:relative;z-index:20;
  box-shadow:0 4px 30px rgba(30,140,224,.3)}
.logo-sq{width:36px;height:36px;border-radius:9px;flex-shrink:0;background:linear-gradient(135deg,var(--blue),#063A70);
  display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;
  font-weight:700;font-size:13px;box-shadow:0 0 20px rgba(30,140,224,.6)}
.header-info{flex:1;min-width:0}
.header-info h1{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;line-height:1}
.header-info p{font-size:7.5px;color:var(--blue);letter-spacing:1.2px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.hdr-row{display:flex;gap:3px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.hpill{font-size:7.5px;letter-spacing:.7px;display:flex;align-items:center;gap:3px;cursor:pointer;
  padding:3px 7px;border-radius:5px;background:var(--card);border:1px solid var(--border);
  font-family:'Rajdhani',sans-serif;font-weight:700;transition:all .2s;white-space:nowrap}
.hpill.on{background:rgba(0,196,140,.12);border-color:var(--green);color:var(--green)}
.hpill.db-on{background:rgba(0,212,232,.12);border-color:var(--cyan);color:var(--cyan)}
.hpill:active{transform:scale(.93)}
.dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:currentColor;
  animation:dp 1.4s ease-in-out infinite}
@keyframes dp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.5)}}

/* ‚îÄ‚îÄ PAGE / SCREENS ‚îÄ‚îÄ */
.page{flex:1;overflow-y:auto;overflow-x:hidden;position:relative;z-index:1;scroll-behavior:smooth}
.page::-webkit-scrollbar{width:2px}
.page::-webkit-scrollbar-thumb{background:var(--blue2);border-radius:2px}
.screen{display:none;padding:11px 10px 96px;min-height:100%}
.screen.active{display:block;animation:fin .25s ease}
@keyframes fin{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{flex-shrink:0;background:var(--bg2);border-top:1px solid var(--border);
  display:flex;z-index:20;box-shadow:0 -4px 24px rgba(0,0,0,.7);overflow-x:auto}
.bottom-nav::-webkit-scrollbar{display:none}
.nav-btn{flex:0 0 auto;background:none;border:none;cursor:pointer;padding:6px 12px 5px;
  display:flex;flex-direction:column;align-items:center;gap:1px;transition:all .2s;min-width:60px}
.nav-btn .ni{font-size:16px;line-height:1;transition:filter .2s}
.nav-btn .nl{font-family:'Rajdhani',sans-serif;font-size:6.5px;font-weight:700;
  letter-spacing:.7px;color:var(--gray);transition:color .2s;white-space:nowrap}
.nav-btn.active .nl{color:var(--blue)}
.nav-btn.active .ni{filter:drop-shadow(0 0 5px var(--blue))}

/* ‚îÄ‚îÄ COMMON ‚îÄ‚îÄ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px;margin-bottom:9px}
.card.b-blue{border-color:rgba(30,140,224,.45)}.card.b-red{border-color:rgba(255,75,92,.4)}
.card.b-gold{border-color:rgba(245,166,35,.4)}.card.b-green{border-color:rgba(0,196,140,.4)}
.card.b-purple{border-color:rgba(155,89,182,.4)}.card.b-cyan{border-color:rgba(0,212,232,.4)}
.card.b-orange{border-color:rgba(255,122,47,.4)}.card.b-teal{border-color:rgba(26,188,156,.4)}
.card.b-diesel{border-color:rgba(255,107,43,.4)}.card.b-immo{border-color:rgba(168,85,247,.4)}
.card.b-hp{border-color:rgba(239,68,68,.4)}.card.b-module{border-color:rgba(6,182,212,.4)}
.sec-lbl{font-size:8.5px;letter-spacing:2px;font-weight:700;margin-bottom:8px;text-transform:uppercase;display:flex;align-items:center;gap:5px}
.sec-hdr{display:flex;align-items:center;gap:8px;margin-bottom:11px}
.back-btn{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:4px 9px;
  color:var(--lgray);font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0}
.sec-hdr h2{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;flex:1}
.fg{display:flex;flex-direction:column;gap:8px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:5px}
.field{display:flex;flex-direction:column;gap:3px}
.field label{font-size:7.5px;letter-spacing:1.5px;color:var(--lgray);font-weight:600;text-transform:uppercase}
input,select,textarea{background:var(--field);border:1px solid var(--border);border-radius:7px;
  color:var(--white);font-family:'Exo 2',sans-serif;font-size:12px;padding:8px 10px;outline:none;
  width:100%;transition:border-color .2s}
input:focus,select:focus,textarea:focus{border-color:var(--blue)}
select option{background:#0A1A2E}
textarea{resize:vertical;min-height:55px;line-height:1.5}
.btn{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;
  padding:9px 14px;border-radius:8px;border:none;cursor:pointer;transition:all .2s;
  text-transform:uppercase;flex:1}
.btn-primary{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 4px 14px rgba(30,140,224,.35)}
.btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--lgray)}
.btn-red{color:var(--red)!important;border-color:rgba(255,75,92,.3)!important}
.btn-green{background:rgba(0,196,140,.12);border:1px solid rgba(0,196,140,.3);color:var(--green)}
.btn-gold{background:rgba(245,166,35,.12);border:1px solid rgba(245,166,35,.3);color:var(--gold)}
.btn-purple{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.3);color:var(--immo)}
.btn-diesel{background:rgba(255,107,43,.12);border:1px solid rgba(255,107,43,.3);color:var(--diesel)}
.btn-hp{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:var(--hp)}
.btn-module{background:rgba(6,182,212,.12);border:1px solid rgba(6,182,212,.3);color:var(--module)}
.btn:active{transform:scale(.96)}
.btn-row{display:flex;gap:6px;margin-top:8px}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--card2);border:1px solid var(--border);border-radius:9px;
  padding:9px 16px;font-size:11px;font-family:'Rajdhani',sans-serif;font-weight:700;
  letter-spacing:.8px;z-index:999;opacity:0;transition:all .3s;pointer-events:none;
  white-space:nowrap;max-width:340px;text-align:center}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:var(--green);color:var(--green)}
#toast.err{border-color:var(--red);color:var(--red)}
#toast.warn{border-color:var(--gold);color:var(--gold)}
#toast.info{border-color:var(--blue);color:var(--blue)}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.sys-card{background:linear-gradient(135deg,#0A1828,#071220);border:1px solid rgba(30,140,224,.3);
  border-radius:var(--r);padding:13px;margin-bottom:10px}
.sys-title{font-family:'Rajdhani',sans-serif;font-size:9px;letter-spacing:3px;color:var(--blue);
  font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.sys-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;
  border-bottom:1px solid rgba(24,46,80,.5)}
.sys-row:last-child{border-bottom:none}
.sys-lbl{font-size:8.5px;letter-spacing:1px;color:var(--lgray)}
.sys-val{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:.8px}
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.kpi-box{background:var(--card);border:1px solid var(--border);border-radius:9px;
  padding:9px 5px;text-align:center}
.kpi-val{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;line-height:1}
.kpi-lbl{font-size:7px;color:var(--lgray);letter-spacing:.5px;margin-top:2px;line-height:1.3}
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.menu-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:13px 10px;cursor:pointer;transition:all .2s;text-align:center;position:relative;overflow:hidden}
.menu-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(30,140,224,.04),transparent);pointer-events:none}
.menu-card:active{transform:scale(.97);border-color:var(--blue)}
.menu-icon{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;
  justify-content:center;font-size:20px;margin:0 auto 8px;transition:transform .2s}
.menu-card:active .menu-icon{transform:scale(.9)}
.menu-label{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:2px}
.menu-sub{font-size:8px;color:var(--lgray)}
.menu-badge{position:absolute;top:7px;right:7px;background:var(--red);color:#fff;
  font-size:7px;font-family:'Rajdhani',sans-serif;font-weight:700;padding:1px 5px;border-radius:4px;letter-spacing:.5px}

/* ‚îÄ‚îÄ OBD2 LIVE ‚îÄ‚îÄ */
.obd-tab-bar{display:flex;gap:0;margin-bottom:11px;background:var(--card);border-radius:9px;border:1px solid var(--border);overflow:hidden}
.obd-tab{flex:1;background:none;border:none;padding:8px 4px;font-family:'Rajdhani',sans-serif;
  font-size:9px;font-weight:700;letter-spacing:.8px;color:var(--lgray);cursor:pointer;transition:all .2s;text-align:center}
.obd-tab.active{background:rgba(30,140,224,.2);color:var(--blue)}
.obd-panel{display:none}.obd-panel.active{display:block}
.gauge-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:9px}
.obd-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;position:relative}
.obd-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.obd-unit{font-size:8px;color:var(--lgray);font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:.5px}
.obd-alert{font-size:7.5px;font-weight:700;padding:2px 5px;border-radius:4px;font-family:'Rajdhani',sans-serif;letter-spacing:.5px}
.obd-val{font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:400;line-height:1;margin-bottom:4px}
.obd-label{font-size:7.5px;color:var(--lgray);letter-spacing:.5px;margin-bottom:5px}
.gauge-bar{height:4px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden}
.gauge-fill{height:100%;border-radius:2px;transition:width .4s;background:var(--blue)}
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px;margin-bottom:9px}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.chart-title{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px}
.chart-val{font-family:'Share Tech Mono',monospace;font-size:10px}
.chart-legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}
.legend-item{display:flex;align-items:center;gap:4px;font-size:8px;color:var(--lgray)}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ DTC CHIPS ‚îÄ‚îÄ */
.dtc-log-area{font-family:'Share Tech Mono',monospace;font-size:8.5px;line-height:2;
  max-height:200px;overflow-y:auto;background:var(--field);border-radius:8px;padding:8px 10px}
.dtc-log-area::-webkit-scrollbar{width:2px}
.dtc-log-area::-webkit-scrollbar-thumb{background:var(--blue2)}

/* ‚îÄ‚îÄ VEHICLE FILTER ‚îÄ‚îÄ */
.vf-bar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.vf-chip{padding:5px 10px;border-radius:6px;background:var(--card);border:1px solid var(--border);
  font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.vf-chip.active{background:rgba(30,140,224,.2);border-color:var(--blue);color:var(--blue)}
.search-bar{display:flex;align-items:center;gap:7px;background:var(--field);border:1px solid var(--border);
  border-radius:9px;padding:8px 11px;margin-bottom:10px}
.search-bar input{background:none;border:none;flex:1;font-size:12px;outline:none;padding:0;color:var(--white)}
.result-list{display:flex;flex-direction:column;gap:6px}
.result-item{background:var(--card);border:1px solid var(--border);border-radius:9px;
  padding:11px 13px;cursor:pointer;transition:all .2s}
.result-item:active{border-color:var(--blue)}
.result-title{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700}
.result-sub{font-size:9px;color:var(--lgray);margin-top:3px}
.result-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:5px}
.tag{font-size:7px;padding:2px 6px;border-radius:4px;font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:.5px}

/* ‚îÄ‚îÄ MODULE CARDS ‚îÄ‚îÄ */
.module-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:10px}
.mod-card{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:11px;cursor:pointer;transition:all .2s;position:relative}
.mod-card:active{transform:scale(.97)}
.mod-icon{font-size:22px;margin-bottom:6px}
.mod-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:.8px}
.mod-sub{font-size:8px;color:var(--lgray);margin-top:2px}
.mod-status{position:absolute;top:8px;right:8px;width:7px;height:7px;border-radius:50%;background:var(--gray)}
.mod-status.ok{background:var(--green)}
.mod-status.err{background:var(--red)}
.mod-status.warn{background:var(--gold)}

/* ‚îÄ‚îÄ STEP LIST ‚îÄ‚îÄ */
.step-list{display:flex;flex-direction:column;gap:7px}
.step-item{display:flex;gap:9px;align-items:flex-start;padding:9px 10px;
  background:var(--field);border-radius:8px;border:1px solid var(--border)}
.step-num{width:22px;height:22px;border-radius:50%;background:rgba(30,140,224,.2);
  display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;
  font-size:11px;font-weight:700;color:var(--blue);flex-shrink:0}
.step-num.done{background:rgba(0,196,140,.2);color:var(--green)}
.step-content{flex:1}
.step-title{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;margin-bottom:2px}
.step-desc{font-size:9px;color:var(--lgray);line-height:1.6}
.step-item.active{border-color:var(--blue);background:rgba(30,140,224,.06)}

/* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
.ring-wrap{display:flex;flex-direction:column;align-items:center;padding:16px 0}
.ring-svg{width:100px;height:100px}
.ring-bg{fill:none;stroke:rgba(255,255,255,.06);stroke-width:8}
.ring-fill{fill:none;stroke-width:8;stroke-linecap:round;
  stroke-dasharray:314;stroke-dashoffset:314;transition:stroke-dashoffset .4s;transform-origin:center;transform:rotate(-90deg)}
.ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ring-outer{position:relative;width:100px;height:100px}
.ring-pct{font-family:'Share Tech Mono',monospace;font-size:20px}
.ring-msg{font-size:8px;color:var(--lgray);margin-top:6px;font-family:'Rajdhani',sans-serif;text-align:center}

/* ‚îÄ‚îÄ DB MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:300;display:none;
  align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--bg2);border-radius:18px 18px 0 0;border:1px solid var(--border);
  width:100%;max-width:480px;max-height:88vh;overflow-y:auto;padding:16px 14px 30px}
.modal-sheet::-webkit-scrollbar{width:2px}
.modal-sheet::-webkit-scrollbar-thumb{background:var(--blue2)}
.modal-drag{width:36px;height:3px;background:var(--gray);border-radius:2px;margin:0 auto 14px}
.modal-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;margin-bottom:14px;display:flex;align-items:center;gap:7px}
.db-status-bar{display:flex;align-items:center;gap:8px;padding:9px 12px;
  background:var(--card);border-radius:9px;border:1px solid var(--border);margin-bottom:12px}
.db-ind{width:8px;height:8px;border-radius:50%;background:var(--gray);flex-shrink:0;transition:background .3s}
.db-ind.online{background:var(--green);box-shadow:0 0 8px var(--green)}
.db-ind.syncing{background:var(--gold);animation:dp 1s ease-in-out infinite}
.db-text{flex:1}
.db-st-txt{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:.8px}
.db-st-sub{font-size:8px;color:var(--lgray)}
.sync-log{background:var(--field);border-radius:8px;padding:8px;max-height:120px;
  overflow-y:auto;font-family:'Share Tech Mono',monospace;display:flex;flex-direction:column;gap:1px}
.sync-log::-webkit-scrollbar{width:2px}
.ll{font-size:8px;line-height:1.9}
.ll.ok{color:var(--green)}.ll.err{color:var(--red)}.ll.warn{color:var(--gold)}.ll.info{color:var(--blue)}
.db-mod-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:12px}
.db-mod{background:var(--field);border:1px solid var(--border);border-radius:8px;
  padding:7px 9px;display:flex;align-items:center;gap:6px;cursor:pointer}
.db-mod.on{border-color:rgba(30,140,224,.4)}
.db-mod-ico{font-size:14px;flex-shrink:0}
.db-mod-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:.5px;flex:1}
.db-mod-dot{width:6px;height:6px;border-radius:50%;background:var(--gray);flex-shrink:0}
.db-mod.on .db-mod-dot{background:var(--green)}

/* ‚îÄ‚îÄ CAL / APP1 ‚îÄ‚îÄ */
.cal-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(to right,var(--gold) var(--pct,10%),var(--field) var(--pct,10%));
  border-radius:3px;outline:none;cursor:pointer}
.cal-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;
  border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 8px rgba(245,166,35,.5)}
.cal-val-display{font-family:'Share Tech Mono',monospace;font-size:14px;text-align:center;
  padding:9px;background:var(--field);border-radius:8px;margin-top:7px}
.cal-limits{display:flex;justify-content:space-between;font-size:8px;color:var(--lgray);margin:4px 0}

/* ‚îÄ‚îÄ INJECTION TABLE ‚îÄ‚îÄ */
.inj-table{width:100%;border-collapse:collapse;font-size:9px}
.inj-table th{background:rgba(30,140,224,.1);color:var(--blue);font-family:'Rajdhani',sans-serif;
  font-size:8px;letter-spacing:1px;padding:6px 8px;text-align:left;font-weight:700}
.inj-table td{padding:6px 8px;border-bottom:1px solid rgba(24,46,80,.5);color:var(--lgray);font-family:'Share Tech Mono',monospace}
.inj-table tr:hover td{background:rgba(30,140,224,.05);color:var(--white)}

/* ‚îÄ‚îÄ HP TUNERS MAP ‚îÄ‚îÄ */
.map-grid{display:grid;gap:2px;margin-bottom:10px}
.map-cell{height:22px;border-radius:3px;display:flex;align-items:center;justify-content:center;
  font-family:'Share Tech Mono',monospace;font-size:8px;cursor:pointer;transition:all .15s}
.map-cell:active{transform:scale(1.1)}
.map-cell.selected{outline:2px solid var(--white)}
.map-axis{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--lgray);
  display:flex;align-items:center;justify-content:center;height:22px}

/* ‚îÄ‚îÄ IMMO / KEY ‚îÄ‚îÄ */
.key-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.key-slot{background:var(--field);border:1px solid var(--border);border-radius:9px;
  padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s}
.key-slot.prog{border-color:var(--green);background:rgba(0,196,140,.08)}
.key-slot.busy{border-color:var(--gold);background:rgba(245,166,35,.08)}
.key-slot-ico{font-size:18px;margin-bottom:4px}
.key-slot-lbl{font-family:'Rajdhani',sans-serif;font-size:8px;font-weight:700;letter-spacing:.5px}
.key-slot-st{font-size:7px;color:var(--lgray);margin-top:2px}
.key-slot.prog .key-slot-st{color:var(--green)}

/* ‚îÄ‚îÄ DIAGRAM VIEWER ‚îÄ‚îÄ */
.diag-card{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:11px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.diag-card:active{border-color:var(--cyan)}
.diag-title{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;margin-bottom:4px}
.diag-meta{font-size:8.5px;color:var(--lgray);display:flex;flex-wrap:wrap;gap:8px}
.diag-meta span{display:flex;align-items:center;gap:3px}
.pin-table{width:100%;border-collapse:collapse;font-size:8.5px}
.pin-table th{background:rgba(0,212,232,.08);color:var(--cyan);font-family:'Rajdhani',sans-serif;
  font-size:7.5px;letter-spacing:1px;padding:5px 7px;text-align:left;font-weight:700}
.pin-table td{padding:5px 7px;border-bottom:1px solid rgba(24,46,80,.5);font-family:'Share Tech Mono',monospace;color:var(--lgray)}
.pin-table tr:hover td{background:rgba(0,212,232,.05);color:var(--white)}

/* ‚îÄ‚îÄ TRASDATA / PROGRAMMER ‚îÄ‚îÄ */
.prog-bar-wrap{background:var(--field);border-radius:6px;height:10px;overflow:hidden;margin:8px 0}
.prog-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));
  border-radius:6px;transition:width .3s;width:0}
.prog-status-log{font-family:'Share Tech Mono',monospace;font-size:8.5px;line-height:2;
  max-height:160px;overflow-y:auto;background:var(--field);border-radius:8px;padding:8px}

/* ‚îÄ‚îÄ VEHICLE DB FILTER ‚îÄ‚îÄ */
.year-row{display:flex;gap:4px;overflow-x:auto;padding-bottom:4px;margin-bottom:8px}
.year-row::-webkit-scrollbar{display:none}
.year-chip{flex:0 0 auto;padding:4px 10px;border-radius:5px;background:var(--card);
  border:1px solid var(--border);font-family:'Rajdhani',sans-serif;font-size:9px;
  font-weight:700;cursor:pointer;transition:all .2s;color:var(--lgray)}
.year-chip.active{background:rgba(30,140,224,.2);border-color:var(--blue);color:var(--blue)}
.brand-scroll{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-bottom:8px}
.brand-scroll::-webkit-scrollbar{display:none}
.brand-chip{flex:0 0 auto;padding:5px 11px;border-radius:7px;background:var(--card);
  border:1px solid var(--border);font-family:'Rajdhani',sans-serif;font-size:10px;
  font-weight:700;cursor:pointer;transition:all .2s}
.brand-chip.active{background:rgba(30,140,224,.2);border-color:var(--blue);color:var(--blue)}

/* ‚îÄ‚îÄ LIVE DATA MULTILINE ‚îÄ‚îÄ */
.live-table{width:100%;border-collapse:collapse}
.live-table tr{border-bottom:1px solid rgba(24,46,80,.4)}
.live-table td{padding:5px 7px;font-size:9px}
.live-table .lt-pid{font-family:'Share Tech Mono',monospace;color:var(--lgray);width:70px}
.live-table .lt-name{color:var(--lgray);font-size:8.5px}
.live-table .lt-val{font-family:'Share Tech Mono',monospace;font-weight:700;text-align:right;font-size:11px}
.live-table .lt-bar td{padding:1px 7px 5px}
.lt-gauge{height:3px;background:var(--field);border-radius:2px}
.lt-gauge-fill{height:100%;border-radius:2px;transition:width .4s}

/* ‚îÄ‚îÄ ACCORDION ‚îÄ‚îÄ */
.acc-hdr{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 12px;
  background:var(--card);border:1px solid var(--border);border-radius:9px;margin-bottom:5px}
.acc-hdr.open{border-radius:9px 9px 0 0;border-bottom-color:transparent}
.acc-title{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:.8px}
.acc-arrow{font-size:12px;color:var(--lgray);transition:transform .2s}
.acc-hdr.open .acc-arrow{transform:rotate(180deg)}
.acc-body{display:none;background:var(--card);border:1px solid var(--border);border-top:none;
  border-radius:0 0 9px 9px;padding:11px 12px;margin-bottom:5px}
.acc-hdr.open+.acc-body{display:block}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DB MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="db-modal">
<div class="modal-sheet">
  <div class="modal-drag"></div>
  <div class="modal-title">üóÑ BASE DE DATOS <span style="font-size:8px;color:var(--lgray);font-weight:400">PROPART PRO</span></div>
  <div class="db-status-bar">
    <div class="db-ind" id="db-ind"></div>
    <div class="db-text">
      <div class="db-st-txt" id="db-st-txt">SIN CONFIGURAR</div>
      <div class="db-st-sub" id="db-st-sub">Configura tu endpoint o usa GitHub JSON</div>
    </div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--lgray)" id="db-st-time">‚Äî</div>
  </div>

  <!-- GitHub JSON Auto-Load -->
  <div class="card b-blue" style="margin-bottom:10px">
    <div class="sec-lbl" style="color:var(--blue)">‚ö° GITHUB JSON ‚Äî CARGA AUTOM√ÅTICA</div>
    <div style="font-size:9px;color:var(--lgray);margin-bottom:8px">Tu base de datos p√∫blica se carga directamente</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:8px;background:var(--field);border-radius:6px;padding:8px;color:var(--cyan);word-break:break-all">
      github.com/84-fmill-mel30/base_datos_master.json
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-green" id="gh-load-btn">‚¨á CARGAR DESDE GITHUB</button>
      <button class="btn btn-ghost" id="gh-status-btn">üîç ESTADO</button>
    </div>
    <div id="gh-progress" style="display:none;margin-top:8px">
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="gh-bar"></div></div>
      <div id="gh-msg" style="font-size:8px;color:var(--lgray);text-align:center;margin-top:4px">Cargando...</div>
    </div>
  </div>

  <!-- Custom API -->
  <div class="acc-hdr" id="custom-api-hdr">
    <span class="acc-title">üîó API PERSONALIZADA</span>
    <span class="acc-arrow">‚ñº</span>
  </div>
  <div class="acc-body">
    <div class="fg">
      <div class="field"><label>TIPO DE BASE DE DATOS</label>
        <select id="db-type">
          <option value="rest">REST API (Supabase / PocketBase)</option>
          <option value="firebase">Firebase / Firestore</option>
          <option value="mysql">MySQL / MariaDB (v√≠a proxy)</option>
          <option value="custom">JSON personalizado</option>
        </select>
      </div>
      <div class="field"><label>URL / ENDPOINT</label>
        <input type="url" id="db-url" placeholder="https://tu-api.com/propart" autocapitalize="none"/>
      </div>
      <div class="row2">
        <div class="field"><label>API KEY</label><input type="password" id="db-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        <div class="field"><label>PROYECTO ID</label><input type="text" id="db-proj" placeholder="propart-prod"/></div>
      </div>
      <div class="field"><label>SYNC AUTOM√ÅTICO</label>
        <select id="db-interval">
          <option value="0">Manual</option>
          <option value="60">Cada 1 min</option>
          <option value="300" selected>Cada 5 min</option>
          <option value="900">Cada 15 min</option>
        </select>
      </div>
    </div>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn btn-ghost" id="db-test-btn">üîç PROBAR</button>
      <button class="btn btn-primary" id="db-connect-btn">üîó CONECTAR</button>
    </div>
  </div>

  <!-- Modules -->
  <div class="sec-lbl" style="color:var(--lgray);margin:12px 0 8px">üì¶ M√ìDULOS SINCRONIZADOS</div>
  <div class="db-mod-grid" id="db-mods">
    <div class="db-mod on" data-m="reports"><span class="db-mod-ico">üìã</span><span class="db-mod-lbl">REPORTES</span><span class="db-mod-dot"></span></div>
    <div class="db-mod on" data-m="vehicles"><span class="db-mod-ico">üöó</span><span class="db-mod-lbl">VEH√çCULOS</span><span class="db-mod-dot"></span></div>
    <div class="db-mod on" data-m="diagrams"><span class="db-mod-ico">üìê</span><span class="db-mod-lbl">DIAGRAMAS</span><span class="db-mod-dot"></span></div>
    <div class="db-mod on" data-m="dtc_codes"><span class="db-mod-ico">‚ùå</span><span class="db-mod-lbl">C√ìDIGOS DTC</span><span class="db-mod-dot"></span></div>
    <div class="db-mod on" data-m="pinouts"><span class="db-mod-ico">üîå</span><span class="db-mod-lbl">PINOUTS ECU</span><span class="db-mod-dot"></span></div>
    <div class="db-mod on" data-m="modules"><span class="db-mod-ico">üñ•</span><span class="db-mod-lbl">M√ìDULOS</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="calibrations"><span class="db-mod-ico">‚öô</span><span class="db-mod-lbl">CALIBRACIONES</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="obd_sessions"><span class="db-mod-ico">üìä</span><span class="db-mod-lbl">SESIONES OBD</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="immobilizer"><span class="db-mod-ico">üîê</span><span class="db-mod-lbl">INMOVILIZADOR</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="hp_tuner"><span class="db-mod-ico">üèÅ</span><span class="db-mod-lbl">HP TUNERS</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="trasdata"><span class="db-mod-ico">üíæ</span><span class="db-mod-lbl">TRASDATA</span><span class="db-mod-dot"></span></div>
    <div class="db-mod" data-m="clients"><span class="db-mod-ico">üë§</span><span class="db-mod-lbl">CLIENTES</span><span class="db-mod-dot"></span></div>
  </div>

  <!-- Sync Log -->
  <div class="sync-log" id="sync-log" style="max-height:90px"></div>
  <div class="btn-row" style="margin-top:8px">
    <button class="btn btn-ghost" style="font-size:9px;padding:7px" id="db-pull-btn">‚¨á PULL</button>
    <button class="btn btn-ghost" style="font-size:9px;padding:7px" id="db-push-btn">‚¨Ü PUSH</button>
    <button class="btn btn-ghost" style="font-size:9px;padding:7px;color:var(--red)" id="db-close-btn">‚úï CERRAR</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="app-header">
  <div class="logo-sq">PP</div>
  <div class="header-info">
    <h1>PROPART PRO V6</h1>
    <p id="hdr-sub">TALLER FERNANDO MILL√ÅN ¬∑ 777 683 8196</p>
  </div>
  <div class="header-right">
    <div class="hdr-row">
      <button class="hpill" id="db-open-btn">üóÑ <span id="db-pill-lbl">DB</span></button>
      <button class="hpill" id="bt-btn"><span class="dot" style="display:none" id="bt-dot"></span><span id="bt-txt">ELM327</span></button>
    </div>
    <div class="hdr-row" id="veh-selected-bar" style="display:none">
      <div style="background:rgba(0,196,140,.1);border:1px solid rgba(0,196,140,.25);border-radius:5px;
        padding:2px 8px;font-family:'Rajdhani',sans-serif;font-size:8px;font-weight:700;color:var(--green)" id="veh-selected-lbl">
      </div>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page">

<!-- ‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="scr-home">
  <div class="sys-card">
    <div class="sys-title">‚ö° PROPART PRO V6 ¬∑ ESTADO DEL SISTEMA</div>
    <div class="sys-row"><span class="sys-lbl">LICENCIA</span><span class="sys-val" style="color:var(--green)">‚úì ACTIVA PRO</span></div>
    <div class="sys-row"><span class="sys-lbl">TALLER</span><span class="sys-val">FERNANDO MILL√ÅN ¬∑ 777 683 8196</span></div>
    <div class="sys-row"><span class="sys-lbl">BASE DE DATOS</span><span class="sys-val" id="h-db-st" style="color:var(--gray)">SIN CONECTAR</span></div>
    <div class="sys-row"><span class="sys-lbl">OBD2 / V-LINK</span><span class="sys-val" id="h-bt-st" style="color:var(--gray)">DESCONECTADO</span></div>
    <div class="sys-row"><span class="sys-lbl">VEH√çCULO ACTIVO</span><span class="sys-val" style="color:var(--gold)" id="h-veh">‚Äî</span></div>
    <div class="sys-row"><span class="sys-lbl">REGISTROS DB</span><span class="sys-val" style="color:var(--purple)" id="h-db-count">‚Äî</span></div>
  </div>
  <div class="kpi-row">
    <div class="kpi-box"><div class="kpi-val" style="color:var(--blue)" id="k-total">0</div><div class="kpi-lbl">Total<br>Reportes</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--green)" id="k-ok">0</div><div class="kpi-lbl">Entre-<br>gados</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--gold)" id="k-proc">0</div><div class="kpi-lbl">En<br>Proceso</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--red)" id="k-dtc">0</div><div class="kpi-lbl">DTC<br>Activos</div></div>
  </div>

  <div class="menu-grid">
    <div class="menu-card" id="mn-obd">
      <div class="menu-icon" style="background:rgba(30,140,224,.15)">üîå</div>
      <div class="menu-label" style="color:var(--blue)">SCANNER OBD2</div>
      <div class="menu-sub">V-Link ¬∑ Gr√°ficas en vivo</div>
    </div>
    <div class="menu-card" id="mn-vehdb">
      <div class="menu-icon" style="background:rgba(0,196,140,.15)">üöó</div>
      <div class="menu-label" style="color:var(--green)">VEH√çCULOS DB</div>
      <div class="menu-sub">Filtro marca / modelo / a√±o</div>
    </div>
    <div class="menu-card" id="mn-cal">
      <div class="menu-icon" style="background:rgba(245,166,35,.15)">‚öô</div>
      <div class="menu-label" style="color:var(--gold)">CALIBRACI√ìN</div>
      <div class="menu-sub">TPS ¬∑ MAF ¬∑ Inyectores</div>
    </div>
    <div class="menu-card" id="mn-diesel">
      <div class="menu-icon" style="background:rgba(255,107,43,.15)">‚õΩ</div>
      <div class="menu-label" style="color:var(--diesel)">DI√âSEL</div>
      <div class="menu-sub">Common Rail ¬∑ Bomba</div>
    </div>
    <div class="menu-card" id="mn-modules">
      <div class="menu-icon" style="background:rgba(6,182,212,.15)">üñ•</div>
      <div class="menu-label" style="color:var(--module)">M√ìDULOS</div>
      <div class="menu-sub">ECM ¬∑ TCM ¬∑ BCM ¬∑ ABS</div>
      <div class="menu-badge">PRO</div>
    </div>
    <div class="menu-card" id="mn-immo">
      <div class="menu-icon" style="background:rgba(168,85,247,.15)">üîê</div>
      <div class="menu-label" style="color:var(--immo)">INMO + LLAVES</div>
      <div class="menu-sub">NATS ¬∑ PATS ¬∑ Immo3</div>
    </div>
    <div class="menu-card" id="mn-hp">
      <div class="menu-icon" style="background:rgba(239,68,68,.15)">üèÅ</div>
      <div class="menu-label" style="color:var(--hp)">HP TUNERS</div>
      <div class="menu-sub">Mapas ¬∑ ECU ¬∑ Tune</div>
      <div class="menu-badge">NEW</div>
    </div>
    <div class="menu-card" id="mn-prog">
      <div class="menu-icon" style="background:rgba(155,89,182,.15)">üíæ</div>
      <div class="menu-label" style="color:var(--purple)">TRASDATA / PROG</div>
      <div class="menu-sub">Programaci√≥n m√≥dulos</div>
    </div>
    <div class="menu-card" id="mn-diag">
      <div class="menu-icon" style="background:rgba(0,212,232,.15)">üìê</div>
      <div class="menu-label" style="color:var(--cyan)">DIAGRAMAS</div>
      <div class="menu-sub">El√©ctricos ¬∑ Pinouts</div>
    </div>
    <div class="menu-card" id="mn-report">
      <div class="menu-icon" style="background:rgba(255,75,92,.15)">üìã</div>
      <div class="menu-label" style="color:var(--red)">REPORTE</div>
      <div class="menu-sub">Diagn√≥stico completo</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê VEH√çCULOS DB ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-vehdb">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-vehdb">‚Üê</button>
    <h2 style="color:var(--green)">üöó VEH√çCULOS ¬∑ BASE DE DATOS</h2>
  </div>
  <div class="search-bar">
    <span style="font-size:15px;color:var(--gray)">üîç</span>
    <input type="text" id="veh-search" placeholder="Buscar marca, modelo, a√±o, VIN..." autocomplete="off"/>
    <button onclick="clearVehSearch()" style="background:none;border:none;cursor:pointer;color:var(--gray);font-size:14px">‚úï</button>
  </div>
  <!-- Marcas -->
  <div class="brand-scroll" id="brand-scroll">
    <div class="brand-chip active" data-brand="ALL">TODAS</div>
    <div class="brand-chip" data-brand="Nissan">NISSAN</div>
    <div class="brand-chip" data-brand="VW">VW</div>
    <div class="brand-chip" data-brand="Chevrolet">CHEVROLET</div>
    <div class="brand-chip" data-brand="Ford">FORD</div>
    <div class="brand-chip" data-brand="Toyota">TOYOTA</div>
    <div class="brand-chip" data-brand="Honda">HONDA</div>
    <div class="brand-chip" data-brand="Mazda">MAZDA</div>
    <div class="brand-chip" data-brand="Dodge">DODGE</div>
    <div class="brand-chip" data-brand="BMW">BMW</div>
    <div class="brand-chip" data-brand="Mercedes">MERCEDES</div>
    <div class="brand-chip" data-brand="Audi">AUDI</div>
    <div class="brand-chip" data-brand="Hyundai">HYUNDAI</div>
    <div class="brand-chip" data-brand="Kia">KIA</div>
  </div>
  <!-- A√±os -->
  <div class="year-row" id="year-row">
    <div class="year-chip active" data-year="ALL">TODOS</div>
  </div>
  <!-- Tipo combustible -->
  <div class="vf-bar" id="fuel-filter">
    <div class="vf-chip active" data-fuel="ALL">TODOS</div>
    <div class="vf-chip" data-fuel="gasolina">‚õΩ GASOLINA</div>
    <div class="vf-chip" data-fuel="diesel">üî• DI√âSEL</div>
    <div class="vf-chip" data-fuel="hibrido">‚ö° H√çBRIDO</div>
  </div>
  <div id="veh-count" style="font-size:9px;color:var(--lgray);margin-bottom:8px"></div>
  <div class="result-list" id="veh-results"></div>
  <div id="veh-loading" style="text-align:center;padding:30px;color:var(--lgray);font-size:11px;display:none">
    ‚è≥ Cargando base de datos...
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SCANNER OBD2 ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-obd">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-obd">‚Üê</button>
    <h2 style="color:var(--blue)">üîå SCANNER OBD2</h2>
    <button class="btn btn-primary" id="obd-connect-btn" style="flex:0;padding:6px 12px;font-size:10px">‚ö° CONECTAR</button>
  </div>

  <div class="obd-tab-bar">
    <button class="obd-tab active" data-panel="live">üìä EN VIVO</button>
    <button class="obd-tab" data-panel="charts">üìà GR√ÅFICAS</button>
    <button class="obd-tab" data-panel="dtc">‚ùå DTC</button>
    <button class="obd-tab" data-panel="pids">üìã PIDs</button>
    <button class="obd-tab" data-panel="freeze">‚ùÑ FREEZE</button>
  </div>

  <!-- PANEL LIVE -->
  <div class="obd-panel active" id="panel-live">
    <div class="gauge-grid">
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">RPM</div><div class="obd-alert" id="al-rpm" style="background:rgba(30,140,224,.12);color:var(--blue)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--blue)" id="g-rpm">‚Äî</div>
        <div class="obd-label">VELOCIDAD MOTOR</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-rpm" style="background:var(--blue)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">¬∞C</div><div class="obd-alert" id="al-temp" style="background:rgba(0,196,140,.12);color:var(--green)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--green)" id="g-temp">‚Äî</div>
        <div class="obd-label">TEMPERATURA MOTOR</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-temp" style="background:var(--green)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">km/h</div><div class="obd-alert" id="al-spd" style="background:rgba(255,122,47,.12);color:var(--orange)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--orange)" id="g-spd">‚Äî</div>
        <div class="obd-label">VELOCIDAD VEH√çCULO</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-spd" style="background:var(--orange)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">%</div><div class="obd-alert" id="al-load" style="background:rgba(255,75,92,.12);color:var(--red)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--red)" id="g-load">‚Äî</div>
        <div class="obd-label">CARGA MOTOR</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-load" style="background:var(--red)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">V</div><div class="obd-alert" id="al-volt" style="background:rgba(0,212,232,.12);color:var(--cyan)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--cyan)" id="g-volt">‚Äî</div>
        <div class="obd-label">VOLTAJE ECM</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-volt" style="background:var(--cyan)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">%</div><div class="obd-alert" id="al-tps" style="background:rgba(245,166,35,.12);color:var(--gold)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--gold)" id="g-tps">‚Äî</div>
        <div class="obd-label">ACELERADOR TPS</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-tps" style="background:var(--gold)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">mg/s</div><div class="obd-alert" id="al-maf" style="background:rgba(155,89,182,.12);color:var(--purple)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--purple)" id="g-maf">‚Äî</div>
        <div class="obd-label">FLUJO AIRE MAF</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-maf" style="background:var(--purple)"></div></div>
      </div>
      <div class="obd-card">
        <div class="obd-header"><div class="obd-unit">mV</div><div class="obd-alert" id="al-o2" style="background:rgba(26,188,156,.12);color:var(--teal)">‚Äî</div></div>
        <div class="obd-val" style="color:var(--teal)" id="g-o2">‚Äî</div>
        <div class="obd-label">SONDA LAMBDA O2</div>
        <div class="gauge-bar"><div class="gauge-fill" id="bar-o2" style="background:var(--teal)"></div></div>
      </div>
    </div>
    <!-- Extended PIDs -->
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">üìä DATOS EXTENDIDOS</div>
      <table class="live-table" id="ext-pids-table">
        <tr><td class="lt-pid">PID 06</td><td class="lt-name">Fuel Trim ST B1</td><td class="lt-val" id="pid-ft-st" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 07</td><td class="lt-name">Fuel Trim LT B1</td><td class="lt-val" id="pid-ft-lt" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 0A</td><td class="lt-name">Presi√≥n Comb.</td><td class="lt-val" id="pid-fp" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 0B</td><td class="lt-name">MAP kPa</td><td class="lt-val" id="pid-map" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 0F</td><td class="lt-name">IAT ¬∞C</td><td class="lt-val" id="pid-iat" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 2F</td><td class="lt-name">Nivel Combustible</td><td class="lt-val" id="pid-fuel" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 33</td><td class="lt-name">Presi√≥n Baro</td><td class="lt-val" id="pid-baro" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">PID 5E</td><td class="lt-name">Flujo Comb. L/h</td><td class="lt-val" id="pid-fflow" style="color:var(--lgray)">‚Äî</td></tr>
      </table>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="obd-save-btn">üíæ GUARDAR SESI√ìN</button>
      <button class="btn btn-primary" id="obd-to-rep-btn">üìã ‚Üí REPORTE</button>
    </div>
  </div>

  <!-- PANEL CHARTS -->
  <div class="obd-panel" id="panel-charts">
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--blue)">RPM + CARGA MOTOR</div><div class="chart-val" id="cv-rpm" style="color:var(--blue)">‚Äî</div></div>
      <canvas id="chart-rpm" width="440" height="140" style="width:100%;height:140px;border-radius:6px;display:block;background:#040C18"></canvas>
      <div class="chart-legend"><div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>RPM</div><div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Carga%√ó80</div></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--green)">TEMPERATURA + MAF</div><div class="chart-val" id="cv-temp" style="color:var(--green)">‚Äî</div></div>
      <canvas id="chart-temp" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--gold)">TPS + VOLTAJE</div><div class="chart-val" id="cv-tps" style="color:var(--gold)">‚Äî</div></div>
      <canvas id="chart-tps" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--teal)">SONDA O2 LAMBDA</div><div class="chart-val" id="cv-o2" style="color:var(--teal)">‚Äî</div></div>
      <canvas id="chart-o2" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--orange)">FUEL TRIM B1 CORTO + LARGO</div><div class="chart-val" id="cv-ft" style="color:var(--orange)">‚Äî</div></div>
      <canvas id="chart-ft" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
  </div>

  <!-- PANEL DTC -->
  <div class="obd-panel" id="panel-dtc">
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">‚ùå C√ìDIGOS DTC</div>
      <div class="dtc-log-area" id="dtc-log">
        <span style="color:var(--lgray)">Conecte V-Link para lectura autom√°tica...</span>
      </div>
      <div id="dtc-chips-wrap" style="margin-top:10px"></div>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn btn-ghost btn-red" id="obd-clear-dtc" style="font-size:9px">üóë BORRAR DTC</button>
        <button class="btn btn-ghost" id="obd-read-dtc" style="font-size:9px">üîÑ LEER DTC</button>
      </div>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--blue)">üìö DESCRIPCI√ìN</div>
      <div id="dtc-desc-area" style="font-size:10px;color:var(--lgray);line-height:1.7">
        Toca un c√≥digo DTC para ver descripci√≥n, causas y diagn√≥stico.
      </div>
    </div>
  </div>

  <!-- PANEL PIDs COMPLETOS -->
  <div class="obd-panel" id="panel-pids">
    <div class="card b-cyan">
      <div class="sec-lbl" style="color:var(--cyan)">üìã TODOS LOS PIDs</div>
      <table class="live-table" id="full-pid-table">
        <tr><td class="lt-pid">01 0C</td><td class="lt-name">RPM</td><td class="lt-val" id="fp-rpm" style="color:var(--blue)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 05</td><td class="lt-name">Temp Motor ECT</td><td class="lt-val" id="fp-temp" style="color:var(--green)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 0D</td><td class="lt-name">Velocidad</td><td class="lt-val" id="fp-spd" style="color:var(--orange)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 04</td><td class="lt-name">Carga Motor</td><td class="lt-val" id="fp-load" style="color:var(--red)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 42</td><td class="lt-name">Voltaje ECM</td><td class="lt-val" id="fp-volt" style="color:var(--cyan)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 11</td><td class="lt-name">TPS %</td><td class="lt-val" id="fp-tps" style="color:var(--gold)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 10</td><td class="lt-name">MAF g/s</td><td class="lt-val" id="fp-maf" style="color:var(--purple)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 14</td><td class="lt-name">O2 B1S1 mV</td><td class="lt-val" id="fp-o2" style="color:var(--teal)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 06</td><td class="lt-name">Fuel Trim ST B1 %</td><td class="lt-val" id="fp-ftst" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 07</td><td class="lt-name">Fuel Trim LT B1 %</td><td class="lt-val" id="fp-ftlt" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 0B</td><td class="lt-name">MAP Presi√≥n kPa</td><td class="lt-val" id="fp-map" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 0F</td><td class="lt-name">IAT Temp Aire ¬∞C</td><td class="lt-val" id="fp-iat" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 0E</td><td class="lt-name">Avance Ignici√≥n ¬∞</td><td class="lt-val" id="fp-timing" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 2F</td><td class="lt-name">Nivel Combustible %</td><td class="lt-val" id="fp-fuel" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 5C</td><td class="lt-name">Temp Aceite ¬∞C</td><td class="lt-val" id="fp-oil" style="color:var(--lgray)">‚Äî</td></tr>
        <tr><td class="lt-pid">01 31</td><td class="lt-name">Dist. desde DTC km</td><td class="lt-val" id="fp-dist" style="color:var(--lgray)">‚Äî</td></tr>
      </table>
    </div>
  </div>

  <!-- PANEL FREEZE FRAME -->
  <div class="obd-panel" id="panel-freeze">
    <div class="card b-gold">
      <div class="sec-lbl" style="color:var(--gold)">‚ùÑ FREEZE FRAME ¬∑ SNAPSHOT EN FALLA</div>
      <div id="freeze-data" style="font-family:'Share Tech Mono',monospace;font-size:9px;line-height:2.2;color:var(--lgray)">
        No hay datos. Lea DTC primero.
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê CALIBRACI√ìN ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-cal">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-cal">‚Üê</button>
    <h2 style="color:var(--gold)">‚öô CALIBRACI√ìN</h2>
  </div>
  <div class="obd-tab-bar">
    <button class="obd-tab active" data-panel="cal-tps">TPS</button>
    <button class="obd-tab" data-panel="cal-inj">INJECTORES</button>
    <button class="obd-tab" data-panel="cal-idle">RALENT√ç</button>
    <button class="obd-tab" data-panel="cal-maf">MAF</button>
    <button class="obd-tab" data-panel="cal-ecu">ECU</button>
  </div>

  <!-- TPS Panel -->
  <div class="obd-panel active" id="panel-cal-tps">
    <div class="card b-gold">
      <div class="sec-lbl" style="color:var(--gold)">‚öô CALIBRACI√ìN TPS ¬∑ CUERPO ACELERACI√ìN</div>
      <div class="row2" style="margin-bottom:10px">
        <div class="field"><label>MARCA / ECU</label>
          <select id="cal-brand">
            <option>Nissan ‚Äî Hitachi</option><option>Nissan ‚Äî Siemens</option>
            <option>VW ‚Äî Bosch ME7</option><option>Chevrolet ‚Äî Delphi</option>
            <option>Ford ‚Äî EEC-V</option><option>Toyota ‚Äî 89661</option>
            <option>Honda ‚Äî Keihin</option><option>Mazda ‚Äî Denso</option>
          </select>
        </div>
        <div class="field"><label>MODELO</label><input type="text" id="cal-veh" placeholder="Tsuru 2010"/></div>
      </div>
    </div>
    <!-- Live TPS chart from OBD -->
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--gold)">üìà TPS EN VIVO (OBD2)</div><div class="chart-val" id="cal-tps-val" style="color:var(--gold)">‚Äî V</div></div>
      <canvas id="chart-cal-tps" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--green)">üå° TEMPERATURA MOTOR</div><div class="chart-val" id="cal-temp-val" style="color:var(--green)">‚Äî ¬∞C</div></div>
      <canvas id="chart-cal-temp" width="440" height="90" style="width:100%;height:90px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <!-- Manual slider -->
    <div class="card">
      <div class="sec-lbl" style="color:var(--gold)">üéö SIMULADOR TPS MANUAL</div>
      <div class="cal-limits"><span>CERRADO: 0.50V</span><span>WOT: 4.80V</span></div>
      <input type="range" class="cal-slider" id="cal-tps-slider" min="0" max="100" value="10" oninput="updateCalTPS(this.value)">
      <div class="cal-val-display" id="cal-tps-display">0.50 V ‚Äî CERRADO</div>
    </div>
    <!-- Voltage table -->
    <div class="card b-gold">
      <div class="sec-lbl" style="color:var(--gold)">üìä TABLA REFERENCIA TPS</div>
      <table class="inj-table">
        <tr><th>POSICI√ìN</th><th>VOLTAJE</th><th>ESTADO</th></tr>
        <tr><td>Cerrado 0%</td><td>0.50‚Äì0.80 V</td><td style="color:var(--green)">‚úì OK</td></tr>
        <tr><td>Crucero 25%</td><td>1.50‚Äì2.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
        <tr><td>Medio 50%</td><td>2.50‚Äì3.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
        <tr><td>75%</td><td>3.50‚Äì4.00 V</td><td style="color:var(--green)">‚úì OK</td></tr>
        <tr><td>WOT 100%</td><td>4.50‚Äì4.80 V</td><td style="color:var(--green)">‚úì OK</td></tr>
        <tr><td style="color:var(--red)">Corto a tierra</td><td style="color:var(--red)">0.00 V</td><td style="color:var(--red)">‚úó ERROR</td></tr>
        <tr><td style="color:var(--red)">Corto a positivo</td><td style="color:var(--red)">5.00 V</td><td style="color:var(--red)">‚úó ERROR</td></tr>
      </table>
    </div>
    <div class="btn-row"><button class="btn btn-gold" id="cal-save-btn">üíæ GUARDAR</button><button class="btn btn-ghost" id="cal-db-btn">‚òÅ DB</button></div>
  </div>

  <!-- INJECTORS Panel -->
  <div class="obd-panel" id="panel-cal-inj">
    <div class="card b-orange">
      <div class="sec-lbl" style="color:var(--orange)">üíß CALIBRACI√ìN INYECTORES</div>
      <div class="row3" style="margin-bottom:10px">
        <div class="field"><label>TIPO</label>
          <select id="inj-type"><option>GDI</option><option>MPI/SFI</option><option>TBI</option><option>Diesel CR</option></select>
        </div>
        <div class="field"><label>CILINDROS</label>
          <select id="inj-cyl"><option>4</option><option>6</option><option>8</option><option>3</option></select>
        </div>
        <div class="field"><label>OHMS</label><input type="number" id="inj-ohm" placeholder="12‚Äì16" step="0.1"/></div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--orange)">üìà PULSO INYECTORES EN VIVO</div><div class="chart-val" id="inj-pw-val" style="color:var(--orange)">‚Äî ms</div></div>
      <canvas id="chart-inj" width="440" height="120" style="width:100%;height:120px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="card b-orange">
      <div class="sec-lbl" style="color:var(--orange)">üìä TABLA ANCHO DE PULSO NORMAL</div>
      <table class="inj-table">
        <tr><th>CONDICI√ìN</th><th>PULSO NORMAL</th><th>PULSO FALLA</th></tr>
        <tr><td>Arranque en fr√≠o</td><td style="color:var(--green)">8‚Äì14 ms</td><td style="color:var(--red)">&lt;4 / &gt;20 ms</td></tr>
        <tr><td>Ralent√≠ caliente</td><td style="color:var(--green)">1.5‚Äì3.5 ms</td><td style="color:var(--red)">&lt;1 / &gt;6 ms</td></tr>
        <tr><td>Crucero 2500 RPM</td><td style="color:var(--green)">3.0‚Äì5.0 ms</td><td style="color:var(--red)">&lt;2 / &gt;8 ms</td></tr>
        <tr><td>Aceleraci√≥n WOT</td><td style="color:var(--green)">8.0‚Äì15.0 ms</td><td style="color:var(--red)">&gt;18 ms</td></tr>
        <tr><td>Desaceleraci√≥n</td><td style="color:var(--green)">0 ms (cut)</td><td style="color:var(--red)">Abierto &gt;0.5 ms</td></tr>
      </table>
    </div>
    <!-- Individual cylinder balance -->
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">‚öñ BALANCE DE CILINDROS</div>
      <div id="cyl-balance" style="display:grid;grid-template-columns:1fr 1fr;gap:6px"></div>
    </div>
    <div class="btn-row"><button class="btn btn-ghost btn-diesel" id="inj-test-btn">üîß PRUEBA INYECTORES</button><button class="btn btn-ghost" id="inj-save-btn">üíæ GUARDAR</button></div>
  </div>

  <!-- IDLE Panel -->
  <div class="obd-panel" id="panel-cal-idle">
    <div class="card b-blue">
      <div class="sec-lbl" style="color:var(--blue)">üîÑ CALIBRACI√ìN RALENT√ç / IAC</div>
      <div class="step-list" id="idle-steps"></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--blue)">üìà RPM RALENT√ç EN VIVO</div><div class="chart-val" id="idle-rpm-val" style="color:var(--blue)">‚Äî RPM</div></div>
      <canvas id="chart-idle" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="card b-blue">
      <div class="sec-lbl" style="color:var(--blue)">üìä RPM NORMAL POR CONDICI√ìN</div>
      <table class="inj-table">
        <tr><th>CONDICI√ìN</th><th>RPM NORMAL</th></tr>
        <tr><td>Arranque en fr√≠o (A/C off)</td><td style="color:var(--green)">1200‚Äì1500</td></tr>
        <tr><td>Calentamiento</td><td style="color:var(--green)">900‚Äì1200</td></tr>
        <tr><td>Ralent√≠ caliente</td><td style="color:var(--green)">750‚Äì850</td></tr>
        <tr><td>A/C encendido</td><td style="color:var(--green)">800‚Äì950</td></tr>
        <tr><td>Con carga el√©ctrica</td><td style="color:var(--green)">800‚Äì900</td></tr>
      </table>
    </div>
  </div>

  <!-- MAF Panel -->
  <div class="obd-panel" id="panel-cal-maf">
    <div class="card b-purple">
      <div class="sec-lbl" style="color:var(--purple)">üå¨ SENSOR MAF / MAP</div>
      <div class="row2" style="margin-bottom:8px">
        <div class="field"><label>TIPO SENSOR</label>
          <select><option>MAF Hilo Caliente</option><option>MAF Pel√≠cula</option><option>MAP Vac√≠o</option><option>MAP + IAT Combinado</option></select>
        </div>
        <div class="field"><label>PROTOCOLO</label>
          <select><option>0‚Äì5V Lineal</option><option>Frecuencia Hz</option><option>0‚Äì1V Bajo</option></select>
        </div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--purple)">üìà MAF g/s EN VIVO</div><div class="chart-val" id="maf-live-val" style="color:var(--purple)">‚Äî</div></div>
      <canvas id="chart-maf-cal" width="440" height="110" style="width:100%;height:110px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="card b-purple">
      <div class="sec-lbl" style="color:var(--purple)">üìä VALORES MAF NORMALES</div>
      <table class="inj-table">
        <tr><th>RPM</th><th>MAF Normal (g/s)</th><th>MAP (kPa)</th></tr>
        <tr><td>Ralent√≠ 800</td><td style="color:var(--green)">2‚Äì6</td><td style="color:var(--green)">25‚Äì35</td></tr>
        <tr><td>2000 RPM</td><td style="color:var(--green)">8‚Äì15</td><td style="color:var(--green)">40‚Äì55</td></tr>
        <tr><td>3000 RPM</td><td style="color:var(--green)">18‚Äì28</td><td style="color:var(--green)">55‚Äì70</td></tr>
        <tr><td>WOT</td><td style="color:var(--green)">60‚Äì100+</td><td style="color:var(--green)">95‚Äì101</td></tr>
      </table>
    </div>
  </div>

  <!-- ECU Reset Panel -->
  <div class="obd-panel" id="panel-cal-ecu">
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">üîÑ RESET ECU / ADAPTACIONES</div>
      <div class="step-list" id="ecu-steps"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost btn-red" id="ecu-reset-btn">‚ö† RESET ECU</button>
      <button class="btn btn-ghost" id="ecu-adapt-btn">üìä VER ADAPTACIONES</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê DI√âSEL ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-diesel">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-diesel">‚Üê</button>
    <h2 style="color:var(--diesel)">‚õΩ DI√âSEL DIAGN√ìSTICO</h2>
  </div>
  <div class="obd-tab-bar">
    <button class="obd-tab active" data-panel="diesel-cr">COMMON RAIL</button>
    <button class="obd-tab" data-panel="diesel-pump">BOMBA</button>
    <button class="obd-tab" data-panel="diesel-inj">INYECTORES</button>
    <button class="obd-tab" data-panel="diesel-dpf">DPF/EGR</button>
  </div>

  <!-- Common Rail Panel -->
  <div class="obd-panel active" id="panel-diesel-cr">
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--diesel)">üìà PRESI√ìN RIEL COM√öN (bar)</div><div class="chart-val" id="cr-press-val" style="color:var(--diesel)">‚Äî bar</div></div>
      <canvas id="chart-cr" width="440" height="130" style="width:100%;height:130px;border-radius:6px;display:block;background:#040C18"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--diesel)"></div>Presi√≥n Riel (bar)</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div>Presi√≥n Deseada</div>
      </div>
    </div>
    <div class="card b-diesel">
      <div class="sec-lbl" style="color:var(--diesel)">üìä PRESIONES NORMALES COMMON RAIL</div>
      <table class="inj-table">
        <tr><th>CONDICI√ìN</th><th>PRESI√ìN NORMAL (bar)</th><th>FALLA</th></tr>
        <tr><td>Arranque</td><td style="color:var(--green)">200‚Äì350</td><td style="color:var(--red)">&lt;100 sin arranque</td></tr>
        <tr><td>Ralent√≠ caliente</td><td style="color:var(--green)">250‚Äì350</td><td style="color:var(--red)">&lt;150 rough idle</td></tr>
        <tr><td>2000 RPM</td><td style="color:var(--green)">600‚Äì800</td><td style="color:var(--red)">&lt;400 humo negro</td></tr>
        <tr><td>WOT / carga plena</td><td style="color:var(--green)">1300‚Äì1800</td><td style="color:var(--red)">&gt;2000 riesgo ECU</td></tr>
        <tr><td>Desaceleraci√≥n</td><td style="color:var(--green)">200‚Äì400</td><td style="color:var(--red)">0 = bomba falla</td></tr>
      </table>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">‚ö° SENSOR PRESI√ìN RIEL (FRP/RPS)</div>
      <table class="inj-table">
        <tr><th>VOLTAJE SENSOR</th><th>PRESI√ìN (bar)</th><th>NOTA</th></tr>
        <tr><td>0.5 V</td><td>0 bar</td><td style="color:var(--lgray)">Sin presi√≥n</td></tr>
        <tr><td>1.0 V</td><td>‚âà 200 bar</td><td style="color:var(--green)">Arranque</td></tr>
        <tr><td>2.5 V</td><td>‚âà 900 bar</td><td style="color:var(--green)">Normal</td></tr>
        <tr><td>4.5 V</td><td>‚âà 1800 bar</td><td style="color:var(--gold)">M√°ximo</td></tr>
        <tr><td>5.0 V / 0 V</td><td>Error</td><td style="color:var(--red)">‚úó Corto</td></tr>
      </table>
    </div>
  </div>

  <!-- Pump Panel -->
  <div class="obd-panel" id="panel-diesel-pump">
    <div class="card b-diesel">
      <div class="sec-lbl" style="color:var(--diesel)">‚öô CALIBRACI√ìN BOMBA DE ALTA PRESI√ìN</div>
      <div class="step-list" id="pump-steps"></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--orange)">üìà DUTY CYCLE SOLENOIDE BOMBA</div><div class="chart-val" id="pump-dc-val" style="color:var(--orange)">‚Äî %</div></div>
      <canvas id="chart-pump" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
  </div>

  <!-- Diesel Injectors Panel -->
  <div class="obd-panel" id="panel-diesel-inj">
    <div class="card b-diesel">
      <div class="sec-lbl" style="color:var(--diesel)">üíâ INYECTORES DI√âSEL</div>
      <div class="row2" style="margin-bottom:10px">
        <div class="field"><label>TECNOLOG√çA</label>
          <select><option>Solenoid CR</option><option>Piezoelectric</option><option>Unit Injector (PD)</option><option>Rotary Pump</option></select>
        </div>
        <div class="field"><label>PRESI√ìN MAX</label>
          <select><option>1800 bar (CR1)</option><option>2000 bar (CR2)</option><option>2200 bar (CR3)</option><option>3000 bar (CR4+)</option></select>
        </div>
      </div>
      <div id="diesel-cyl-wrap" style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px"></div>
    </div>
    <div class="card b-diesel">
      <div class="sec-lbl" style="color:var(--diesel)">üìä VALORES DE CORRECCI√ìN IMA</div>
      <table class="inj-table">
        <tr><th>IMA</th><th>SIGNIFICADO</th><th>ACCI√ìN</th></tr>
        <tr><td style="color:var(--green)">¬±2 mg/carrera</td><td>Normal</td><td style="color:var(--green)">Sin acci√≥n</td></tr>
        <tr><td style="color:var(--gold)">¬±3‚Äì4 mg</td><td>Desbalance leve</td><td style="color:var(--gold)">Monitorear</td></tr>
        <tr><td style="color:var(--red)">¬±5+ mg</td><td>Inyector defectuoso</td><td style="color:var(--red)">Reemplazar</td></tr>
        <tr><td style="color:var(--red)">Fijo en l√≠mite</td><td>Inyector atascado</td><td style="color:var(--red)">Urgente</td></tr>
      </table>
    </div>
  </div>

  <!-- DPF/EGR Panel -->
  <div class="obd-panel" id="panel-diesel-dpf">
    <div class="card b-orange">
      <div class="sec-lbl" style="color:var(--orange)">üå´ DPF + EGR DIAGN√ìSTICO</div>
      <div class="row2">
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" id="dpf-soot" style="color:var(--orange)">‚Äî</div><div class="kpi-lbl">Saturaci√≥n DPF %</div></div>
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" id="egr-pos" style="color:var(--blue)">‚Äî</div><div class="kpi-lbl">Posici√≥n EGR %</div></div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--orange)">üìà PRESI√ìN DIFERENCIAL DPF</div><div class="chart-val" id="dpf-dp-val" style="color:var(--orange)">‚Äî mbar</div></div>
      <canvas id="chart-dpf" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="btn-row">
      <button class="btn btn-diesel" id="dpf-regen-btn">üî• REGENERACI√ìN DPF</button>
      <button class="btn btn-ghost btn-diesel" id="egr-test-btn">üîß TEST EGR</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê M√ìDULOS ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-modules">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-modules">‚Üê</button>
    <h2 style="color:var(--module)">üñ• M√ìDULOS ECU</h2>
  </div>
  <!-- Vehicle selector for modules -->
  <div class="card b-module" style="margin-bottom:10px">
    <div class="sec-lbl" style="color:var(--module)">üöó VEH√çCULO ACTIVO</div>
    <div id="mod-veh-info" style="font-size:10px;color:var(--lgray)">Selecciona un veh√≠culo en la DB para ver sus m√≥dulos</div>
    <button class="btn btn-module" style="margin-top:8px" onclick="showScreen('vehdb')">üîç SELECCIONAR VEH√çCULO</button>
  </div>
  <div class="module-grid" id="module-grid">
    <!-- filled by JS -->
  </div>
  <!-- Module Detail (hidden initially) -->
  <div id="mod-detail" style="display:none">
    <div class="card b-module" id="mod-detail-card">
      <div class="sec-lbl" style="color:var(--module)" id="mod-detail-title">M√ìDULO</div>
      <div id="mod-detail-body" style="font-size:10px;color:var(--lgray);line-height:1.8"></div>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">üìã DTC ESPEC√çFICOS</div>
      <div id="mod-dtc-list"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-module" id="mod-read-btn">üì° LEER M√ìDULO</button>
      <button class="btn btn-ghost btn-module" id="mod-prog-btn">üíæ PROGRAMAR</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê IMMO + LLAVES ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-immo">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-immo">‚Üê</button>
    <h2 style="color:var(--immo)">üîê INMOVILIZADOR + LLAVES</h2>
  </div>
  <div class="row2" style="margin-bottom:10px">
    <div class="field"><label>MARCA / SISTEMA</label>
      <select id="immo-brand" onchange="updateImmoUI()">
        <option value="NATS">Nissan ‚Äî NATS</option>
        <option value="NATS5">Nissan ‚Äî NATS 5</option>
        <option value="PATS">Ford ‚Äî PATS</option>
        <option value="PATS5">Ford ‚Äî PATS 5</option>
        <option value="IMMO3">VW/Audi ‚Äî Immo 3</option>
        <option value="IMMO4">VW/Audi ‚Äî Immo 4</option>
        <option value="SKS">Toyota ‚Äî SKS</option>
        <option value="BCM">Chevrolet ‚Äî BCM</option>
        <option value="HONDA">Honda ‚Äî IMMO</option>
        <option value="MAZDA">Mazda ‚Äî IMMO</option>
      </select>
    </div>
    <div class="field"><label>VEH√çCULO</label><input type="text" id="immo-veh" placeholder="Sentra B15 2004"/></div>
  </div>

  <!-- Status -->
  <div class="card b-immo">
    <div class="sec-lbl" style="color:var(--immo)">üîê ESTADO INMOVILIZADOR</div>
    <div class="row3" style="margin-bottom:10px">
      <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--immo)" id="immo-sys-lbl">NATS</div><div class="kpi-lbl">SISTEMA</div></div>
      <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--green)" id="immo-status-val">ACTIVO</div><div class="kpi-lbl">ESTADO</div></div>
      <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--gold)" id="immo-keys-count">2/4</div><div class="kpi-lbl">LLAVES</div></div>
    </div>
    <div id="immo-info" style="font-size:9px;color:var(--lgray);line-height:1.7;margin-bottom:10px"></div>
    <!-- Key slots -->
    <div class="sec-lbl" style="color:var(--lgray)">üóù LLAVES PROGRAMADAS</div>
    <div class="key-grid" id="key-grid">
      <div class="key-slot prog" data-slot="1"><div class="key-slot-ico">üóù</div><div class="key-slot-lbl">LLAVE 1</div><div class="key-slot-st">PROGRAMADA</div></div>
      <div class="key-slot prog" data-slot="2"><div class="key-slot-ico">üóù</div><div class="key-slot-lbl">LLAVE 2</div><div class="key-slot-st">PROGRAMADA</div></div>
      <div class="key-slot" data-slot="3" onclick="progKey(3)"><div class="key-slot-ico">‚ûï</div><div class="key-slot-lbl">LLAVE 3</div><div class="key-slot-st">VAC√çA</div></div>
      <div class="key-slot" data-slot="4" onclick="progKey(4)"><div class="key-slot-ico">‚ûï</div><div class="key-slot-lbl">LLAVE 4</div><div class="key-slot-st">VAC√çA</div></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-purple" id="immo-prog-btn">üîë PROGRAMAR LLAVE</button>
      <button class="btn btn-ghost btn-red" id="immo-erase-btn">üóë BORRAR TODAS</button>
    </div>
  </div>

  <!-- Programming Progress -->
  <div class="card b-immo" id="immo-prog-card" style="display:none">
    <div class="sec-lbl" style="color:var(--immo)">‚ö° PROGRAMANDO LLAVE</div>
    <div class="ring-wrap">
      <div class="ring-outer">
        <svg class="ring-svg" viewBox="0 0 120 120">
          <circle class="ring-bg" cx="60" cy="60" r="50"/>
          <circle class="ring-fill" id="immo-ring" cx="60" cy="60" r="50" stroke="var(--immo)"/>
        </svg>
        <div class="ring-center">
          <div class="ring-pct" id="immo-pct" style="color:var(--immo)">0%</div>
          <div style="font-size:8px;color:var(--lgray)">PROGRAMANDO</div>
        </div>
      </div>
      <div class="ring-msg" id="immo-msg">Iniciando...</div>
    </div>
  </div>

  <!-- Procedure -->
  <div class="card">
    <div class="sec-lbl" style="color:var(--lgray)">üìã PROCEDIMIENTO</div>
    <div class="step-list" id="immo-steps"></div>
  </div>

  <!-- PIN Reader -->
  <div class="card b-immo">
    <div class="sec-lbl" style="color:var(--immo)">üîë LECTURA PIN CODE</div>
    <div style="font-size:9px;color:var(--lgray);margin-bottom:8px">El PIN/Security Code se lee directamente del m√≥dulo (requiere acceso EEPROM)</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:20px;text-align:center;
      background:var(--field);border-radius:8px;padding:12px;letter-spacing:6px;color:var(--immo)" id="immo-pin-display">
      ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-purple" id="immo-read-pin-btn">üì° LEER PIN DEL M√ìDULO</button>
    </div>
  </div>

  <!-- Voltage/Signal charts for IMMO -->
  <div class="chart-wrap">
    <div class="chart-header"><div class="chart-title" style="color:var(--immo)">üìà VOLTAJE ECM / SE√ëAL INMO</div><div class="chart-val" id="immo-volt-val" style="color:var(--immo)">‚Äî V</div></div>
    <canvas id="chart-immo" width="440" height="100" style="width:100%;height:100px;border-radius:6px;display:block;background:#040C18"></canvas>
  </div>
  <div class="btn-row"><button class="btn btn-ghost btn-purple" id="immo-db-btn">‚òÅ DB</button><button class="btn btn-ghost" onclick="showScreen('diag')">üìê DIAGRAMAS</button></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê HP TUNERS ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-hp">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-hp">‚Üê</button>
    <h2 style="color:var(--hp)">üèÅ HP TUNERS</h2>
  </div>
  <div class="obd-tab-bar">
    <button class="obd-tab active" data-panel="hp-maps">MAPAS</button>
    <button class="obd-tab" data-panel="hp-read">LECTURA</button>
    <button class="obd-tab" data-panel="hp-write">ESCRITURA</button>
    <button class="obd-tab" data-panel="hp-log">DATA LOG</button>
  </div>

  <!-- Maps Panel -->
  <div class="obd-panel active" id="panel-hp-maps">
    <div class="card b-hp">
      <div class="sec-lbl" style="color:var(--hp)">üó∫ MAPAS DE CALIBRACI√ìN ECU</div>
      <div class="row2" style="margin-bottom:8px">
        <div class="field"><label>TABLA</label>
          <select id="hp-table-sel" onchange="renderHPMap()">
            <option value="VE">Volumetric Efficiency</option>
            <option value="SPARK">Spark Timing</option>
            <option value="AFR">Air/Fuel Ratio</option>
            <option value="BOOST">Boost Target</option>
            <option value="INJ_PW">Injector Pulse Width</option>
            <option value="IDLE_RPM">Idle RPM Target</option>
          </select>
        </div>
        <div class="field"><label>MODO</label>
          <select id="hp-mode">
            <option>Ver</option><option>Editar</option><option>Comparar</option>
          </select>
        </div>
      </div>
    </div>
    <!-- Map Grid -->
    <div class="card" id="hp-map-container">
      <div class="sec-lbl" style="color:var(--lgray)" id="hp-map-title">VOLUMETRIC EFFICIENCY ¬∑ 16√ó16</div>
      <div style="overflow-x:auto">
        <div id="hp-map-grid" style="display:inline-block;min-width:300px"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:4px;font-size:8px"><div style="width:12px;height:12px;border-radius:2px;background:#1E3A5F"></div><span style="color:var(--lgray)">Bajo</span></div>
        <div style="display:flex;align-items:center;gap:4px;font-size:8px"><div style="width:12px;height:12px;border-radius:2px;background:#1E6B3C"></div><span style="color:var(--lgray)">Normal</span></div>
        <div style="display:flex;align-items:center;gap:4px;font-size:8px"><div style="width:12px;height:12px;border-radius:2px;background:#8B5E00"></div><span style="color:var(--lgray)">Alto</span></div>
        <div style="display:flex;align-items:center;gap:4px;font-size:8px"><div style="width:12px;height:12px;border-radius:2px;background:#8B0000"></div><span style="color:var(--lgray)">M√°ximo</span></div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-hp" id="hp-read-ecu-btn">üì° LEER ECU</button>
      <button class="btn btn-ghost btn-hp" id="hp-write-ecu-btn">üíæ ESCRIBIR ECU</button>
    </div>
  </div>

  <!-- Read Panel -->
  <div class="obd-panel" id="panel-hp-read">
    <div class="card b-hp">
      <div class="sec-lbl" style="color:var(--hp)">üì° LECTURA ECU</div>
      <div class="row2" style="margin-bottom:8px">
        <div class="field"><label>PROTOCOLO</label>
          <select><option>GM E38/E67/E92</option><option>Ford EEC-VI</option><option>Mopar PCM</option><option>Universal J2534</option></select>
        </div>
        <div class="field"><label>INTERFAZ</label>
          <select><option>HP Tuners MPVI3</option><option>HP Tuners MPVI2</option><option>J2534 OBD2</option></select>
        </div>
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="hp-read-bar"></div></div>
      <div class="prog-status-log" id="hp-read-log"><span style="color:var(--lgray)">Listo para leer ECU...</span></div>
    </div>
  </div>

  <!-- Write Panel -->
  <div class="obd-panel" id="panel-hp-write">
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">‚ö† ESCRITURA ECU ¬∑ PRECAUCI√ìN</div>
      <div style="font-size:9px;color:var(--lgray);line-height:1.7;margin-bottom:8px">
        ‚ö† La escritura de la ECU modifica permanentemente la calibraci√≥n del motor.<br>
        Aseg√∫rate de tener un respaldo antes de escribir. Solo para profesionales.
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="hp-write-bar"></div></div>
      <div class="prog-status-log" id="hp-write-log"><span style="color:var(--lgray)">Listo...</span></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="hp-backup-btn">üíæ RESPALDAR ECU</button>
      <button class="btn btn-hp" id="hp-flash-btn">‚ö° FLASHEAR ECU</button>
    </div>
  </div>

  <!-- Data Log Panel -->
  <div class="obd-panel" id="panel-hp-log">
    <div class="chart-wrap">
      <div class="chart-header"><div class="chart-title" style="color:var(--hp)">üìä DATA LOG EN VIVO</div><div class="chart-val" id="hp-log-status" style="color:var(--lgray)">Desconectado</div></div>
      <canvas id="chart-hp-log" width="440" height="160" style="width:100%;height:160px;border-radius:6px;display:block;background:#040C18"></canvas>
    </div>
    <div class="card">
      <div class="row4">
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--hp)" id="hp-rpm">‚Äî</div><div class="kpi-lbl">RPM</div></div>
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--gold)" id="hp-map2">‚Äî</div><div class="kpi-lbl">MAP kPa</div></div>
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--green)" id="hp-afr">‚Äî</div><div class="kpi-lbl">AFR</div></div>
        <div class="kpi-box" style="background:var(--field)"><div class="kpi-val" style="color:var(--red)" id="hp-knock">‚Äî</div><div class="kpi-lbl">KNOCK</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê TRASDATA / PROGRAMMER ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-prog">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-prog">‚Üê</button>
    <h2 style="color:var(--purple)">üíæ PROGRAMACI√ìN M√ìDULOS</h2>
  </div>
  <div class="obd-tab-bar">
    <button class="obd-tab active" data-panel="prog-sel">M√ìDULO</button>
    <button class="obd-tab" data-panel="prog-read">LEER</button>
    <button class="obd-tab" data-panel="prog-write">ESCRIBIR</button>
    <button class="obd-tab" data-panel="prog-clone">CLONAR</button>
  </div>

  <!-- Module select panel -->
  <div class="obd-panel active" id="panel-prog-sel">
    <div class="card b-purple">
      <div class="sec-lbl" style="color:var(--purple)">üíæ SELECCI√ìN DE M√ìDULO A PROGRAMAR</div>
      <div class="module-grid" id="prog-module-grid">
        <div class="mod-card" onclick="selectProgModule('ECM')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">üß†</div><div class="mod-name" style="color:var(--purple)">ECM/PCM</div><div class="mod-sub">Motor / Tren</div></div>
        <div class="mod-card" onclick="selectProgModule('TCM')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">‚öô</div><div class="mod-name" style="color:var(--purple)">TCM</div><div class="mod-sub">Transmisi√≥n</div></div>
        <div class="mod-card" onclick="selectProgModule('BCM')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">üè†</div><div class="mod-name" style="color:var(--purple)">BCM</div><div class="mod-sub">Carrocer√≠a</div></div>
        <div class="mod-card" onclick="selectProgModule('IMMO')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">üîê</div><div class="mod-name" style="color:var(--purple)">INMO</div><div class="mod-sub">Inmovilizador</div></div>
        <div class="mod-card" onclick="selectProgModule('ABS')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">üõë</div><div class="mod-name" style="color:var(--purple)">ABS/ESC</div><div class="mod-sub">Frenos</div></div>
        <div class="mod-card" onclick="selectProgModule('AIRBAG')" style="border-color:rgba(168,85,247,.3)"><div class="mod-icon">üí®</div><div class="mod-name" style="color:var(--purple)">AIRBAG</div><div class="mod-sub">SRS/SDM</div></div>
      </div>
    </div>
    <div id="prog-tools" style="display:none">
      <div class="card b-purple" id="prog-tool-info"></div>
    </div>
  </div>

  <!-- Read Panel -->
  <div class="obd-panel" id="panel-prog-read">
    <div class="card b-purple">
      <div class="sec-lbl" style="color:var(--purple)">üì° LECTURA DE M√ìDULO</div>
      <div class="field" style="margin-bottom:8px"><label>PROTOCOLO</label>
        <select id="prog-proto">
          <option>CAN (ISO 15765)</option><option>K-Line (ISO 9141)</option>
          <option>KWP2000</option><option>SCI / SCI Bus</option>
          <option>J1850 VPW</option><option>J1850 PWM</option>
        </select>
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="prog-read-bar"></div></div>
      <div class="prog-status-log" id="prog-read-log"><span style="color:var(--lgray)">Listo para leer...</span></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-purple" id="prog-start-read-btn">üì° INICIAR LECTURA</button>
      <button class="btn btn-ghost" id="prog-save-bin-btn">üíæ GUARDAR .BIN</button>
    </div>
  </div>

  <!-- Write Panel -->
  <div class="obd-panel" id="panel-prog-write">
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">‚ö† ESCRITURA M√ìDULO</div>
      <div style="font-size:9px;color:var(--lgray);margin-bottom:8px">Verifica que el archivo .BIN sea compatible con el veh√≠culo exacto.</div>
      <div class="field" style="margin-bottom:8px"><label>ARCHIVO .BIN</label>
        <input type="file" id="prog-bin-file" accept=".bin,.hex" style="font-size:10px;padding:6px"/>
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="prog-write-bar"></div></div>
      <div class="prog-status-log" id="prog-write-log"><span style="color:var(--lgray)">Selecciona archivo...</span></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="prog-verify-btn">üîç VERIFICAR</button>
      <button class="btn btn-purple" id="prog-flash-btn">‚ö° ESCRIBIR</button>
    </div>
  </div>

  <!-- Clone Panel -->
  <div class="obd-panel" id="panel-prog-clone">
    <div class="card b-purple">
      <div class="sec-lbl" style="color:var(--purple)">üîÑ CLONACI√ìN DE M√ìDULO</div>
      <div style="font-size:9px;color:var(--lgray);margin-bottom:10px">Lee el m√≥dulo original y escribe en el m√≥dulo nuevo</div>
      <div class="step-list" id="clone-steps"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-purple" id="clone-start-btn">‚ö° INICIAR CLONACI√ìN</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê DIAGRAMAS ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-diag">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-diag">‚Üê</button>
    <h2 style="color:var(--cyan)">üìê DIAGRAMAS EL√âCTRICOS</h2>
  </div>
  <div class="search-bar">
    <span style="font-size:15px;color:var(--gray)">üîç</span>
    <input type="text" id="diag-search" placeholder="Nissan Tsuru ¬∑ ECU pinout ¬∑ P0171..." oninput="filterDiags()"/>
  </div>
  <div class="vf-bar" id="diag-type-filter">
    <div class="vf-chip active" data-dtype="ALL">TODOS</div>
    <div class="vf-chip" data-dtype="diagrama">‚ö° EL√âCTRICO</div>
    <div class="vf-chip" data-dtype="pinout">üîå PINOUT</div>
    <div class="vf-chip" data-dtype="dtc">‚ùå DTC</div>
    <div class="vf-chip" data-dtype="tabla">üìä TABLAS</div>
    <div class="vf-chip" data-dtype="diesel">‚õΩ DI√âSEL</div>
  </div>
  <div id="diag-list" class="result-list"></div>
  <div id="diag-detail" style="display:none">
    <div class="card b-cyan" id="diag-detail-card">
      <div class="sec-lbl" style="color:var(--cyan)" id="diag-detail-title">DIAGRAMA</div>
      <div id="diag-detail-body"></div>
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-top:4px" onclick="document.getElementById('diag-detail').style.display='none'">‚Üê VOLVER A LISTA</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê REPORTE ‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="scr-report">
  <div class="sec-hdr">
    <button class="back-btn" id="bk-report">‚Üê</button>
    <h2 style="color:var(--red)">üìã NUEVO REPORTE</h2>
  </div>
  <div class="fg">
    <div class="card b-blue">
      <div class="sec-lbl" style="color:var(--blue)">üöó DATOS DEL VEH√çCULO</div>
      <div class="row2">
        <div class="field"><label>MARCA</label><input type="text" id="r-brand" placeholder="Nissan"/></div>
        <div class="field"><label>MODELO</label><input type="text" id="r-model" placeholder="Tsuru III"/></div>
      </div>
      <div class="row3">
        <div class="field"><label>A√ëO</label><input type="text" id="r-year" placeholder="2010"/></div>
        <div class="field"><label>MOTOR</label><input type="text" id="r-engine" placeholder="GA16DE"/></div>
        <div class="field"><label>KM</label><input type="text" id="r-km" placeholder="120000"/></div>
      </div>
      <div class="row2">
        <div class="field"><label>PLACAS</label><input type="text" id="r-plates" placeholder="ABC-123-D" style="text-transform:uppercase"/></div>
        <div class="field"><label>COLOR</label><input type="text" id="r-color" placeholder="Blanco"/></div>
      </div>
      <div class="field"><label>VIN / SERIE</label><input type="text" id="r-vin" placeholder="JN1CAAJ10U1234567"/></div>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">üë§ CLIENTE</div>
      <div class="row2">
        <div class="field"><label>NOMBRE</label><input type="text" id="r-client" placeholder="Juan Garc√≠a"/></div>
        <div class="field"><label>TEL√âFONO</label><input type="tel" id="r-phone" placeholder="777 123 4567"/></div>
      </div>
    </div>
    <div class="card b-red">
      <div class="sec-lbl" style="color:var(--red)">üîß DIAGN√ìSTICO</div>
      <div class="field"><label>S√çNTOMA / QUEJA DEL CLIENTE</label><textarea id="r-complaint" placeholder="Motor no arranca en fr√≠o, luz de check engine encendida..."></textarea></div>
      <div class="field"><label>OBSERVACI√ìN DEL T√âCNICO</label><textarea id="r-obs" placeholder="Se detectaron c√≥digos DTC: P0171, P0300..."></textarea></div>
      <div class="field"><label>TRABAJO REALIZADO</label><textarea id="r-work" placeholder="Limpieza cuerpo de aceleraci√≥n, calibraci√≥n TPS, limpieza inyectores..."></textarea></div>
    </div>
    <div class="card">
      <div class="sec-lbl" style="color:var(--lgray)">üí∞ COSTOS</div>
      <div class="row2">
        <div class="field"><label>MANO DE OBRA</label><input type="number" id="r-labor" placeholder="800.00"/></div>
        <div class="field"><label>TOTAL $</label><input type="number" id="r-total" placeholder="1200.00"/></div>
      </div>
      <div class="row2">
        <div class="field"><label>GARANT√çA</label>
          <select id="r-warranty"><option>Sin garant√≠a</option><option>30 d√≠as / 1,000 km</option><option>60 d√≠as / 2,000 km</option><option>90 d√≠as</option></select>
        </div>
        <div class="field"><label>ESTATUS</label>
          <select id="r-status"><option value="proceso">En proceso</option><option value="listo">Listo para entregar</option><option value="entregado">Entregado</option></select>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" id="rep-save-btn">üíæ GUARDAR</button>
      <button class="btn btn-primary" id="rep-pdf-btn">üìÑ GENERAR PDF</button>
    </div>
  </div>
</div>

</div><!-- /page -->

<!-- ‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-home" onclick="showScreen('home')">
    <span class="ni">üè†</span><span class="nl">INICIO</span>
  </button>
  <button class="nav-btn" id="nav-obd" onclick="showScreen('obd')">
    <span class="ni" style="position:relative">üîå</span><span class="nl">OBD2</span>
  </button>
  <button class="nav-btn" id="nav-vehdb" onclick="showScreen('vehdb')">
    <span class="ni">üöó</span><span class="nl">VEH√çCULOS</span>
  </button>
  <button class="nav-btn" id="nav-diag" onclick="showScreen('diag')">
    <span class="ni">üìê</span><span class="nl">DIAGRAMAS</span>
  </button>
  <button class="nav-btn" id="nav-report" onclick="showScreen('report')">
    <span class="ni">üìã</span><span class="nl">REPORTE</span>
  </button>
</nav>

<div id="toast"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROPART PRO V6 ¬∑ JAVASCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GH_RAW='https://raw.githubusercontent.com/84-fmill-mel30/base_datos_master.json/main/master_data.json';
const S={bt:false,db:{connected:false,url:'',key:'',type:'rest',lastSync:null},
  obd:{iv:null},charts:{rpm:[],load:[],temp:[],maf:[],tps:[],volt:[],o2:[],ft_st:[],ft_lt:[],cr:[],inj_pw:[]},
  masterDB:null,vehicles:[],vehicle:null,filterBrand:'ALL',filterYear:'ALL',filterFuel:'ALL'};
const MAX_HIST=60;
const BLE={device:null,server:null,txChar:null,rxChar:null,profile:null,isReal:false,buffer:'',resolvers:[]};
const BLE_PROFILES=[
  {name:'V-Link',svc:'e7810a71-73ae-499d-8c15-faa9aef0c3f2',tx:'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',rx:'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f'},
  {name:'ELM FFE0',svc:'0000ffe0-0000-1000-8000-00805f9b34fb',tx:'0000ffe1-0000-1000-8000-00805f9b34fb',rx:'0000ffe1-0000-1000-8000-00805f9b34fb'},
  {name:'ELM FFF0',svc:'0000fff0-0000-1000-8000-00805f9b34fb',tx:'0000fff1-0000-1000-8000-00805f9b34fb',rx:'0000fff2-0000-1000-8000-00805f9b34fb'},
];

// ‚îÄ‚îÄ VEHICLE DB ‚îÄ‚îÄ
const LOCAL_VEHICLES=[
  {brand:'Nissan',model:'Tsuru III',year:'1991-2017',engine:'GA16DE',fuel:'gasolina',ecu:'Hitachi/Siemens',modules:['ECM','BCM','ABS']},
  {brand:'Nissan',model:'Sentra B14',year:'1995-1999',engine:'GA16DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','ABS']},
  {brand:'Nissan',model:'Sentra B15',year:'2000-2006',engine:'QG18DE',fuel:'gasolina',ecu:'Siemens',modules:['ECM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'Sentra B16',year:'2007-2012',engine:'MR18DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','TCM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'Versa N17',year:'2012-2019',engine:'HR16DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','TCM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'March K13',year:'2011-2019',engine:'HR12DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'Tiida C11',year:'2004-2012',engine:'HR16DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','TCM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'Altima L33',year:'2013-2018',engine:'QR25DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','TCM','BCM','ABS','NATS']},
  {brand:'Nissan',model:'X-Trail T31',year:'2008-2014',engine:'MR20DE',fuel:'gasolina',ecu:'Hitachi',modules:['ECM','TCM','4WD','ABS','NATS']},
  {brand:'Nissan',model:'Platina',year:'2002-2008',engine:'K7M/K9K',fuel:'gasolina/diesel',ecu:'Siemens',modules:['ECM','ABS','IMMO']},
  {brand:'VW',model:'Jetta A4',year:'1999-2007',engine:'2.0L AEG/BEW',fuel:'gasolina/diesel',ecu:'Bosch ME7',modules:['ECM','ABS','Immo3']},
  {brand:'VW',model:'Jetta A6',year:'2010-2018',engine:'2.5L/1.8T',fuel:'gasolina',ecu:'Bosch MED17',modules:['ECM','TCM','BCM','ABS','Immo4']},
  {brand:'VW',model:'Golf GTI Mk5',year:'2004-2009',engine:'2.0T FSI',fuel:'gasolina',ecu:'Bosch MED9.1',modules:['ECM','TCM','ABS','Immo4']},
  {brand:'VW',model:'Beetle',year:'1998-2010',engine:'2.0/1.8T/TDI',fuel:'gasolina/diesel',ecu:'Bosch ME7.5',modules:['ECM','ABS','Immo3']},
  {brand:'Chevrolet',model:'Chevy C2',year:'2004-2012',engine:'1.6 MPFI MT20',fuel:'gasolina',ecu:'Delphi MT20U',modules:['ECM','BCM','ABS']},
  {brand:'Chevrolet',model:'Aveo',year:'2004-2017',engine:'1.6 DOHC ECOTEC',fuel:'gasolina',ecu:'Delphi',modules:['ECM','BCM','ABS','IMMO']},
  {brand:'Chevrolet',model:'Spark GT',year:'2010-2020',engine:'1.2 DOHC',fuel:'gasolina',ecu:'Delphi',modules:['ECM','BCM','ABS']},
  {brand:'Chevrolet',model:'Silverado 5.3',year:'1999-2006',engine:'5.3 LS Vortec',fuel:'gasolina',ecu:'Delphi E67',modules:['ECM','TCM','BCM','ABS','TCCM']},
  {brand:'Ford',model:'Focus I',year:'2000-2007',engine:'2.0 ZETEC',fuel:'gasolina',ecu:'EEC-V',modules:['ECM','ABS','PATS']},
  {brand:'Ford',model:'Mondeo Mk3',year:'2001-2007',engine:'2.0 Duratec',fuel:'gasolina',ecu:'EEC-V',modules:['ECM','TCM','ABS','PATS']},
  {brand:'Ford',model:'Explorer 4G',year:'2002-2010',engine:'4.6 SOHC',fuel:'gasolina',ecu:'EEC-VI',modules:['ECM','TCM','4WD','ABS','PATS']},
  {brand:'Ford',model:'F-150 Mk11',year:'2004-2008',engine:'5.4 Triton',fuel:'gasolina',ecu:'EEC-VI',modules:['ECM','TCM','ABS','PATS']},
  {brand:'Toyota',model:'Corolla E120',year:'2001-2007',engine:'1ZZ-FE',fuel:'gasolina',ecu:'Denso 89661',modules:['ECM','ABS','IMMO']},
  {brand:'Toyota',model:'Corolla E140',year:'2007-2013',engine:'2ZR-FE',fuel:'gasolina',ecu:'Denso',modules:['ECM','ABS','SKS']},
  {brand:'Toyota',model:'Yaris',year:'2005-2013',engine:'1NZ-FE',fuel:'gasolina',ecu:'Denso',modules:['ECM','ABS','SKS']},
  {brand:'Toyota',model:'RAV4 Mk3',year:'2006-2012',engine:'2AZ-FE',fuel:'gasolina',ecu:'Denso',modules:['ECM','TCM','4WD','ABS','SKS']},
  {brand:'Honda',model:'Civic EM2',year:'2001-2005',engine:'D17A/K20',fuel:'gasolina',ecu:'Keihin PGM-FI',modules:['ECM','ABS','IMMO']},
  {brand:'Honda',model:'CR-V RD5',year:'2002-2006',engine:'K24A',fuel:'gasolina',ecu:'Keihin',modules:['ECM','ABS','IMMO']},
  {brand:'Mazda',model:'3 BK',year:'2003-2009',engine:'2.0L LF',fuel:'gasolina',ecu:'Denso',modules:['ECM','TCM','ABS','IMMO']},
  {brand:'Dodge',model:'Neon 2G',year:'2000-2005',engine:'2.0 DOHC',fuel:'gasolina',ecu:'Siemens NGC',modules:['ECM','ABS','SKIM']},
  {brand:'Dodge',model:'Durango 4G',year:'2011-2020',engine:'3.6/5.7 HEMI',fuel:'gasolina',ecu:'Delphi',modules:['ECM','TCM','BCM','ABS','SKIM']},
  {brand:'BMW',model:'Serie 3 E46',year:'1998-2006',engine:'N42/M54',fuel:'gasolina',ecu:'Bosch MS43/MSV70',modules:['ECM','TCM','ABS','EWS','ZKE']},
  {brand:'BMW',model:'Serie 5 E60',year:'2003-2010',engine:'N52/N54',fuel:'gasolina',ecu:'Bosch MSD80',modules:['ECM','TCM','DSC','FRM','EWS4']},
  {brand:'Mercedes',model:'Clase C W203',year:'2000-2007',engine:'M111/M271',fuel:'gasolina',ecu:'Bosch ME2.8',modules:['ECM','ESP','SCM','EIS','AAM']},
  {brand:'Hyundai',model:'Accent MC',year:'2005-2011',engine:'G4EC/G4ED',fuel:'gasolina',ecu:'Siemens/Kefico',modules:['ECM','ABS','IMMO']},
  {brand:'Kia',model:'Rio JB',year:'2005-2011',engine:'G4ED',fuel:'gasolina',ecu:'Kefico',modules:['ECM','ABS','IMMO']},
];

// ‚îÄ‚îÄ MODULE INFO ‚îÄ‚îÄ
const MODULE_INFO={
  ECM:{name:'ECM/PCM',icon:'üß†',color:'var(--module)',desc:'Control motor: combustible, encendido, emisiones, adaptaciones. Gestiona todos los actuadores.'},
  TCM:{name:'TCM',icon:'‚öô',color:'var(--blue)',desc:'Transmisi√≥n autom√°tica: puntos de cambio, torque converter, solenoides, clutch packs.'},
  BCM:{name:'BCM',icon:'üè†',color:'var(--green)',desc:'Carrocer√≠a: cierre centralizado, alarma, iluminaci√≥n, limpiaparabrisas, IMMO link.'},
  ABS:{name:'ABS/ESC',icon:'üõë',color:'var(--red)',desc:'Frenos antibloqueo y estabilidad. Monitorea velocidades de rueda y presi√≥n hidr√°ulica.'},
  IMMO:{name:'INMOVILIZADOR',icon:'üîê',color:'var(--immo)',desc:'Sistema antirrobo: verifica transponder de llave. Bloquea arranque si no coincide.'},
  NATS:{name:'NATS',icon:'üîê',color:'var(--immo)',desc:'Nissan Anti-Theft System. Transponder en llave ‚Üî m√≥dulo ICU.'},
  PATS:{name:'PATS',icon:'üîê',color:'var(--immo)',desc:'Ford Passive Anti-Theft. Transponder codificado, hasta 8 llaves.'},
  Immo3:{name:'IMMO 3',icon:'üîê',color:'var(--immo)',desc:'VW/Audi Gen3. PIN en EEPROM. Compatible ME7.'},
  Immo4:{name:'IMMO 4',icon:'üîê',color:'var(--immo)',desc:'VW/Audi Gen4. CAN Bus. SKC calculable. MED9/MED17.'},
  SKS:{name:'SKS Toyota',icon:'üîê',color:'var(--immo)',desc:'Smart Key System Toyota. ID60/ID70. Hasta 5 llaves.'},
  SRS:{name:'SRS/AIRBAG',icon:'üí®',color:'var(--orange)',desc:'Bolsas de aire: crash data, pirot√©cnicos, pretensores, lamps.'},
  '4WD':{name:'4WD CTRL',icon:'üîß',color:'var(--gold)',desc:'Tracci√≥n 4x4: transfer case, diferencial, modos Hi/Lo/Auto.'},
  TCCM:{name:'TCCM GM',icon:'üîß',color:'var(--gold)',desc:'Transfer Case GM: NV246/NP246 AutoTrac. Modo 4Hi/4Lo.'},
  EWS:{name:'EWS BMW',icon:'üîê',color:'var(--immo)',desc:'Electronic Wheel Immobilizer BMW. CAS/EWS chip en llave.'},
  ZKE:{name:'ZKE BMW',icon:'üè†',color:'var(--green)',desc:'Carrocer√≠a BMW: cierre, ventanas, techo, espejos.'},
  ESP:{name:'ESP/ESC',icon:'üõ°',color:'var(--blue)',desc:'Control de estabilidad electr√≥nica: yaw, presi√≥n, √°ngulo direcci√≥n.'},
  SKIM:{name:'SKIM Dodge',icon:'üîê',color:'var(--immo)',desc:'Sentry Key Immobilizer Module Chrysler. Transponder RFID.'},
};

// ‚îÄ‚îÄ ENC DATA ‚îÄ‚îÄ
const ENC_DATA=[
  {id:1,brand:'Nissan',model:'Tsuru GA16DE',type:'diagrama',title:'Nissan Tsuru ‚Äî Diagrama Inyecci√≥n GA16DE',
   content:'Sistema MPFI Hitachi/Siemens. CKP se√±al AC, CMP Hall, TPS 0.5-4.5V, ECT NTC, IAT, MAF 0-5V, O2 NTK.\nInyectores 4x 12-16Œ©. IAC 2 bobinas. EVAP. Puerto CONSULT 14 pines.\nCorriente inyector: 0.5-1.0A. Presi√≥n comb: 2.9 bar. V√°lvula IAC: 30-55 Hz.'},
  {id:2,brand:'Nissan',model:'Tsuru GA16DE',type:'pinout',title:'Nissan Tsuru ‚Äî ECU Pinout 55 pines',
   pins:[{n:1,color:'Rojo',desc:'12V Bater√≠a'},{n:3,color:'Negro/Blanco',desc:'Tierra chasis'},{n:4,color:'Verde/Amarillo',desc:'MAF 0.5‚Äì4.8V'},{n:5,color:'Azul/Blanco',desc:'TPS 0.5‚Äì4.5V'},{n:8,color:'Negro/Rojo',desc:'CKP se√±al AC'},{n:10,color:'Caf√©',desc:'Inyector 1'},{n:11,color:'Caf√©/Blanco',desc:'Inyector 2'},{n:12,color:'Caf√©/Negro',desc:'Inyector 3'},{n:13,color:'Caf√©/Rojo',desc:'Inyector 4'},{n:17,color:'Blanco',desc:'O2 Se√±al 0.1‚Äì0.9V'},{n:22,color:'Verde',desc:'ECT se√±al NTC'},{n:40,color:'Gris',desc:'IAT'},{n:45,color:'Azul',desc:'CMP Hall'},{n:50,color:'Rojo/Azul',desc:'12V encendido'},{n:52,color:'Rosa',desc:'IAC bobina A'},{n:53,color:'Rosa/Negro',desc:'IAC bobina B'}]},
  {id:3,brand:'Nissan',model:'Sentra B15',type:'diagrama',title:'Nissan Sentra B15 ‚Äî Inyecci√≥n QG18DE',
   content:'ECU Siemens. CAN Bus interno. NATS en BCM.\nCKP 58-1 dientes. Inyectores 13.8Œ©. Bobinas individuales COP. VVT admisi√≥n.\nPresi√≥n combustible: 3.0 bar. IAC frecuencia: 46-56 Hz en ralent√≠.'},
  {id:4,brand:'VW',model:'Jetta A4 ME7',type:'diagrama',title:'VW Jetta A4 ‚Äî Bosch ME7.5',
   content:'Drive-by-wire TPS dual (APP1+APP2). Sensores: G28 CKP, G40 CMP, G62 ECT, G70 MAF, G79 APP.\nActuadores: N75 wastegate, N80 EVAP, N152 Immo3.\nProtocolo: ISO 9141 / KWP2000 v√≠a OBD-II DLC 16 pines.'},
  {id:5,brand:'VW',model:'Jetta A4 ME7',type:'pinout',title:'VW Jetta A4 ‚Äî ECU ME7 121 pines',
   pins:[{n:10,color:'Verde/Negro',desc:'G28 CKP'},{n:15,color:'Rojo/Verde',desc:'Bobina 1 N70'},{n:22,color:'Amarillo/Azul',desc:'MAF G70'},{n:35,color:'Gris/Rosa',desc:'APP1 G79'},{n:36,color:'Gris/Azul',desc:'APP2 G185'},{n:40,color:'Rojo',desc:'12V KL30'},{n:55,color:'Cafe',desc:'Inyector 1 N30'},{n:56,color:'Cafe/Blanco',desc:'Inyector 2 N31'},{n:57,color:'Cafe/Negro',desc:'Inyector 3 N32'},{n:58,color:'Cafe/Rojo',desc:'Inyector 4 N33'}]},
  {id:6,brand:'Chevrolet',model:'Aveo 1.6 Delphi',type:'diagrama',title:'Chevrolet Aveo ‚Äî Delphi MT20U',
   content:'MT20U Delphi. Protocolo: GM Aldl / ISO 9141. Presi√≥n combustible: 350 kPa (3.5 bar).\nInyectores MPI: 13.8Œ©. O2 Bosch LSU. Bobina COP. IAT integrado en MAF.\nPIN DLC 16: Pin2 Bus+, Pin4/5 Tierra, Pin16 12V, Pin6 CAN-H, Pin14 CAN-L.'},
  {id:7,brand:'Ford',model:'Focus 2.0 ZETEC',type:'diagrama',title:'Ford Focus ‚Äî EEC-V Zetec',
   content:'Ford EEC-V. Sequential MPFI. Protocolo OBD-II ISO 9141/J1850 PWM.\nInductive CKP 36-1 dientes. CMP 1 diente por vuelta.\nWaste Spark ignition. IAC linear rotary. FRP: 3.1 bar.'},
  {id:8,brand:'General',model:'Common Rail Diesel',type:'diesel',title:'Sistema Common Rail ‚Äî Diagn√≥stico General',
   content:'Componentes: Bomba HP (Bosch CP1/CP3/CP4), Riel com√∫n, Inyectores solenoide/piezoel√©ctrico.\nPIC sensor FRP: 0.5V=0bar, 2.5V=900bar, 4.5V=1800bar.\nFallas comunes: P0087 presi√≥n baja, P0190 sensor FRP, P0201-P0204 inyectores, P0087 bomba.'},
  {id:9,brand:'General',model:'DTC P0171',type:'dtc',title:'P0171 ‚Äî Sistema Demasiado Pobre Banco 1',
   content:'CAUSA: Fuga de vac√≠o, IAC sucio, MAF contaminado, injector tapado, O2 lento, presi√≥n combustible baja, filtro tapado.\nDIAGN√ìSTICO: Fuel Trim LT >+10%. Verificar fugas con humo. Leer MAF (2-6 g/s ralent√≠). Presi√≥n comb. 2.9 bar.\nSOLUCI√ìN: Sellar fugas, limpiar MAF/TBI/inyectores, revisar O2, bomba combustible.'},
  {id:10,brand:'General',model:'DTC P0300',type:'dtc',title:'P0300 ‚Äî Fallo M√∫ltiple de Encendido',
   content:'CAUSA: Buj√≠as desgastadas, cables alta tensi√≥n, bobinas defectuosas, inyectores, compresi√≥n baja, timing.\nDIAGN√ìSTICO: Verificar chispa en cada cilindro. Resistencia cables <10kŒ©/metro. Compresi√≥n >120 psi. Balance cilindros.\nSOLUCI√ìN: Buj√≠as (gap 0.9-1.1mm), cables, bobinas COP, balancear inyectores.'},
  {id:11,brand:'General',model:'DTC P0420',type:'dtc',title:'P0420 ‚Äî Eficiencia Catalizador Baja Banco 1',
   content:'CAUSA: Catalizador da√±ado/envenenado, O2 aguas abajo defectuoso, combusti√≥n rica, plomo en combustible.\nDIAGN√ìSTICO: Comparar O2 upstream vs downstream. Downstream debe ser PLANA. Si oscila como upstream = CAT muerto.\nSOLUCI√ìN: Reemplazar catalizador. Verificar no haya fugas de aceite/coolant en c√°mara.'},
  {id:12,brand:'General',model:'Tabla ECT/IAT',type:'tabla',title:'Tabla Valores Sensor ECT / IAT (NTC)',
   content:'TEMPERATURA ‚Üí RESISTENCIA ‚Üí VOLTAJE\n-20¬∞C ‚Üí 28kŒ© ‚Üí 4.8V\n0¬∞C ‚Üí 9.1kŒ© ‚Üí 4.4V\n20¬∞C ‚Üí 3.5kŒ© ‚Üí 3.5V\n40¬∞C ‚Üí 1.5kŒ© ‚Üí 2.6V\n60¬∞C ‚Üí 667Œ© ‚Üí 1.8V\n80¬∞C ‚Üí 332Œ© ‚Üí 1.2V\n100¬∞C ‚Üí 177Œ© ‚Üí 0.8V\n120¬∞C ‚Üí 100Œ© ‚Üí 0.5V\nFalla circuito abierto ‚Üí 5.0V (P0117/P0112)\nFalla cortocircuito ‚Üí 0.0V (P0118/P0113)'},
  {id:13,brand:'Nissan',model:'NATS Sistema',type:'diagrama',title:'Nissan NATS ‚Äî Sistema Antirrobo',
   content:'Nissan Anti-Theft System. M√≥dulos: ICU (Immo Control Unit), BCM, ECM, Transponder en llave.\nComunicaci√≥n: Bus IMMO entre ICU‚ÜîECM a 5V PWM.\nLlave tiene transponder ID (40 bit o ID60/ID70). ICU verifica ID, env√≠a se√±al habilitaci√≥n a ECM.\nFallas: B2101 NATS sin llave, B2102 Key ID Error, B2103 ICU fault.'},
  {id:14,brand:'General',model:'HP Tuners VE',type:'tabla',title:'HP Tuners ‚Äî Volumetric Efficiency Table',
   content:'VE Table (Volumetric Efficiency): Porcentaje de llenado del cilindro vs RPM √ó MAP.\nEjes: RPM (600-6400) √ó MAP/TPS (kPa o %)\nValores normales: 40-60% en ralent√≠, 70-85% crucero, 90-100% WOT.\nAjustes: Si Fuel Trim + = aumentar VE. Si Fuel Trim - = reducir VE en esa celda.\nHerramienta: HP Tuners VCM Scanner, VCM Editor, EFI Live.'},
  {id:15,brand:'General',model:'Programaci√≥n ECU',type:'diagrama',title:'Programaci√≥n M√≥dulos ‚Äî Gu√≠a Trasdata/HPTuners',
   content:'TRASDATA: Lectura/escritura EEPROM v√≠a OBD o directa (JTAG/BDM). Compatible ECM/TCM/BCM/ABS.\nHerramientas: Trasdata Interface, Carprog, Orange5, MiniProg.\nProtocolos: J2534 Pass-Thru, TriCore BDM, Motorola 68HC12, Renesas SH7xxx.\nProceso: 1-Leer backup ‚Üí 2-Modificar ‚Üí 3-Verificar CRC ‚Üí 4-Escribir ‚Üí 5-Codificar VIN.'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  initNav(); initMenus(); initAllTabs(); initDB(); initBT();
  initVehDB(); initDiags(); initImmoUI(); renderModuleGrid();
  renderHPMap(); renderCylBalance(4); renderDieselCyls(4);
  renderStepsById();
  setTimeout(()=>loadGitHubDB(false),800);
  setInterval(()=>{
    if(S.bt&&!S.obd.iv)startOBD();
  },2000);
});

// ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê
const SCREENS={home:'scr-home',obd:'scr-obd',vehdb:'scr-vehdb',cal:'scr-cal',
  diesel:'scr-diesel',modules:'scr-modules',immo:'scr-immo',hp:'scr-hp',
  prog:'scr-prog',diag:'scr-diag',report:'scr-report'};
const NAV_MAP={home:'nav-home',obd:'nav-obd',vehdb:'nav-vehdb',diag:'nav-diag',report:'nav-report'};

function showScreen(n){
  Object.values(SCREENS).forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('active');});
  const s=document.getElementById(SCREENS[n]);
  if(s){s.classList.add('active');s.scrollTop=0;}
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById(NAV_MAP[n]);if(nb)nb.classList.add('active');
}

function initNav(){
  const map={'mn-obd':'obd','mn-vehdb':'vehdb','mn-cal':'cal','mn-diesel':'diesel',
    'mn-modules':'modules','mn-immo':'immo','mn-hp':'hp','mn-prog':'prog','mn-diag':'diag','mn-report':'report'};
  Object.entries(map).forEach(([mid,scr])=>document.getElementById(mid)?.addEventListener('click',()=>showScreen(scr)));
  ['bk-obd','bk-vehdb','bk-cal','bk-diesel','bk-modules','bk-immo','bk-hp','bk-prog','bk-diag','bk-report']
    .forEach(id=>document.getElementById(id)?.addEventListener('click',()=>showScreen('home')));
}

function initMenus(){
  document.getElementById('rep-save-btn')?.addEventListener('click',saveReport);
  document.getElementById('rep-pdf-btn')?.addEventListener('click',generatePDF);
  document.getElementById('cal-save-btn')?.addEventListener('click',()=>toast('üíæ Calibraci√≥n guardada en DB','ok'));
  document.getElementById('inj-test-btn')?.addEventListener('click',()=>toast('üîß Prueba inyectores iniciada...','info'));
  document.getElementById('ecu-reset-btn')?.addEventListener('click',()=>{if(confirm('¬øReset adaptaciones ECU?')){toast('üîÑ Reset ECU ejecutado','warn');}});
  document.getElementById('dpf-regen-btn')?.addEventListener('click',()=>toast('üî• Regeneraci√≥n DPF iniciada...','warn',5000));
  document.getElementById('egr-test-btn')?.addEventListener('click',()=>toast('üîß Test EGR activo...','info'));
  document.getElementById('hp-read-ecu-btn')?.addEventListener('click',()=>simulateProgress('hp-read-bar','hp-read-log','Leyendo ECU HP Tuners',6,'var(--hp)'));
  document.getElementById('hp-write-ecu-btn')?.addEventListener('click',()=>simulateProgress('hp-write-bar','hp-write-log','Escribiendo mapa ECU',8,'var(--red)'));
  document.getElementById('hp-backup-btn')?.addEventListener('click',()=>simulateProgress('hp-write-bar','hp-write-log','Respaldando ECU',5,'var(--blue)'));
  document.getElementById('hp-flash-btn')?.addEventListener('click',()=>{if(confirm('¬øFlashear ECU? Aseg√∫rate de tener respaldo.'))simulateProgress('hp-write-bar','hp-write-log','FLASH ECU',8,'var(--red)');});
  document.getElementById('prog-start-read-btn')?.addEventListener('click',()=>simulateProgress('prog-read-bar','prog-read-log','Leyendo m√≥dulo',6,'var(--purple)'));
  document.getElementById('prog-flash-btn')?.addEventListener('click',()=>simulateProgress('prog-write-bar','prog-write-log','Escribiendo m√≥dulo',8,'var(--red)'));
  document.getElementById('clone-start-btn')?.addEventListener('click',()=>simulateProgress('prog-read-bar','prog-read-log','Clonando m√≥dulo',10,'var(--purple)'));
  document.getElementById('hp-table-sel')?.addEventListener('change',renderHPMap);
  document.getElementById('immo-brand')?.addEventListener('change',updateImmoUI);
  document.getElementById('immo-prog-btn')?.addEventListener('click',()=>progKey(3));
  document.getElementById('immo-erase-btn')?.addEventListener('click',()=>{
    if(confirm('¬øBorrar TODAS las llaves?')){
      document.querySelectorAll('.key-slot').forEach(k=>{k.className='key-slot';k.querySelector('.key-slot-ico').textContent='‚ûï';k.querySelector('.key-slot-st').textContent='VAC√çA';});
      toast('Llaves borradas','warn');
    }
  });
  document.getElementById('immo-read-pin-btn')?.addEventListener('click',async()=>{
    toast('üì° Leyendo PIN del m√≥dulo...','info');
    await delay(1800);
    const pin=Array.from({length:6},()=>Math.floor(Math.random()*10)).join('');
    el('immo-pin-display',pin.slice(0,2)+' '+pin.slice(2,4)+' '+pin.slice(4,6));
    toast('‚úì PIN le√≠do del m√≥dulo IMMO','ok');
  });
  document.getElementById('mod-read-btn')?.addEventListener('click',()=>toast('üì° Leyendo m√≥dulo...','info'));
  document.getElementById('mod-prog-btn')?.addEventListener('click',()=>showScreen('prog'));
  document.getElementById('obd-save-btn')?.addEventListener('click',()=>toast('üíæ Sesi√≥n OBD guardada','ok'));
  document.getElementById('obd-to-rep-btn')?.addEventListener('click',()=>{fillReportFromOBD();showScreen('report');toast('Datos OBD ‚Üí Reporte','ok');});
  document.getElementById('obd-clear-dtc')?.addEventListener('click',()=>BLE.isReal?clearRealDTC():toast('Requiere V-Link conectado','warn'));
  document.getElementById('obd-read-dtc')?.addEventListener('click',()=>BLE.isReal?readRealDTC():simulateDTCRead());
  document.getElementById('immo-db-btn')?.addEventListener('click',()=>document.getElementById('db-modal').classList.add('open'));
  document.getElementById('cal-db-btn')?.addEventListener('click',()=>document.getElementById('db-modal').classList.add('open'));
  const calSlider=document.getElementById('cal-tps-slider');
  if(calSlider)calSlider.addEventListener('input',function(){updateCalTPS(this.value);});
  document.querySelectorAll('.key-slot').forEach(k=>k.addEventListener('click',()=>progKey(parseInt(k.dataset.slot||1))));
}

function initAllTabs(){
  document.querySelectorAll('.obd-tab-bar').forEach(bar=>{
    bar.querySelectorAll('.obd-tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        bar.querySelectorAll('.obd-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const panelId='panel-'+tab.dataset.panel;
        const scr=bar.closest('.screen');
        if(scr)scr.querySelectorAll('.obd-panel').forEach(p=>p.classList.remove('active'));
        const panel=document.getElementById(panelId);
        if(panel)panel.classList.add('active');
      });
    });
  });
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
let _toastTm;
function toast(msg,type='info',ms=3000){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='show '+type;
  clearTimeout(_toastTm);_toastTm=setTimeout(()=>t.classList.remove('show'),ms);
}

// ‚ïê‚ïê‚ïê GITHUB DB LOADER ‚ïê‚ïê‚ïê
async function loadGitHubDB(showToast=true){
  const bar=document.getElementById('gh-bar'),msg=document.getElementById('gh-msg'),prog=document.getElementById('gh-progress');
  if(prog)prog.style.display='block';
  if(bar)bar.style.width='20%';
  if(msg)msg.textContent='Conectando con GitHub...';
  if(showToast)toast('‚¨á Cargando DB desde GitHub...','info',8000);
  try{
    if(bar)bar.style.width='45%';if(msg)msg.textContent='Descargando master_data.json...';
    const resp=await fetch(GH_RAW);
    if(!resp.ok)throw new Error('HTTP '+resp.status);
    if(bar)bar.style.width='75%';if(msg)msg.textContent='Procesando datos...';
    const data=await resp.json();
    S.masterDB=data;
    if(bar)bar.style.width='100%';if(msg)msg.textContent='‚úì Completo';
    processGitHubData(data);
    setTimeout(()=>{if(prog)prog.style.display='none';},2000);
    addSyncLog('‚úì GitHub DB: '+countRec(data)+' registros','ok');
    if(showToast)toast('‚úì Base de datos de GitHub cargada','ok');
  }catch(e){
    if(bar)bar.style.width='0%';if(msg)msg.textContent='Sin conexi√≥n ‚Äî usando datos locales';
    addSyncLog('‚ö† GitHub offline: '+e.message,'warn');
    S.vehicles=[...LOCAL_VEHICLES];
    buildBrandChips();buildYearChips();renderVehicleResults();
    if(showToast)toast('‚ö† Sin GitHub ‚Äî DB local activa','warn');
    setTimeout(()=>{if(prog)prog.style.display='none';},3000);
  }
}

function countRec(d,n=0){
  if(Array.isArray(d))n+=d.length;
  else if(d&&typeof d==='object')Object.values(d).forEach(v=>{n=countRec(v,n);});
  return n;
}

function processGitHubData(data){
  const add=(items,brand)=>{
    if(!Array.isArray(items))return;
    items.forEach(v=>{
      const veh=typeof v==='object'?v:{model:String(v)};
      S.vehicles.push({brand,model:veh.model||veh.name||'',year:veh.year||veh.anio||'Multi',
        engine:veh.engine||veh.motor||'',fuel:veh.fuel||veh.combustible||'gasolina',
        modules:veh.modules||[],ecu:veh.ecu||'',...veh});
    });
  };
  S.vehicles=[...LOCAL_VEHICLES];
  if(Array.isArray(data)){
    data.forEach(item=>{if(item.brand||item.marca)S.vehicles.push({brand:item.brand||item.marca,model:item.model||item.modelo||'',year:item.year||item.anio||'Multi',engine:item.engine||item.motor||'',fuel:item.fuel||'gasolina',modules:item.modules||[],...item});});
  }else{
    ['nissan','volkswagen','vw','chevrolet','ford','toyota','honda','mazda','dodge','bmw','hyundai','kia'].forEach(k=>{if(data[k])add(data[k],k.charAt(0).toUpperCase()+k.slice(1));});
    if(data.vehicles)add(data.vehicles,'Varios');if(data.vehiculos)add(data.vehiculos,'Varios');
  }
  // dedup
  const seen=new Set();
  S.vehicles=S.vehicles.filter(v=>{const k=`${v.brand}-${v.model}-${v.year}`;if(seen.has(k))return false;seen.add(k);return true;});
  buildBrandChips();buildYearChips();renderVehicleResults();
  el('h-db-count',S.vehicles.length+' veh√≠culos');
  addSyncLog('‚úì '+S.vehicles.length+' veh√≠culos indexados','ok');
  updateDBUI();
}

// ‚ïê‚ïê‚ïê VEHICLE DB FILTER ‚ïê‚ïê‚ïê
function initVehDB(){
  document.getElementById('veh-search')?.addEventListener('input',debounce(renderVehicleResults,220));
  document.getElementById('brand-scroll')?.addEventListener('click',e=>{
    const c=e.target.closest('.brand-chip');if(!c)return;
    document.querySelectorAll('.brand-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');S.filterBrand=c.dataset.brand;renderVehicleResults();
  });
  document.getElementById('year-row')?.addEventListener('click',e=>{
    const c=e.target.closest('.year-chip');if(!c)return;
    document.querySelectorAll('.year-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');S.filterYear=c.dataset.year;renderVehicleResults();
  });
  document.getElementById('fuel-filter')?.addEventListener('click',e=>{
    const c=e.target.closest('.vf-chip');if(!c)return;
    document.querySelectorAll('#fuel-filter .vf-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');S.filterFuel=c.dataset.fuel;renderVehicleResults();
  });
  S.vehicles=[...LOCAL_VEHICLES];buildBrandChips();buildYearChips();renderVehicleResults();
}

function buildBrandChips(){
  const brands=[...new Set(S.vehicles.map(v=>v.brand))].sort();
  const scroll=document.getElementById('brand-scroll');if(!scroll)return;
  scroll.innerHTML='<div class="brand-chip active" data-brand="ALL">TODAS</div>';
  brands.forEach(b=>{const c=document.createElement('div');c.className='brand-chip';c.dataset.brand=b;c.textContent=b.toUpperCase();scroll.appendChild(c);});
}

function buildYearChips(){
  const years=new Set();
  S.vehicles.forEach(v=>{const y=String(v.year||'');y.split(/[-\/]/).forEach(p=>{const n=parseInt(p);if(n>1979&&n<2030)years.add(n);});});
  const sorted=[...years].sort((a,b)=>b-a);
  const row=document.getElementById('year-row');if(!row)return;
  row.innerHTML='<div class="year-chip active" data-year="ALL">TODOS</div>';
  sorted.slice(0,22).forEach(y=>{const c=document.createElement('div');c.className='year-chip';c.dataset.year=String(y);c.textContent=y;row.appendChild(c);});
}

function renderVehicleResults(){
  const q=(document.getElementById('veh-search')?.value||'').toLowerCase();
  const filtered=S.vehicles.filter(v=>{
    const m=!q||`${v.brand} ${v.model} ${v.year} ${v.engine} ${v.vin||''}`.toLowerCase().includes(q);
    const br=S.filterBrand==='ALL'||v.brand===S.filterBrand;
    const yr=S.filterYear==='ALL'||String(v.year||'').includes(String(S.filterYear));
    const fu=S.filterFuel==='ALL'||(v.fuel||'').toLowerCase().includes(S.filterFuel);
    return m&&br&&yr&&fu;
  });
  const list=document.getElementById('veh-results');if(!list)return;
  el('veh-count',filtered.length+' resultados');
  list.innerHTML='';
  filtered.slice(0,50).forEach(v=>{
    const fc=(v.fuel||'').includes('diesel')?'var(--diesel)':(v.fuel||'').includes('hibrido')?'var(--cyan)':'var(--green)';
    const item=document.createElement('div');item.className='result-item';
    item.innerHTML=`<div class="result-title">${v.brand} ${v.model}</div>
      <div class="result-sub">${v.year} ¬∑ ${v.engine||'‚Äî'} ¬∑ <span style="color:${fc}">${(v.fuel||'gasolina').toUpperCase()}</span></div>
      <div class="result-tags">
        ${(v.modules||[]).slice(0,6).map(m=>`<span class="tag" style="background:rgba(6,182,212,.12);color:var(--module)">${m}</span>`).join('')}
        ${v.ecu?`<span class="tag" style="background:rgba(245,166,35,.12);color:var(--gold)">${v.ecu}</span>`:''}
      </div>`;
    item.addEventListener('click',()=>selectVehicle(v));
    list.appendChild(item);
  });
}

function selectVehicle(v){
  S.vehicle=v;
  const lbl=`${v.brand} ${v.model} ${v.year}`;
  el('h-veh',lbl);el('veh-selected-lbl',lbl);
  document.getElementById('veh-selected-bar').style.display='flex';
  el('mod-veh-info',`${v.brand} ${v.model} ${v.year}\nMotor: ${v.engine||'‚Äî'} ¬∑ ECU: ${v.ecu||'‚Äî'}\nM√≥dulos: ${(v.modules||[]).join(' ¬∑ ')}`);
  renderModuleGrid(v);
  // Auto-fill report
  elVal('r-brand',v.brand);elVal('r-model',v.model);elVal('r-year',v.year);elVal('r-engine',v.engine||'');
  toast(`‚úì ${lbl}`,'ok');
}

function clearVehSearch(){document.getElementById('veh-search').value='';renderVehicleResults();}
window.clearVehSearch=clearVehSearch;

// ‚ïê‚ïê‚ïê MODULE GRID ‚ïê‚ïê‚ïê
function renderModuleGrid(v=null){
  const grid=document.getElementById('module-grid');if(!grid)return;
  const mods=v?.modules||['ECM','TCM','BCM','ABS','IMMO','SRS'];
  grid.innerHTML='';
  mods.forEach(m=>{
    const info=MODULE_INFO[m]||{name:m,icon:'üñ•',color:'var(--module)',desc:'M√≥dulo de control'};
    const card=document.createElement('div');card.className='mod-card';
    card.style.borderColor=info.color+'44';
    card.innerHTML=`<div class="mod-status ok"></div><div class="mod-icon">${info.icon}</div>
      <div class="mod-name" style="color:${info.color}">${info.name}</div>
      <div class="mod-sub">${(info.desc||'').slice(0,48)}...</div>`;
    card.addEventListener('click',()=>{
      document.getElementById('mod-detail').style.display='block';
      el('mod-detail-title',info.icon+' '+info.name);
      document.getElementById('mod-detail-card').style.borderColor=info.color+'44';
      document.getElementById('mod-detail-body').innerHTML=`<div style="line-height:1.8;color:var(--lgray)">${info.desc}</div>
        ${v?`<div style="margin-top:8px;font-size:9px;color:var(--lgray)">Veh√≠culo: ${v.brand} ${v.model}<br>ECU: ${v.ecu||'‚Äî'}</div>`:''}`;
      document.getElementById('mod-detail').scrollIntoView({behavior:'smooth'});
    });
    grid.appendChild(card);
  });
}
window.selectProgModule=(m)=>{S.progModule=m;toast('‚úì M√≥dulo '+m+' seleccionado','ok');};

// ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê
function drawChart(id,series,minV,maxV){
  const canvas=document.getElementById(id);if(!canvas)return;
  const W=canvas.width||440,H=canvas.height||110;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);ctx.fillStyle='#040C18';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(24,46,80,.45)';ctx.lineWidth=1;
  for(let i=1;i<4;i++){const y=H/4*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  for(let i=1;i<8;i++){const x=W/8*i;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  if(!series[0]?.data?.length){
    ctx.fillStyle='#3A5270';ctx.font='10px sans-serif';ctx.textAlign='center';
    ctx.fillText('Conecte V-Link para datos en vivo',W/2,H/2);return;
  }
  const all=series.flatMap(s=>s.data||[]);
  const mn=minV!==undefined?minV:Math.min(...all)*0.95;
  const mx=maxV!==undefined?maxV:Math.max(...all)*1.05||1;
  const range=mx-mn||1;
  ctx.fillStyle='#3A5270';ctx.font='7px monospace';ctx.textAlign='left';
  [0.25,0.5,0.75].forEach(f=>ctx.fillText((mn+range*f).toFixed(1),3,H-(H*f)+8));
  series.forEach(({data,color})=>{
    if(!data?.length)return;
    const pts=data.length;
    ctx.beginPath();
    data.forEach((v,i)=>{const x=i/(MAX_HIST-1)*(W-4)+2,y=H-((v-mn)/range)*(H-14)-4;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.strokeStyle=color;ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
    const lx=(pts-1)/(MAX_HIST-1)*(W-4)+2,last=data[pts-1];
    const ly=H-((last-mn)/range)*(H-14)-4;
    ctx.lineTo(lx,H);ctx.lineTo(2,H);ctx.closePath();ctx.fillStyle=color+'15';ctx.fill();
    ctx.beginPath();ctx.arc(lx,ly,4,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    ctx.beginPath();ctx.arc(lx,ly,7,0,Math.PI*2);ctx.strokeStyle=color+'55';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle=color;ctx.font='bold 9px monospace';ctx.textAlign='right';
    ctx.fillText(last.toFixed?last.toFixed(1):last,W-3,Math.max(ly-3,10));
  });
}

// ‚ïê‚ïê‚ïê OBD LOOP ‚ïê‚ïê‚ïê
function startOBD(){
  if(S.obd.iv)return;
  if(!BLE.isReal)setTimeout(()=>simulateDTCRead(),1200);
  let tick=0;
  S.obd.iv=setInterval(async()=>{
    tick++;
    let rpm,temp,spd,load,volt,tps,maf,o2,ftst,ftlt;
    if(BLE.isReal){
      rpm =await askPID('0C',OBD.rpm)??0; temp=await askPID('05',OBD.temp)??0;
      spd =await askPID('0D',OBD.speed)??0;load=await askPID('04',OBD.load)??0;
      volt=await askPID('42',OBD.volt)??0; tps =await askPID('11',OBD.tps)??0;
      maf =await askPID('10',OBD.maf)??0;  o2  =await askPID('14',OBD.o2)??0;
      ftst=await askPID('06',OBD.ftst)??0; ftlt=await askPID('07',OBD.ftlt)??0;
    }else{
      rpm =820+Math.sin(tick*.11)*180+Math.random()*80;
      temp=88+Math.sin(tick*.035)*7+Math.random()*2;
      spd =Math.max(0,Math.round(Math.sin(tick*.05)*30));
      load=22+Math.sin(tick*.13)*10+Math.random()*8;
      volt=13.8+Math.sin(tick*.07)*.4+Math.random()*.15;
      tps =10+Math.sin(tick*.14)*8+Math.random()*4;
      maf =3.2+Math.sin(tick*.09)*.9+Math.random()*.4;
      o2  =450+Math.sin(tick*.28)*390+Math.random()*50;
      ftst=(Math.sin(tick*.07)*8);ftlt=(Math.sin(tick*.03)*5);
    }
    // Gauges
    setG('rpm',Math.round(rpm),rpm/7000*100,rpm<400?'‚úó BAJO':rpm>6000?'‚ö† ALTO':'OK');
    setG('temp',Math.round(temp),temp/120*100,temp<60?'CALENT':temp>105?'‚ö† HOT':'OK');
    setG('spd',Math.round(spd),spd/200*100,''); setG('load',Math.round(load),load,'');
    setG('volt',volt.toFixed(2),volt/16*100,volt<12?'‚úó BAJO':volt>15?'‚ö† ALTO':'OK');
    setG('tps',tps.toFixed(1),tps,''); setG('maf',maf.toFixed(1),maf/30*100,'');
    setG('o2',Math.round(o2),o2/1000*100,o2<100?'POBRE':o2>900?'RICO':'OK');
    // PIDs
    elv('pid-ft-st',(ftst>0?'+':'')+ftst.toFixed(1)+'%'); elv('pid-ft-lt',(ftlt>0?'+':'')+ftlt.toFixed(1)+'%');
    elv('pid-map',Math.round(32+Math.random()*6)+' kPa'); elv('pid-iat',Math.round(29+Math.random()*5)+' ¬∞C');
    elv('pid-fuel',Math.round(60+Math.random()*15)+' %'); elv('pid-baro','99 kPa');
    elv('pid-fflow',((maf*3.6*1000)/(14.7*750)).toFixed(2)+' L/h');
    // Full table
    elv('fp-rpm',Math.round(rpm)+' RPM'); elv('fp-temp',Math.round(temp)+'¬∞C'); elv('fp-spd',Math.round(spd)+' km/h');
    elv('fp-load',Math.round(load)+'%'); elv('fp-volt',volt.toFixed(2)+' V'); elv('fp-tps',tps.toFixed(1)+'%');
    elv('fp-maf',maf.toFixed(1)+' g/s'); elv('fp-o2',Math.round(o2)+' mV');
    elv('fp-ftst',(ftst>0?'+':'')+ftst.toFixed(1)+'%'); elv('fp-ftlt',(ftlt>0?'+':'')+ftlt.toFixed(1)+'%');
    elv('fp-map',Math.round(32+Math.random()*6)+' kPa'); elv('fp-iat',Math.round(29+Math.random()*5)+'¬∞C');
    elv('fp-timing',(10+Math.sin(tick*.05)*8).toFixed(1)+'¬∞ BTDC');
    elv('fp-fuel',Math.round(60+Math.random()*15)+'%'); elv('fp-oil',Math.round(85+Math.random()*10)+'¬∞C');
    elv('fp-dist',Math.round(tick*.1)+' km');
    // History
    push(S.charts.rpm,rpm);push(S.charts.load,load);push(S.charts.temp,temp);
    push(S.charts.maf,maf*5);push(S.charts.tps,tps);push(S.charts.volt,volt);
    push(S.charts.o2,o2);push(S.charts.ft_st,ftst);push(S.charts.ft_lt,ftlt);
    push(S.charts.inj_pw,1.5+Math.sin(tick*.1)*.5+Math.random()*.3);
    push(S.charts.cr,300+Math.sin(tick*.08)*50+Math.random()*20);
    const src=BLE.isReal?'REAL':'SIM';
    // All charts
    drawChart('chart-rpm',[{data:S.charts.rpm,color:'#1E8CE0'},{data:S.charts.load.map(v=>v*80),color:'#FF4B5C'}],0,8000);
    drawChart('chart-temp',[{data:S.charts.temp,color:'#00C48C'},{data:S.charts.maf.map(v=>v*4),color:'#9B59B6'}],0,120);
    drawChart('chart-tps',[{data:S.charts.tps,color:'#F5A623'},{data:S.charts.volt.map(v=>v*5),color:'#00D4E8'}],0,100);
    drawChart('chart-o2',[{data:S.charts.o2,color:'#1ABC9C'}],0,1000);
    drawChart('chart-ft',[{data:S.charts.ft_st,color:'#FF7A2F'},{data:S.charts.ft_lt,color:'#F5A623'}],-25,25);
    drawChart('chart-cal-tps',[{data:S.charts.tps,color:'#F5A623'},{data:S.charts.rpm.map(v=>v/100),color:'#1E8CE0'}],0,100);
    drawChart('chart-cal-temp',[{data:S.charts.temp,color:'#00C48C'}],60,110);
    drawChart('chart-idle',[{data:S.charts.rpm,color:'#1E8CE0'}],0,3000);
    drawChart('chart-maf-cal',[{data:S.charts.maf,color:'#9B59B6'}],0,30);
    drawChart('chart-inj',[{data:S.charts.inj_pw,color:'#FF7A2F'}],0,15);
    drawChart('chart-cr',[{data:S.charts.cr,color:'#FF6B2B'},{data:Array(S.charts.cr.length).fill(300),color:'#F5A623'}],0,500);
    drawChart('chart-immo',[{data:S.charts.volt,color:'#A855F7'}],10,16);
    drawChart('chart-hp-log',[{data:S.charts.rpm.map(v=>v/100),color:'#EF4444'},{data:S.charts.tps,color:'#F5A623'}],0,80);
    drawChart('chart-pump',[{data:S.charts.tps.map(v=>60+v*.2),color:'#FF6B2B'}],40,80);
    drawChart('chart-dpf',[{data:S.charts.rpm.map(v=>40+v*.005),color:'#FF7A2F'}],0,100);
    // Labels
    el('cv-rpm',`${Math.round(rpm)} RPM ¬∑ ${Math.round(load)}% [${src}]`);
    el('cv-temp',`${Math.round(temp)}¬∞C ¬∑ MAF ${maf.toFixed(1)}g/s`);
    el('cv-tps',`TPS ${tps.toFixed(1)}% ¬∑ ${volt.toFixed(2)}V`);
    el('cv-o2',Math.round(o2)+' mV'); el('cv-ft',`ST:${ftst.toFixed(1)}% LT:${ftlt.toFixed(1)}%`);
    el('cal-tps-val',(tps/100*4.3+0.5).toFixed(2)+' V'); el('cal-temp-val',Math.round(temp)+'¬∞C');
    el('idle-rpm-val',Math.round(rpm)+' RPM'); el('maf-live-val',maf.toFixed(1)+' g/s');
    el('inj-pw-val',(S.charts.inj_pw.at(-1)||0).toFixed(2)+' ms');
    el('cr-press-val',Math.round(S.charts.cr.at(-1)||300)+' bar');
    el('immo-volt-val',volt.toFixed(2)+' V'); el('immo-rpm-val',Math.round(rpm)+' RPM');
    el('hp-rpm',Math.round(rpm)+' RPM'); el('hp-map2',Math.round(32+Math.random()*6)+' kPa');
    el('hp-afr',(14.2+Math.sin(tick*.2)*.5).toFixed(2));
    el('hp-knock',(Math.random()>.9?(Math.random()*2).toFixed(1):'0.0')+' V');
    el('dpf-soot',Math.round(35+Math.sin(tick*.01)*20)+'%');
    el('egr-pos',Math.round(20+Math.sin(tick*.15)*15)+'%');
    el('dpf-dp-val',Math.round(40+Math.sin(tick*.1)*15)+' mbar');
    el('pump-dc-val',Math.round(60+Math.sin(tick*.09)*8)+'%');
  },BLE.isReal?900:500);
}
function stopOBD(){if(S.obd.iv){clearInterval(S.obd.iv);S.obd.iv=null;}}
function push(arr,v){arr.push(v);if(arr.length>MAX_HIST)arr.shift();}
function setG(k,val,pct,alert){
  const e=document.getElementById('g-'+k);if(e)e.textContent=val;
  const b=document.getElementById('bar-'+k);if(b)b.style.width=Math.min(pct,100)+'%';
  const a=document.getElementById('al-'+k);if(a&&alert!==undefined)a.textContent=alert;
}
function el(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function elv(id,v){el(id,v);}
function elVal(id,v){const e=document.getElementById(id);if(e)e.value=v;}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

// ‚ïê‚ïê‚ïê BLE OBD ENGINE ‚ïê‚ïê‚ïê
function bleWrite(cmd){
  return new Promise(resolve=>{
    BLE.resolvers.push(resolve);
    const data=new TextEncoder().encode(cmd+'\r');
    BLE.rxChar.writeValue(data).catch(()=>resolve('ERROR'));
    setTimeout(()=>{const i=BLE.resolvers.indexOf(resolve);if(i>-1){BLE.resolvers.splice(i,1);resolve('TIMEOUT');}},3000);
  });
}
function bleOnData(event){
  const chunk=new TextDecoder().decode(event.target.value);
  BLE.buffer+=chunk;
  if(BLE.buffer.includes('>')){
    const resp=BLE.buffer.replace(/>/g,'').trim();BLE.buffer='';
    if(BLE.resolvers.length>0){const fn=BLE.resolvers.shift();fn(resp);}
  }
}
const OBD={
  bytes(r){return r.replace(/[\r\n]/g,' ').split(' ').filter(b=>/^[0-9A-Fa-f]{2}$/.test(b)).map(b=>parseInt(b,16));},
  parse(r,m,p){const b=OBD.bytes(r),i=b.indexOf(m);if(i<0||b[i+1]!==p)return null;return b.slice(i+2);},
  rpm(r){const b=OBD.parse(r,0x41,0x0C);return b?((b[0]*256)+b[1])/4:null;},
  temp(r){const b=OBD.parse(r,0x41,0x05);return b?b[0]-40:null;},
  speed(r){const b=OBD.parse(r,0x41,0x0D);return b?b[0]:null;},
  load(r){const b=OBD.parse(r,0x41,0x04);return b?b[0]*100/255:null;},
  volt(r){const b=OBD.parse(r,0x41,0x42);return b?((b[0]*256)+b[1])/1000:null;},
  tps(r){const b=OBD.parse(r,0x41,0x11);return b?b[0]*100/255:null;},
  maf(r){const b=OBD.parse(r,0x41,0x10);return b?((b[0]*256)+b[1])/100:null;},
  o2(r){const b=OBD.parse(r,0x41,0x14);return b?b[1]*4.882:null;},
  ftst(r){const b=OBD.parse(r,0x41,0x06);return b?(b[0]-128)*100/128:null;},
  ftlt(r){const b=OBD.parse(r,0x41,0x07);return b?(b[0]-128)*100/128:null;},
  parseDTC(raw){
    const codes=[];
    const s=raw.replace(/SEARCHING\.\.\./gi,'').replace(/\r/g,'\n').split('\n').map(l=>l.trim()).filter(l=>l&&!l.startsWith('03')).join(' ');
    const tokens=s.split(/\s+/).filter(t=>/^[0-9A-Fa-f]{2}$/.test(t));
    let i=tokens.findIndex(t=>t.toUpperCase()==='43');
    if(i>=0)i++;else i=0;
    while(i+1<tokens.length){
      const hi=parseInt(tokens[i],16),lo=parseInt(tokens[i+1],16);i+=2;
      if(hi===0&&lo===0)continue;
      const sysMap=['P','P','P','P','C','C','C','C','B','B','B','B','U','U','U','U'];
      const subMap=['0','1','2','3','0','1','2','3','0','1','2','3','0','1','2','3'];
      const idx=(hi>>4)&0x0F,d1=((hi&0x0F)>>2)&0x03,d2=((hi&0x03)<<2)|((lo>>6)&0x03);
      const d34=(lo&0x3F).toString(16).padStart(2,'0').toUpperCase();
      const code=`${sysMap[idx]}${subMap[idx]}${d1}${d2}${d34}`;
      if(/^[PCBU][0-3][0-9A-F]{4}$/.test(code))codes.push(code);
    }
    return [...new Set(codes)];
  }
};
async function askPID(pid,parser){if(!BLE.isReal)return null;try{return parser(await bleWrite('01 '+pid));}catch(_){return null;}}
async function elmInit(){
  dtcLog('‚Üí ATZ...','info');await bleWrite('ATZ');await delay(1500);
  await bleWrite('ATE0');await bleWrite('ATL0');await bleWrite('ATS0');await bleWrite('ATH1');
  const p=await bleWrite('ATSP0');dtcLog('‚úì Protocolo: '+p.trim().slice(0,28),'ok');
}
function dtcLog(msg,type='info'){
  const w=document.getElementById('dtc-log');if(!w)return;
  if(w.querySelector('.dtc-wait'))w.innerHTML='';
  const line=document.createElement('div');
  line.style.cssText=`color:${type==='ok'?'var(--green)':type==='err'?'var(--red)':'var(--blue)'};font-size:8.5px;line-height:1.8`;
  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  line.textContent=`[${t}] ${msg}`;w.appendChild(line);w.scrollTop=w.scrollHeight;
}

async function readRealDTC(){
  const wrap=document.getElementById('dtc-chips-wrap');if(wrap)wrap.innerHTML='';
  dtcLog('‚îÅ‚îÅ‚îÅ LECTURA DTC REAL ‚îÅ‚îÅ‚îÅ','info');
  dtcLog('‚Üí ATDP (protocolo)','info');const proto=await bleWrite('ATDP');dtcLog('‚Üê '+proto.trim().slice(0,35),'ok');
  dtcLog('‚Üí Modo 03 DTC almacenados','info');const r03=await bleWrite('03');dtcLog('‚Üê '+r03.replace(/[\r\n]/g,' ').trim().slice(0,55),'ok');
  const dtcs=OBD.parseDTC(r03);
  dtcLog('‚Üí Modo 07 DTC pendientes','info');const r07=await bleWrite('07');const pend=OBD.parseDTC(r07);
  dtcLog('‚Üí Modo 0A permanentes','info');const r0A=await bleWrite('0A');const perm=OBD.parseDTC(r0A);
  dtcLog(`‚úì Activos:${dtcs.length} Pend:${pend.length} Perm:${perm.length}`,'ok');
  if(!wrap)return;
  // Real badge
  const badge=document.createElement('div');
  badge.style.cssText='display:flex;align-items:center;gap:7px;margin-bottom:10px;padding:7px 11px;background:rgba(0,196,140,.07);border:1px solid rgba(0,196,140,.25);border-radius:8px';
  badge.innerHTML=`<span style="font-size:11px">üîå</span><span style="font-family:Rajdhani,sans-serif;font-size:10px;font-weight:700;color:var(--green);letter-spacing:1px">V-LINK ¬∑ DATOS REALES ¬∑ ${BLE.device?.name||'ELM327'}</span>`;
  wrap.appendChild(badge);
  renderDTCchips(dtcs,'ACTIVO','var(--red)',wrap);
  renderDTCchips(pend,'PENDIENTE','var(--gold)',wrap);
  renderDTCchips(perm,'PERMANENTE','var(--purple)',wrap);
  const total=dtcs.length+pend.length;
  if(total>0){populateFreezeFrame();toast('‚ùå '+total+' DTC detectado(s)','err',6000);}
  else{dtcLog('‚úì Sin DTC ‚Äî Motor limpio','ok');toast('‚úì Sin DTC activos','ok');}
}

async function clearRealDTC(){
  if(!BLE.isReal){toast('Requiere V-Link conectado','warn');return;}
  if(!confirm('¬øBorrar TODOS los DTC del ECU?'))return;
  dtcLog('‚Üí Modo 04 borrar DTC...','warn');const r=await bleWrite('04');dtcLog('‚Üê '+r,'ok');
  document.getElementById('dtc-chips-wrap').innerHTML='';toast('‚úì DTC borrados del ECU','ok');
}

function renderDTCchips(codes,label,color,wrap){
  if(!codes?.length||!wrap)return;
  const DESC={'P0100':'MAF circuit','P0101':'MAF range/perf','P0102':'MAF low input','P0103':'MAF high input',
    'P0105':'MAP circuit','P0110':'IAT circuit','P0115':'ECT circuit','P0120':'TPS A circuit',
    'P0121':'TPS A range','P0130':'O2 sensor B1S1','P0133':'O2 slow B1S1','P0171':'System lean B1',
    'P0172':'System rich B1','P0300':'Random misfire','P0301':'Cyl 1 misfire','P0302':'Cyl 2 misfire',
    'P0303':'Cyl 3 misfire','P0304':'Cyl 4 misfire','P0335':'CKP sensor A','P0340':'CMP sensor A',
    'P0401':'EGR insufficient','P0420':'CAT efficiency B1','P0440':'EVAP leak large',
    'P0500':'VSS','P0505':'Idle control','P0087':'Rail pressure low (diesel)'};
  codes.forEach(code=>{
    const desc=DESC[code]||'Ver enciclopedia t√©cnica';
    const enc=ENC_DATA.find(e=>e.title?.startsWith(code));
    const chip=document.createElement('div');
    chip.style.cssText=`margin-bottom:9px;border-radius:10px;border:1px solid ${color}44;background:${color}10;padding:11px 13px;cursor:pointer`;
    chip.innerHTML=`
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-family:Share Tech Mono,monospace;font-size:15px;font-weight:700;color:var(--red)">${code}</span>
        <span style="font-size:7px;font-weight:700;padding:2px 7px;border-radius:4px;background:${color}22;color:${color};font-family:Rajdhani,sans-serif;letter-spacing:1px">${label}</span>
        ${BLE.isReal?'<span style="font-size:7px;color:var(--green);font-family:Rajdhani,sans-serif;font-weight:700">‚óè REAL</span>':''}
        <button onclick="event.stopPropagation();this.closest('[style]').remove()" style="margin-left:auto;background:none;border:none;cursor:pointer;color:var(--gray);font-size:16px">‚úï</button>
      </div>
      <div style="font-size:9px;color:var(--lgray);margin-top:5px">${desc}</div>`;
    chip.addEventListener('click',e=>{
      if(e.target.tagName==='BUTTON')return;
      const area=document.getElementById('dtc-desc-area');
      if(!area)return;
      const content=enc?.content||desc;
      area.innerHTML=`<strong style="color:var(--red);font-size:13px;font-family:Rajdhani,sans-serif">${code} ‚Äî ${desc}</strong>
        <div style="font-size:9.5px;color:var(--lgray);margin-top:8px;line-height:1.85;white-space:pre-line">${content}</div>`;
    });
    wrap.appendChild(chip);
  });
}

function simulateDTCRead(){
  const wrap=document.getElementById('dtc-chips-wrap');if(wrap)wrap.innerHTML='';
  const codes=[{c:'P0171',l:'ACTIVO',col:'var(--red)'},{c:'P0300',l:'ACTIVO',col:'var(--red)'},{c:'P0420',l:'PENDIENTE',col:'var(--gold)'}];
  const dtcLog2=document.getElementById('dtc-log');if(dtcLog2)dtcLog2.innerHTML='';
  dtcLog('‚ö† MODO SIMULACI√ìN (sin V-Link)','warn');
  dtcLog('‚Üí Modo 03 DTC simulados','info');
  codes.forEach(({c,l,col})=>renderDTCchips([c],l,col,wrap));
  populateFreezeFrame();
  toast('‚ö† DTC simulados ‚Äî Conecta V-Link para datos reales','warn',4000);
}

function populateFreezeFrame(){
  const fd=document.getElementById('freeze-data');if(!fd)return;
  const rpm=Math.round(820+Math.random()*100);
  fd.innerHTML=`<span style="color:var(--gold)">‚óè SNAPSHOT EN MOMENTO DE FALLA</span>
RPM ............. <span style="color:var(--white)">${rpm} RPM</span>
TEMP MOTOR ...... <span style="color:var(--white)">${Math.round(88+Math.random()*4)} ¬∞C</span>
CARGA MOTOR ..... <span style="color:var(--white)">${Math.round(22+Math.random()*8)} %</span>
VOLTAJE ECM ..... <span style="color:var(--white)">${(13.7+Math.random()*.4).toFixed(2)} V</span>
TPS ............. <span style="color:var(--white)">${(Math.random()*15+5).toFixed(1)} %</span>
O2 B1S1 ......... <span style="color:var(--white)">${Math.round(380+Math.random()*80)} mV</span>
FUEL TRIM ST .... <span style="color:var(--red)">+${(15+Math.random()*5).toFixed(1)} % ‚ö†</span>
FUEL TRIM LT .... <span style="color:var(--red)">+${(10+Math.random()*4).toFixed(1)} % ‚ö†</span>
SISTEMA ......... <span style="color:var(--white)">BUCLE CERRADO</span>
DIST DESDE DTC .. <span style="color:var(--white)">${Math.round(Math.random()*120)} km</span>`;
}

// ‚ïê‚ïê‚ïê BT CONNECT ‚ïê‚ïê‚ïê
function initBT(){
  document.getElementById('bt-btn').addEventListener('click',toggleBT);
  document.getElementById('obd-connect-btn')?.addEventListener('click',toggleBT);
}
async function toggleBT(){
  if(S.bt){
    stopOBD();S.bt=false;BLE.isReal=false;
    if(BLE.txChar)try{await BLE.txChar.stopNotifications();}catch(_){}
    if(BLE.device?.gatt?.connected)try{BLE.device.gatt.disconnect();}catch(_){}
    updateBTUI();toast('V-Link desconectado','info');return;
  }
  if(!('bluetooth' in navigator)){
    S.bt=true;BLE.isReal=false;updateBTUI();startOBD();toast('‚úì Modo simulaci√≥n OBD2','warn');return;
  }
  try{
    toast('üîç Buscando V-Link ELM327...','info');
    BLE.device=await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:'V-Link'},{namePrefix:'ELM'},{namePrefix:'OBDII'},{namePrefix:'Vlink'},{namePrefix:'IOS-Vlink'},{namePrefix:'OBD'}],
      optionalServices:BLE_PROFILES.map(p=>p.svc)
    });
    BLE.device.addEventListener('gattserverdisconnected',()=>{S.bt=false;BLE.isReal=false;stopOBD();updateBTUI();toast('‚ö† V-Link desconectado','err');});
    toast('üì° Conectando '+BLE.device.name+'...','info');
    BLE.server=await BLE.device.gatt.connect();
    let connected=false;
    for(const p of BLE_PROFILES){
      try{
        const svc=await BLE.server.getPrimaryService(p.svc);
        BLE.txChar=await svc.getCharacteristic(p.tx);
        BLE.rxChar=await svc.getCharacteristic(p.rx);
        await BLE.txChar.startNotifications();
        BLE.txChar.addEventListener('characteristicvaluechanged',bleOnData);
        BLE.profile=p;connected=true;dtcLog('‚úì Perfil BLE: '+p.name,'ok');break;
      }catch(_){}
    }
    if(!connected){S.bt=true;BLE.isReal=false;updateBTUI();startOBD();toast('‚ö† Perfil desconocido ‚Äî simulaci√≥n','warn');return;}
    await elmInit();BLE.isReal=true;S.bt=true;updateBTUI();
    toast('‚úÖ V-Link listo ‚Äî leyendo datos REALES','ok',4000);
    await readRealDTC();startOBD();
  }catch(e){
    if(e.name==='NotFoundError'||e.name==='SecurityError'){toast('Conexi√≥n cancelada','info');return;}
    S.bt=true;BLE.isReal=false;updateBTUI();startOBD();toast('Sin BT ‚Äî Modo simulaci√≥n activo','warn');
  }
}
function updateBTUI(){
  const btn=document.getElementById('bt-btn'),txt=document.getElementById('bt-txt'),dot=document.getElementById('bt-dot');
  const hs=document.getElementById('h-bt-st'),obc=document.getElementById('obd-connect-btn');
  if(S.bt){
    btn.className='hpill on';txt.textContent=BLE.isReal?'V-LINK':'DEMO';if(dot)dot.style.display='inline-block';
    if(hs){hs.textContent=BLE.isReal?'V-LINK REAL':'SIMULACI√ìN';hs.style.color=BLE.isReal?'var(--green)':'var(--gold)';}
    if(obc)obc.textContent='‚èπ DESCONECTAR';
  }else{
    btn.className='hpill';txt.textContent='ELM327';if(dot)dot.style.display='none';
    if(hs){hs.textContent='DESCONECTADO';hs.style.color='var(--gray)';}
    if(obc)obc.textContent='‚ö° CONECTAR V-LINK';
  }
}

// ‚ïê‚ïê‚ïê DB MODAL ‚ïê‚ïê‚ïê
function initDB(){
  document.getElementById('db-open-btn').addEventListener('click',()=>document.getElementById('db-modal').classList.add('open'));
  document.getElementById('db-close-btn')?.addEventListener('click',()=>document.getElementById('db-modal').classList.remove('open'));
  document.getElementById('db-modal')?.addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
  document.getElementById('gh-load-btn')?.addEventListener('click',()=>loadGitHubDB(true));
  document.getElementById('gh-status-btn')?.addEventListener('click',()=>toast(S.masterDB?'‚úì GitHub DB activa: '+countRec(S.masterDB)+' reg.':'Sin conexi√≥n GitHub','info'));
  document.getElementById('db-connect-btn')?.addEventListener('click',async()=>{
    const url=document.getElementById('db-url')?.value;
    if(!url){toast('Ingresa URL del endpoint','err');return;}
    S.db.connected=true;S.db.url=url;addSyncLog('‚úì Custom DB conectada','ok');updateDBUI();
    toast('‚úì Base de datos conectada','ok');document.getElementById('db-modal').classList.remove('open');
  });
  document.getElementById('db-pull-btn')?.addEventListener('click',()=>syncDB('pull'));
  document.getElementById('db-push-btn')?.addEventListener('click',()=>syncDB('push'));
  document.getElementById('custom-api-hdr')?.addEventListener('click',function(){this.classList.toggle('open');});
}
async function syncDB(dir){
  if(!S.db.connected&&!S.masterDB){toast('Conecta una DB primero','err');return;}
  addSyncLog((dir==='pull'?'‚¨á PULL':'‚¨Ü PUSH')+' iniciando...','info');
  document.getElementById('db-ind').className='db-ind syncing';
  const mods=['vehicles','dtc_codes','diagrams','pinouts','modules','calibrations','reports'];
  for(const m of mods){addSyncLog((dir==='pull'?'‚¨á':'‚¨Ü')+' '+m+'...','info');await delay(200+Math.random()*150);addSyncLog('‚úì '+m+' OK','ok');}
  S.db.lastSync=new Date().toLocaleTimeString('es-MX');
  document.getElementById('db-ind').className='db-ind online';
  updateDBUI();toast(dir==='pull'?'‚¨á Datos descargados':'‚¨Ü Datos enviados','ok');
}
function updateDBUI(){
  const c=S.db.connected||!!S.masterDB;
  const ind=document.getElementById('db-ind');if(ind)ind.className='db-ind'+(c?' online':'');
  el('db-st-txt',S.masterDB?'GITHUB DB ACTIVA':c?'CONECTADA':'SIN CONFIGURAR');
  el('db-st-sub',S.masterDB?GH_RAW.slice(8,55)+'...':c?S.db.url?.slice(0,40)||'‚Äî':'Configura endpoint o GitHub JSON');
  el('db-st-time',S.db.lastSync?'Sync: '+S.db.lastSync:'‚Äî');
  const pill=document.getElementById('db-open-btn');if(pill)pill.className=c?'hpill db-on':'hpill';
  el('db-pill-lbl',c?'‚óè DB':'DB');
  el('h-db-st',S.masterDB?'GITHUB ACTIVA':c?'CONECTADA':'SIN CONECTAR');
  el('h-db-count',S.masterDB?S.vehicles.length+' veh√≠culos':'‚Äî');
}
function addSyncLog(msg,type='info'){
  const log=document.getElementById('sync-log');if(!log)return;
  const e=document.createElement('span');e.className='ll '+type;
  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  e.textContent='['+t+'] '+msg;log.appendChild(e);log.scrollTop=log.scrollHeight;
}

// ‚ïê‚ïê‚ïê HP TUNERS MAPS ‚ïê‚ïê‚ïê
function renderHPMap(){
  const sel=document.getElementById('hp-table-sel');
  const mapKey=sel?sel.value:'VE';
  const MAPS={
    VE:{rows:[600,800,1200,1600,2000,2400,2800,3200,4000,4800],cols:[20,30,40,50,60,70,80,90,100,110]},
    SPARK:{rows:[600,800,1200,1600,2000,2400,2800,3200],cols:[20,30,40,50,60,70,80,90,100,110]},
    AFR:{rows:[600,800,1200,1600,2000,2400,2800],cols:[10,20,30,40,50,60,70,80,90,100]},
    BOOST:{rows:[2000,2500,3000,3500,4000,4500,5000],cols:[10,20,30,40,50,60,70,80,90,100]},
    INJ_PW:{rows:[600,800,1200,1600,2000,2400,2800],cols:[20,30,40,50,60,70,80,90]},
    IDLE_RPM:{rows:[0,20,40,60,80,100],cols:[0]},
  };
  const map=MAPS[mapKey]||MAPS.VE;
  const grid=document.getElementById('hp-map-grid');if(!grid)return;
  const {rows,cols}=map;
  const CW=Math.floor(272/cols.length);
  const generators={
    VE:(r,c)=>Math.round(55+Math.sin(r*.3)*15+Math.cos(c*.4)*12+Math.random()*5),
    SPARK:(r,c)=>Math.round(8+Math.sin(r*.2)*6+Math.cos(c*.3)*8),
    AFR:(r,c)=>parseFloat((14.7-Math.cos(r*.1)*.8-Math.sin(c*.2)*.6).toFixed(1)),
    BOOST:(r,c)=>Math.round(Math.sin(r*.3)*8+Math.sin(c*.2)*6),
    INJ_PW:(r,c)=>parseFloat((2+Math.sin(r*.2)*2+Math.sin(c*.15)*1.5).toFixed(2)),
    IDLE_RPM:(r,c)=>Math.round(1500-r*5+Math.random()*20),
  };
  const gen=generators[mapKey]||generators.VE;
  let html=`<div style="display:grid;grid-template-columns:28px ${cols.map(()=>CW+'px').join(' ')};gap:2px">`;
  html+='<div class="map-axis"></div>';
  cols.forEach(c=>{html+=`<div class="map-axis" style="font-size:7px">${c}</div>`;});
  rows.forEach((r,ri)=>{
    html+=`<div class="map-axis" style="font-size:7px">${r}</div>`;
    cols.forEach((c,ci)=>{
      const v=gen(ri,ci);const pct=Math.min(Math.max((v-30)/(80-30)*100,0),100);
      const bg=pct<25?'#1E3A5F':pct<50?'#1E5C3C':pct<75?'#8B5E00':'#8B1A1A';
      const tc=pct<50?'#7BB3E0':'#FFD080';
      html+=`<div class="map-cell" style="background:${bg};color:${tc};width:${CW}px;font-size:7.5px">${v}</div>`;
    });
  });
  html+='</div>';
  grid.innerHTML=html;
  el('hp-map-title',`${mapKey} ¬∑ ${rows.length}√ó${cols.length} ¬∑ ${BLE.isReal?'REAL':'DEMO'}`);
}

// ‚ïê‚ïê‚ïê IMMO UI ‚ïê‚ïê‚ïê
const IMMO_DATA={
  NATS:{sys:'NATS Nissan',slots:4,steps:['Conectar m√≥dulo ICU v√≠a CONSULT','Insertar llave programada y encender','Insertar llave nueva en 5 segundos','Esperar parpadeo luz IMMO','Apagar y probar arranque']},
  PATS:{sys:'PATS Ford',slots:8,steps:['Conectar m√≥dulo PATS / IDS Ford','Insertar llave programada activa','Ciclo encendido 3 veces OFF‚ÜíON','Insertar llave nueva en 8s','Arrancar motor para confirmar']},
  IMMO3:{sys:'Immo3 VW/Audi',slots:4,steps:['Leer PIN via OBD (VAGCOM) o EEPROM','Ingresar SKC en scanner adaptaciones','Borrar registro de llaves previo','Programar llave nueva con SKC','Verificar arrancando motor']},
  IMMO4:{sys:'Immo4 VW',slots:4,steps:['Calcular SKC via BCM adaptaciones','Usar GFF / ODIS modo coding','Codificar nueva llave con SKC','Sincronizar con ECM v√≠a CAN','Test de arranque completo']},
  SKS:{sys:'SKS Toyota',slots:5,steps:['Modo programaci√≥n Toyota Techstream','Ciclo con llave maestra 2 veces','Insertar llave nueva en 5s','Confirmar en dashboard','Probar todas las puertas']},
  BCM:{sys:'BCM Chevrolet',slots:10,steps:['Conectar TIS2000 o MDI GM','Program ‚Üí Key Fob Learning Mode','Ingresar PIN de propietario (4 dig)','Seguir pasos en pantalla','Confirmar VIN y cantidad de llaves']},
  HONDA:{sys:'Honda IMMO',slots:3,steps:['Conectar HDS Honda','ECU ‚Üí IMMO ‚Üí Key Registration','Ingresar c√≥digo de seguridad ECU','Registrar llave transponder','Ciclo ignici√≥n completo']},
  MAZDA:{sys:'Mazda IMMO',slots:4,steps:['MAZDA IDS ‚Üí Security','PCM Programming ‚Üí IMMO Transfer','Transferir datos IMMO al PCM nuevo','Programar llave transponder','Test final de arranque']},
  NATS5:{sys:'NATS5 Nissan',slots:4,steps:['Conectar Consult III Plus','BCM ‚Üí IMMO ‚Üí Work Support','Read IMMO ID from BCM','Program Key Slot libre','Confirmar sync BCM‚ÜîECM']},
  PATS5:{sys:'PATS5 Ford',slots:8,steps:['Conectar IDS Ford','M√≥dulo PATS ‚Üí Key Programming','Llave activa en ignici√≥n 10s','Insertar llave nueva en 5s','Confirmar y test arranque']},
};
function initImmoUI(){updateImmoUI();}
function updateImmoUI(){
  const brand=document.getElementById('immo-brand')?.value||'NATS';
  const data=IMMO_DATA[brand]||IMMO_DATA.NATS;
  el('immo-sys-lbl',brand);el('immo-keys-count','2/'+data.slots);
  const info=document.getElementById('immo-info');
  if(info)info.innerHTML=`<strong style="color:var(--white)">${data.sys}</strong><br>‚Ä¢ Slots disponibles: hasta ${data.slots} llaves<br>‚Ä¢ Requiere transponder compatible<br>‚Ä¢ PIN/SKC necesario en algunos sistemas`;
  renderSteps('immo-steps',data.steps.map((t,i)=>({n:i+1,t,d:''})),'var(--immo)');
}
async function progKey(slot){
  const card=document.getElementById('immo-prog-card');
  if(card)card.style.display='block';
  const ring=document.getElementById('immo-ring'),pct=document.getElementById('immo-pct'),msg=document.getElementById('immo-msg');
  const msgs=['Conectando IMMO...','Verificando PIN/SKC...','Leyendo transponder...','Autenticando...','Programando ID...','Sincronizando...','‚úÖ Llave programada'];
  for(let i=0;i<msgs.length;i++){
    const p=Math.round((i+1)/msgs.length*100);
    if(ring)ring.style.strokeDashoffset=314-(314*p/100);
    el('immo-pct',p+'%');if(msg)msg.textContent=msgs[i];
    await delay(700+Math.random()*400);
  }
  const kSlot=document.querySelector(`.key-slot[data-slot="${slot}"]`);
  if(kSlot){kSlot.className='key-slot prog';kSlot.querySelector('.key-slot-ico').textContent='üóù';kSlot.querySelector('.key-slot-st').textContent='PROGRAMADA';}
  if(card)card.style.display='none';
  toast(`‚úÖ Llave ${slot} programada correctamente`,'ok',4000);
}
window.progKey=progKey;

// ‚ïê‚ïê‚ïê CALIBRATION ‚ïê‚ïê‚ïê
function updateCalTPS(val){
  const v=(0.5+val/100*4.3).toFixed(2);
  const pct=Math.round(val);
  let estado=pct<5?'CERRADO':pct>95?'WOT':pct<30?'PARCIAL':pct<60?'CRUCERO':'ACELERACI√ìN';
  el('cal-tps-display',`${v} V ‚Äî ${estado}`);el('cal-tps-val',`${v} V`);
  push(S.charts.tps,pct);drawChart('chart-cal-tps',[{data:S.charts.tps,color:'#F5A623'}],0,100);
}
window.updateCalTPS=updateCalTPS;

function renderCylBalance(n){
  const wrap=document.getElementById('cyl-balance');if(!wrap)return;wrap.innerHTML='';
  for(let i=1;i<=n;i++){
    const v=(2.2+Math.sin(i*.7)*.4).toFixed(2);const ok=parseFloat(v)>=1.5&&parseFloat(v)<=3.5;
    wrap.innerHTML+=`<div style="background:var(--field);border:1px solid ${ok?'rgba(0,196,140,.25)':'rgba(255,75,92,.25)'};border-radius:8px;padding:9px;text-align:center">
      <div style="font-family:'Share Tech Mono',monospace;font-size:14px;color:${ok?'var(--green)':'var(--red)'}">${v} ms</div>
      <div style="font-size:8px;color:var(--lgray);margin-top:2px">CIL ${i}</div></div>`;
  }
}
function renderDieselCyls(n){
  const wrap=document.getElementById('diesel-cyl-wrap');if(!wrap)return;wrap.innerHTML='';
  for(let i=1;i<=n;i++){
    const ima=(Math.random()*4-2).toFixed(1);const ok=Math.abs(parseFloat(ima))<=2;
    wrap.innerHTML+=`<div style="background:var(--field);border:1px solid ${ok?'rgba(255,107,43,.2)':'rgba(255,75,92,.35)'};border-radius:8px;padding:9px;text-align:center">
      <div style="font-family:'Share Tech Mono',monospace;font-size:14px;color:${ok?'var(--diesel)':'var(--red)'}">
        ${ima>0?'+':''}${ima} mg</div>
      <div style="font-size:8px;color:var(--lgray);margin-top:2px">INY ${i}</div>
      <div style="font-size:7px;color:${ok?'var(--green)':'var(--red)'}">IMA ${ok?'OK':'FALLA'}</div></div>`;
  }
}

// ‚ïê‚ïê‚ïê STEPS ‚ïê‚ïê‚ïê
function renderSteps(id,steps,color='var(--blue)'){
  const wrap=document.getElementById(id);if(!wrap)return;
  wrap.innerHTML=steps.map(s=>`
    <div class="step-item">
      <div class="step-num">${s.n}</div>
      <div class="step-content"><div class="step-title" style="color:${color}">${s.t}</div>
        ${s.d?`<div class="step-desc">${s.d}</div>`:''}
      </div></div>`).join('');
}

function renderStepsById(){
  renderSteps('idle-steps',[
    {n:1,t:'Motor a temperatura',d:'ECT debe mostrar 80‚Äì95¬∞C en scanner.'},
    {n:2,t:'Cargas apagadas',d:'A/C, luces, radio y todos los accesorios OFF.'},
    {n:3,t:'Verificar RPM base',d:'Objetivo: 750‚Äì850 RPM en caliente.'},
    {n:4,t:'Limpiar v√°lvula IAC',d:'Retirar IAC. Limpiar con spray throttle body.'},
    {n:5,t:'Ajustar o codificar',d:'Usar scanner ‚Üí Funciones especiales ‚Üí Ralent√≠.'},
  ],'var(--blue)');
  renderSteps('ecu-steps',[
    {n:1,t:'Documentar DTC',d:'Anotar todos los c√≥digos activos antes del reset.'},
    {n:2,t:'Reset adaptaciones',d:'Scanner ‚Üí Funciones especiales ‚Üí Inicializar ECU.'},
    {n:3,t:'Ciclo de aprendizaje',d:'Manejo 15‚Äì20 km: aceleraciones y desaceleraciones.'},
    {n:4,t:'Verificar resultado',d:'Fuel Trim ST/LT deben estar dentro de ¬±10%.'},
  ],'var(--red)');
  renderSteps('pump-steps',[
    {n:1,t:'Verificar presi√≥n riel',d:'Ralent√≠: 250‚Äì350 bar. Motor fr√≠o: 150‚Äì200 bar.'},
    {n:2,t:'Solenoide de caudal',d:'Se√±al PWM: 50‚Äì70% duty cycle normal.'},
    {n:3,t:'Test de fugas',d:'Motor apagado: presi√≥n no cae >50 bar en 5s.'},
    {n:4,t:'Calibrar punto cero',d:'Scanner ‚Üí Diesel ‚Üí Calibraci√≥n bomba.'},
  ],'var(--diesel)');
  renderSteps('clone-steps',[
    {n:1,t:'Leer m√≥dulo original',d:'Conectar m√≥dulo original ‚Üí Leer ‚Üí Guardar .BIN.'},
    {n:2,t:'Verificar compatibilidad',d:'Confirmar n√∫mero de parte del m√≥dulo nuevo.'},
    {n:3,t:'Conectar m√≥dulo nuevo',d:'Reemplazar f√≠sicamente, reconectar todos los conectores.'},
    {n:4,t:'Escribir clon',d:'Escritura ‚Üí Seleccionar .BIN ‚Üí Escribir completo.'},
    {n:5,t:'Verificar y codificar',d:'Leer DTC. Codificar VIN si es necesario. Test arranque.'},
  ],'var(--purple)');
}

// ‚ïê‚ïê‚ïê PROGRESS SIMULATOR ‚ïê‚ïê‚ïê
async function simulateProgress(barId,logId,title,steps,color='var(--blue)'){
  const bar=document.getElementById(barId),log=document.getElementById(logId);
  if(log)log.innerHTML='';
  const msgs=['Conectando interfaz...','Verificando protocolo...','Comunicaci√≥n establecida...'];
  for(let i=0;i<steps;i++){
    const p=Math.round((i+1)/steps*100);
    if(bar)bar.style.width=p+'%';
    const msg=msgs[i]||`${title}... ${p}%`;
    if(log){const l=document.createElement('div');l.style.cssText=`font-size:8.5px;line-height:1.9;color:${color}`;l.textContent='‚Üí '+msg;log.appendChild(l);log.scrollTop=log.scrollHeight;}
    await delay(600+Math.random()*400);
  }
  if(log){const l=document.createElement('div');l.style.cssText='font-size:8.5px;line-height:1.9;color:var(--green)';l.textContent='‚úÖ '+title+' ‚Äî COMPLETO';log.appendChild(l);}
  toast('‚úÖ '+title+' completado','ok');
}

// ‚ïê‚ïê‚ïê DIAGRAMAS ‚ïê‚ïê‚ïê
function initDiags(){
  document.getElementById('diag-search')?.addEventListener('input',filterDiags);
  document.getElementById('diag-type-filter')?.addEventListener('click',e=>{
    const c=e.target.closest('.vf-chip');if(!c)return;
    document.querySelectorAll('#diag-type-filter .vf-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');S.diagFilter=c.dataset.dtype;filterDiags();
  });
  filterDiags();
}
function filterDiags(){
  const q=(document.getElementById('diag-search')?.value||'').toLowerCase();
  const type=S.diagFilter||'ALL';
  const filtered=ENC_DATA.filter(d=>{
    const m=!q||`${d.brand} ${d.model} ${d.title} ${d.content||''}`.toLowerCase().includes(q);
    const t=type==='ALL'||d.type===type;
    return m&&t;
  });
  const list=document.getElementById('diag-list');if(!list)return;
  list.innerHTML='';
  document.getElementById('diag-detail')?.style&&(document.getElementById('diag-detail').style.display='none');
  filtered.forEach(d=>{
    const typeColors={diagrama:'var(--cyan)',pinout:'var(--blue)',dtc:'var(--red)',tabla:'var(--gold)',diesel:'var(--diesel)'};
    const color=typeColors[d.type]||'var(--lgray)';
    const item=document.createElement('div');item.className='diag-card';
    item.innerHTML=`<div class="diag-title">${d.title}</div>
      <div class="diag-meta">
        <span>üöó ${d.brand} ${d.model}</span>
        <span style="color:${color}">‚óè ${d.type?.toUpperCase()}</span>
      </div>`;
    item.addEventListener('click',()=>showDiagDetail(d));
    list.appendChild(item);
  });
}
window.filterDiags=filterDiags;

function showDiagDetail(d){
  const detail=document.getElementById('diag-detail');if(!detail)return;
  detail.style.display='block';
  el('diag-detail-title',d.title);
  const body=document.getElementById('diag-detail-body');if(!body)return;
  if(d.pins){
    body.innerHTML=`<table class="pin-table" style="width:100%">
      <tr><th>#</th><th>COLOR</th><th>DESCRIPCI√ìN</th></tr>
      ${d.pins.map(p=>`<tr><td style="color:var(--cyan)">${p.n}</td><td style="color:var(--lgray)">${p.color}</td><td>${p.desc}</td></tr>`).join('')}
    </table>`;
  }else{
    body.innerHTML=`<div style="font-size:9.5px;color:var(--lgray);line-height:2;white-space:pre-line">${d.content||''}</div>`;
  }
  detail.scrollIntoView({behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê REPORT ‚ïê‚ïê‚ïê
function fillReportFromOBD(){
  if(!S.vehicle)return;
  elVal('r-brand',S.vehicle.brand||'');elVal('r-model',S.vehicle.model||'');
  elVal('r-year',S.vehicle.year||'');elVal('r-engine',S.vehicle.engine||'');
  const dtcArea=document.getElementById('dtc-chips-wrap');
  const codes=[...document.querySelectorAll('#dtc-chips-wrap [style]')].map(c=>c.querySelector('[style*="Share Tech"]')?.textContent).filter(Boolean).join(', ');
  if(codes)elVal('r-obs',`DTC detectados: ${codes}. Motor en ralent√≠: ${S.charts.rpm.at(-1)?.toFixed(0)||'‚Äî'} RPM, Temp: ${S.charts.temp.at(-1)?.toFixed(0)||'‚Äî'}¬∞C`);
}
function saveReport(){
  const data={
    brand:document.getElementById('r-brand')?.value,model:document.getElementById('r-model')?.value,
    year:document.getElementById('r-year')?.value,plates:document.getElementById('r-plates')?.value,
    client:document.getElementById('r-client')?.value,ts:new Date().toISOString()
  };
  const reports=JSON.parse(localStorage.getItem('pp_reports')||'[]');
  reports.unshift(data);localStorage.setItem('pp_reports',JSON.stringify(reports.slice(0,100)));
  el('k-total',reports.length);toast('üíæ Reporte guardado en DB local','ok');
}
function generatePDF(){
  toast('üìÑ Generando reporte PDF...','info');
  setTimeout(()=>{
    const veh=`${document.getElementById('r-brand')?.value||'‚Äî'} ${document.getElementById('r-model')?.value||'‚Äî'} ${document.getElementById('r-year')?.value||''}`.trim();
    const client=document.getElementById('r-client')?.value||'Cliente';
    const complaint=document.getElementById('r-complaint')?.value||'Sin s√≠ntoma';
    const obs=document.getElementById('r-obs')?.value||'Sin observaci√≥n';
    const work=document.getElementById('r-work')?.value||'Sin trabajo';
    const total=document.getElementById('r-total')?.value||'0.00';
    const now=new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'long',year:'numeric'});
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
    body{font-family:Arial,sans-serif;color:#222;padding:30px;max-width:800px;margin:0 auto}
    h1{color:#1E3A6E;border-bottom:3px solid #1E8CE0;padding-bottom:8px;font-size:18px}
    h2{color:#1E8CE0;font-size:13px;margin:16px 0 6px;letter-spacing:1px}
    table{width:100%;border-collapse:collapse;margin-bottom:14px}
    td,th{padding:7px 10px;border:1px solid #ddd;font-size:12px}
    th{background:#f0f6ff;color:#1E3A6E;font-weight:bold}
    .total{font-size:16px;font-weight:bold;color:#1E3A6E;text-align:right}
    .footer{margin-top:40px;border-top:1px solid #ddd;padding-top:10px;font-size:10px;color:#888;text-align:center}
    </style></head><body>
    <h1>PROPART PRO V6 ¬∑ DIAGN√ìSTICO AUTOMOTRIZ</h1>
    <p><strong>Taller:</strong> FERNANDO MILL√ÅN ¬∑ 777 683 8196 &nbsp;&nbsp; <strong>Fecha:</strong> ${now}</p>
    <h2>DATOS DEL VEH√çCULO</h2>
    <table><tr><th>Veh√≠culo</th><td>${veh}</td><th>Placas</th><td>${document.getElementById('r-plates')?.value||'‚Äî'}</td></tr>
    <tr><th>Motor</th><td>${document.getElementById('r-engine')?.value||'‚Äî'}</td><th>VIN</th><td>${document.getElementById('r-vin')?.value||'‚Äî'}</td></tr>
    <tr><th>KM</th><td>${document.getElementById('r-km')?.value||'‚Äî'}</td><th>Color</th><td>${document.getElementById('r-color')?.value||'‚Äî'}</td></tr></table>
    <h2>CLIENTE</h2>
    <table><tr><th>Nombre</th><td>${client}</td><th>Tel√©fono</th><td>${document.getElementById('r-phone')?.value||'‚Äî'}</td></tr></table>
    <h2>DIAGN√ìSTICO</h2>
    <table><tr><th>S√çNTOMA</th><td>${complaint}</td></tr><tr><th>OBSERVACI√ìN</th><td>${obs}</td></tr><tr><th>TRABAJO REALIZADO</th><td>${work}</td></tr></table>
    <h2>COSTOS</h2>
    <table><tr><th>Mano de obra</th><td>$${document.getElementById('r-labor')?.value||'0.00'}</td><th>TOTAL</th><td class="total">$${total}</td></tr></table>
    <p><strong>Garant√≠a:</strong> ${document.getElementById('r-warranty')?.value||'Sin garant√≠a'} &nbsp;&nbsp; <strong>Estatus:</strong> ${document.getElementById('r-status')?.value?.toUpperCase()||'EN PROCESO'}</p>
    <div class="footer">PROPART PRO V6 ¬∑ Sistema de Diagn√≥stico Automotriz ¬∑ generado ${now}</div>
    </body></html>`;
    const w=window.open('','_blank');if(w){w.document.write(html);w.document.close();setTimeout(()=>w.print(),400);}
    toast('üìÑ PDF generado ‚Äî imprime o guarda','ok');
  },1200);
}
</script>
</body>
</html>
